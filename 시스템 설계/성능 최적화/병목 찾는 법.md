## 핵심 원칙

**"측정 없이 최적화하지 마라"**

느리다고 느끼는 곳과 실제 병목은 다를 수 있음

---

## 병목 발생 위치

```
브라우저 → 네트워크 → 백엔드 → DB → 스토리지
```

어디가 느린지 먼저 파악해야 함

---

## 레이어별 측정 방법

### 1. 프론트엔드 - Chrome DevTools

**Network 탭**

```
Timing 분석:
- Waiting (TTFB): 서버 응답 대기 → 백엔드 문제
- Content Download: 다운로드 → 네트워크/페이로드 문제
- Stalled: 연결 대기 → 동시 요청 제한
```

**Performance 탭**

- 렌더링 병목 확인
- JavaScript 실행 시간
- Layout Shift

**Lighthouse**

- 전체적인 성능 점수
- 개선 권장 사항

---

### 2. 네트워크 - 지연 시간 측정

**ping / traceroute**

```bash
# 기본 지연 시간
ping api.example.com

# 경로 추적
traceroute api.example.com
```

**curl 상세 시간**

```bash
curl -w "\
   DNS Lookup:  %{time_namelookup}s\n\
   TCP Connect: %{time_connect}s\n\
   TLS Handshake: %{time_appconnect}s\n\
   TTFB:        %{time_starttransfer}s\n\
   Total:       %{time_total}s\n" \
   -o /dev/null -s https://api.example.com
```

**결과 해석**

|항목|느리면|원인|
|---|---|---|
|DNS Lookup|> 100ms|DNS 서버 문제|
|TCP Connect|> 100ms|서버 거리, 네트워크|
|TLS Handshake|> 200ms|SSL 설정, 서버 거리|
|TTFB|> 500ms|백엔드 처리 느림|

---

### 3. 백엔드 - APM 도구

**주요 APM 도구**

| 도구                   | 특징          |
| -------------------- | ----------- |
| Datadog              | 올인원, 비쌈     |
| New Relic            | 상세한 트레이싱    |
| Sentry               | 에러 + 성능     |
| Prometheus + Grafana | 오픈소스, 직접 구축 |

**측정 항목**

- 엔드포인트별 응답 시간
- 느린 트랜잭션 Top 10
- 외부 API 호출 시간
- DB 쿼리 시간

**직접 로깅 (간단한 방법)**

```javascript
// Express 미들웨어 예시
app.use((req, res, next) => {
  const start = Date.now();
  res.on('finish', () => {
    const duration = Date.now() - start;
    console.log(`${req.method} ${req.path} - ${duration}ms`);
  });
  next();
});
```

---

### 4. 데이터베이스 - 쿼리 분석

**느린 쿼리 로그 활성화**

```sql
-- MySQL
SET GLOBAL slow_query_log = 'ON';
SET GLOBAL long_query_time = 1;  -- 1초 이상

-- PostgreSQL (postgresql.conf)
log_min_duration_statement = 1000  -- 1초 이상
```

**EXPLAIN으로 실행 계획 분석**

```sql
EXPLAIN ANALYZE SELECT * FROM users WHERE email = 'test@example.com';
```

**확인 포인트**

|항목|문제 신호|
|---|---|
|type|ALL (풀 스캔)|
|rows|예상보다 많은 행|
|Extra|Using filesort, Using temporary|
|key|NULL (인덱스 미사용)|

**분산 트레이싱 도구 (MSA 환경)**

여러 서비스에 걸친 요청 추적

| 도구 | 특징 |
|------|------|
| Jaeger | CNCF 표준, 오픈소스 |
| Zipkin | 가벼움, Twitter 개발 |
| Datadog APM | 상용, 통합 모니터링 |
| AWS X-Ray | AWS 환경 통합 |

**인덱스 확인**

```sql
-- 테이블 인덱스 확인
SHOW INDEX FROM users;

-- 인덱스 사용 여부
EXPLAIN SELECT * FROM users WHERE email = 'test@example.com';
-- key 컬럼에 인덱스 이름이 나오면 사용 중
```

---

### 5. 스토리지 - I/O 모니터링

**Linux 명령어**

```bash
# 디스크 I/O 확인
iostat -x 1

# 프로세스별 I/O
iotop
```

**확인 포인트**

|항목|문제 신호|
|---|---|
|%util|> 80% (디스크 포화)|
|await|> 10ms (I/O 대기)|
|r/s, w/s|비정상적으로 높음|

---

## 병목 찾기 플로우

```
1. 전체 응답 시간 측정 (curl, DevTools)
        ↓
   어디가 느린가?
        ↓
   ┌─────────────────────────────────────┐
   │                                     │
TTFB 느림                            다운로드 느림
   │                                     │
   ▼                                     ▼
백엔드 확인                          페이로드 크기 확인
   │                                  압축 적용
   ▼
APM으로 상세 분석
   │
   ├─ DB 쿼리 느림 → EXPLAIN
   ├─ 외부 API 느림 → 타임아웃, 캐싱
   └─ 비즈니스 로직 → 코드 최적화
```

---

## 실전 예시

### 예시 1: API 응답이 2초

```
1. curl로 측정
   → TTFB: 1.8초 (백엔드 문제)

2. APM 확인
   → DB 쿼리에서 1.5초 소요

3. EXPLAIN 실행
   → type: ALL (풀 스캔)

4. 해결
   → 인덱스 추가
   → 결과: 1.8초 → 50ms
```

### 예시 2: 페이지 로딩 느림

```
1. DevTools Network 탭
   → 이미지 파일 10MB

2. 해결
   → 이미지 압축
   → lazy loading 적용
   → CDN 배포
```

### 예시 3: 특정 시간대만 느림

```
1. APM 확인
   → 피크 시간에 CPU 100%

2. 원인
   → 동시 접속 증가

3. 해결
   → 오토 스케일링 설정
   → 캐싱 강화
```

---

## 핵심 요약

| 레이어   | 측정 도구                | 주요 지표            |
| ----- | -------------------- | ---------------- |
| 프론트엔드 | Chrome DevTools      | TTFB, 렌더링 시간     |
| 네트워크  | curl, ping           | DNS, TCP, TLS 시간 |
| 백엔드   | APM (Datadog,그라파나 등) | 응답 시간, 트레이싱      |
| DB    | EXPLAIN, slow log    | 쿼리 시간, 풀 스캔 여부   |
| 스토리지  | iostat, iotop        | I/O 사용률, 대기 시간   |

**순서: 전체 측정 -> 구간 분리 -> 상세 분석 -> 해결**