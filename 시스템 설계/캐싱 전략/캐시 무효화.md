## ìºì‹œ ë¬´íš¨í™”ë€?

ìºì‹œëœ ë°ì´í„°ê°€ ì›ë³¸ê³¼ ë‹¬ë¼ì¡Œì„ ë•Œ, ìºì‹œë¥¼ ê°±ì‹ í•˜ê±°ë‚˜ ì‚­ì œí•˜ëŠ” ê²ƒ

> "ì»´í“¨í„° ê³¼í•™ì—ì„œ ì–´ë ¤ìš´ ë‘ ê°€ì§€: ìºì‹œ ë¬´íš¨í™”, ë„¤ì´ë°" â€” Phil Karlton

---

## ì™œ ì–´ë ¤ìš´ê°€?

```
[ì›ë³¸ DB]  â”€â”€â”€â”€ ë°ì´í„° ë³€ê²½ â”€â”€â”€â”€â†’  ì–´ë–»ê²Œ ìºì‹œì— ì•Œë¦¬ì§€?
                                         â”‚
[ìºì‹œ]     â”€â”€â”€â”€ ì˜¤ë˜ëœ ë°ì´í„° â”€â”€â”€â”€â†’  ì–¸ì œê¹Œì§€ ë“¤ê³  ìˆì§€?
```

**ë¬¸ì œ ìƒí™©ë“¤**

- DBëŠ” ë°”ë€Œì—ˆëŠ”ë° ìºì‹œëŠ” ì˜›ë‚  ë°ì´í„°
- ìºì‹œ ê°±ì‹ í•˜ëŠ” ì‚¬ì´ì— ë˜ DBê°€ ë°”ë€œ
- ì—¬ëŸ¬ ì„œë²„ì˜ ìºì‹œê°€ ê°ê° ë‹¤ë¥¸ ë°ì´í„°

---

## ë¬´íš¨í™” ì „ëµ

### 1. TTL (Time To Live)

**ê°€ì¥ ê°„ë‹¨í•œ ë°©ë²•**: ì¼ì • ì‹œê°„ í›„ ìë™ ë§Œë£Œ

```typescript
// Redis ì˜ˆì‹œ
await redis.set('user:123', userData, 'EX', 3600);  // 1ì‹œê°„ í›„ ë§Œë£Œ
```

**ë™ì‘ ë°©ì‹**

```
1. ìºì‹œ ì €ì¥ (TTL 1ì‹œê°„)
2. 1ì‹œê°„ ë™ì•ˆ ìºì‹œ ì‚¬ìš©
3. ë§Œë£Œ í›„ ë‹¤ìŒ ìš”ì²­ì—ì„œ DB ì¡°íšŒ â†’ ìºì‹œ ê°±ì‹ 
```

|ì¥ì |ë‹¨ì |
|---|---|
|êµ¬í˜„ ê°„ë‹¨|TTL ë™ì•ˆ ë¶ˆì¼ì¹˜ ê°€ëŠ¥|
|ìë™ ì •ë¦¬|ì ì ˆí•œ TTL ì„¤ì • ì–´ë ¤ì›€|

**TTL ì„¤ì • ê¸°ì¤€**

|ë°ì´í„° ìœ í˜•|ê¶Œì¥ TTL|
|---|---|
|ê±°ì˜ ì•ˆ ë°”ë€œ (ì„¤ì •, ì½”ë“œ)|24ì‹œê°„ ì´ìƒ|
|ê°€ë” ë°”ë€œ (í”„ë¡œí•„, ìƒí’ˆ)|1~24ì‹œê°„|
|ìì£¼ ë°”ë€œ (ì¬ê³ , ì¢‹ì•„ìš”)|1~5ë¶„|
|ì‹¤ì‹œê°„ (ì£¼ì‹, ì±„íŒ…)|ìºì‹œ ì•ˆ í•¨|

---

### 2. Write-Through

**ì“°ê¸° ì‹œ ìºì‹œì™€ DB ë™ì‹œ ê°±ì‹ **

```typescript
async function updateUser(userId: string, data: UserData) {
  // 1. DB ì €ì¥
  await db.users.update(userId, data);
  
  // 2. ìºì‹œë„ ì¦‰ì‹œ ê°±ì‹ 
  await redis.set(`user:${userId}`, JSON.stringify(data));
}
```

**ë™ì‘ ë°©ì‹**

```
ì“°ê¸° ìš”ì²­
    â”‚
    â”œâ”€â”€â†’ DB ì €ì¥
    â”‚
    â””â”€â”€â†’ ìºì‹œ ê°±ì‹ 
    â”‚
   ì‘ë‹µ
```

| ì¥ì         | ë‹¨ì              |
| --------- | -------------- |
| í•­ìƒ ì¼ê´€ì„± ìœ ì§€ | ì“°ê¸° ëŠë¦¼ (ë‘ ë²ˆ ì €ì¥) |
| êµ¬í˜„ ì§ê´€ì     | ìºì‹œ ì¥ì•  ì‹œ ì“°ê¸° ì‹¤íŒ¨  |


---

### 3. Write-Invalidate (Cache-Aside)

**ì“°ê¸° ì‹œ ìºì‹œ ì‚­ì œ, ë‹¤ìŒ ì½ê¸°ì—ì„œ ê°±ì‹ **

```typescript
// ì“°ê¸°
async function updateUser(userId: string, data: UserData) {
  // 1. DB ì €ì¥
  await db.users.update(userId, data);
  
  // 2. ìºì‹œ ì‚­ì œ (ê°±ì‹  ì•„ë‹˜!)
  await redis.del(`user:${userId}`);
}

// ì½ê¸°
async function getUser(userId: string) {
  // 1. ìºì‹œ í™•ì¸
  const cached = await redis.get(`user:${userId}`);
  if (cached) return JSON.parse(cached);
  
  // 2. ìºì‹œ ë¯¸ìŠ¤ â†’ DB ì¡°íšŒ
  const user = await db.users.findById(userId);
  
  // 3. ìºì‹œì— ì €ì¥
  await redis.set(`user:${userId}`, JSON.stringify(user), 'EX', 3600);
  
  return user;
}
```

**ë™ì‘ ë°©ì‹**

```
ì“°ê¸° ìš”ì²­ â†’ DB ì €ì¥ â†’ ìºì‹œ ì‚­ì œ â†’ ì‘ë‹µ

ë‹¤ìŒ ì½ê¸° ìš”ì²­ â†’ ìºì‹œ ë¯¸ìŠ¤ â†’ DB ì¡°íšŒ â†’ ìºì‹œ ì €ì¥ â†’ ì‘ë‹µ
```

|ì¥ì |ë‹¨ì |
|---|---|
|ì“°ê¸° ë¹ ë¦„|ì‚­ì œ ì§í›„ ì½ê¸° ì‹œ DB ë¶€í•˜|
|ë¶ˆí•„ìš”í•œ ìºì‹œ ê°±ì‹  ë°©ì§€|ìºì‹œ ìŠ¤íƒ¬í”¼ë“œ ìœ„í—˜|

**ê°€ì¥ ë§ì´ ì“°ì´ëŠ” íŒ¨í„´**

---

### 4. Write-Behind (Write-Back)

**ìºì‹œì— ë¨¼ì € ì“°ê³ , ë‚˜ì¤‘ì— DB ë°˜ì˜**

```typescript
// ì“°ê¸°: ìºì‹œì—ë§Œ ì €ì¥
async function updateUser(userId: string, data: UserData) {
  await redis.set(`user:${userId}`, JSON.stringify(data));
  
  // íì— ì¶”ê°€ (ë‚˜ì¤‘ì— DB ë°˜ì˜)
  await queue.add('sync-to-db', { userId, data });
}

// ë°±ê·¸ë¼ìš´ë“œ ì›Œì»¤
async function syncToDb(job) {
  const { userId, data } = job.data;
  await db.users.update(userId, data);
}
```

**ë™ì‘ ë°©ì‹**

```
ì“°ê¸° ìš”ì²­ â†’ ìºì‹œ ì €ì¥ â†’ ì‘ë‹µ (ë¹ ë¦„!)
                â”‚
                â””â†’ í â†’ ë°±ê·¸ë¼ìš´ë“œì—ì„œ DB ì €ì¥
```

|ì¥ì |ë‹¨ì |
|---|---|
|ì“°ê¸° ë§¤ìš° ë¹ ë¦„|ìºì‹œ ì¥ì•  ì‹œ ë°ì´í„° ìœ ì‹¤|
|DB ë¶€í•˜ ê°ì†Œ|êµ¬í˜„ ë³µì¡|

**ì‚¬ìš© ì˜ˆ**: ì¢‹ì•„ìš” ìˆ˜, ì¡°íšŒìˆ˜ (ìœ ì‹¤ë˜ì–´ë„ ì¹˜ëª…ì ì´ì§€ ì•Šì€ ë°ì´í„°)

---

### 5. ì´ë²¤íŠ¸ ê¸°ë°˜ ë¬´íš¨í™”

**DB ë³€ê²½ ì´ë²¤íŠ¸ë¥¼ ê°ì§€í•´ì„œ ìºì‹œ ê°±ì‹ **

```typescript
// DB ë³€ê²½ ì´ë²¤íŠ¸ ë°œí–‰
async function updateUser(userId: string, data: UserData) {
  await db.users.update(userId, data);
  
  // ì´ë²¤íŠ¸ ë°œí–‰
  await eventBus.publish('user.updated', { userId });
}

// ì´ë²¤íŠ¸ êµ¬ë… â†’ ìºì‹œ ë¬´íš¨í™”
eventBus.subscribe('user.updated', async (event) => {
  await redis.del(`user:${event.userId}`);
  
  // ì—°ê´€ ìºì‹œë„ ë¬´íš¨í™”
  await redis.del(`user-profile:${event.userId}`);
  await redis.del(`user-posts:${event.userId}`);
});
```

**CDC (Change Data Capture) í™œìš©**

```
[DB] â†’ [Debezium] â†’ [Kafka] â†’ [ìºì‹œ ë¬´íš¨í™” ì„œë¹„ìŠ¤]
```

|ì¥ì |ë‹¨ì |
|---|---|
|ì—°ê´€ ìºì‹œ ì¼ê´„ ë¬´íš¨í™”|ì¸í”„ë¼ ë³µì¡|
|ì„œë¹„ìŠ¤ ê°„ ê²°í•©ë„ ë‚®ìŒ|ì´ë²¤íŠ¸ ìœ ì‹¤ ê°€ëŠ¥ì„±|

---

## ìºì‹œ ìŠ¤íƒ¬í”¼ë“œ (Cache Stampede)

### ë¬¸ì œ ìƒí™©

ìºì‹œ ë§Œë£Œ ì‹œ ë™ì‹œ ìš”ì²­ì´ ëª°ë ¤ DB í­ì£¼

```
ìºì‹œ ë§Œë£Œ
    â”‚
    â”œâ”€ ìš”ì²­1 â†’ ìºì‹œ ë¯¸ìŠ¤ â†’ DB ì¡°íšŒ
    â”œâ”€ ìš”ì²­2 â†’ ìºì‹œ ë¯¸ìŠ¤ â†’ DB ì¡°íšŒ
    â”œâ”€ ìš”ì²­3 â†’ ìºì‹œ ë¯¸ìŠ¤ â†’ DB ì¡°íšŒ
    â””â”€ ... (ìˆ˜ë°± ê°œ ë™ì‹œ ìš”ì²­)
    
    â†’ DB ê³¼ë¶€í•˜!
```

### í•´ê²° ë°©ë²•

**1. ë½ (Mutex)**

```typescript
async function getUser(userId: string) {
  const cached = await redis.get(`user:${userId}`);
  if (cached) return JSON.parse(cached);
  
  // ë½ íšë“ ì‹œë„
  const lockKey = `lock:user:${userId}`;
  const acquired = await redis.set(lockKey, '1', 'NX', 'EX', 5);
  
  if (acquired) {
    // ë½ íšë“ ì„±ê³µ â†’ DB ì¡°íšŒ
    const user = await db.users.findById(userId);
    await redis.set(`user:${userId}`, JSON.stringify(user), 'EX', 3600);
    await redis.del(lockKey);
    return user;
  } else {
    // ë½ íšë“ ì‹¤íŒ¨ â†’ ì ì‹œ ëŒ€ê¸° í›„ ì¬ì‹œë„
    await sleep(100);
    return getUser(userId);
  }
}
```

**2. ë°±ê·¸ë¼ìš´ë“œ ê°±ì‹ **

```typescript
async function getUser(userId: string) {
  const cached = await redis.get(`user:${userId}`);
  const ttl = await redis.ttl(`user:${userId}`);
  
  // TTLì´ ì–¼ë§ˆ ì•ˆ ë‚¨ìœ¼ë©´ ë°±ê·¸ë¼ìš´ë“œì—ì„œ ë¯¸ë¦¬ ê°±ì‹ 
  if (cached && ttl < 300) {  // 5ë¶„ ë¯¸ë§Œ
    refreshInBackground(userId);  // ë¹„ë™ê¸°, ê¸°ë‹¤ë¦¬ì§€ ì•ŠìŒ
  }
  
  if (cached) return JSON.parse(cached);
  
  // ìºì‹œ ë¯¸ìŠ¤
  const user = await db.users.findById(userId);
  await redis.set(`user:${userId}`, JSON.stringify(user), 'EX', 3600);
  return user;
}
```

**3. í™•ë¥ ì  ê°±ì‹  (Probabilistic Early Expiration)**

```typescript
// TTLì´ ê°€ê¹Œì›Œì§ˆìˆ˜ë¡ ê°±ì‹  í™•ë¥  ì¦ê°€
function shouldRefresh(ttl: number, maxTtl: number): boolean {
  const remaining = ttl / maxTtl;
  const probability = 1 - remaining;  // ë‚¨ì€ ì‹œê°„ ì ì„ìˆ˜ë¡ í™•ë¥  ë†’ìŒ
  return Math.random() < probability * 0.1;  // ìµœëŒ€ 10% í™•ë¥ 
}
```

---

## ì¼ê´€ì„± ë¬¸ì œì™€ í•´ê²°

### ë¬¸ì œ: DB ê°±ì‹  í›„ ìºì‹œ ì‚­ì œ ì‹¤íŒ¨

```
1. DB ì €ì¥ ì„±ê³µ
2. ìºì‹œ ì‚­ì œ ì‹¤íŒ¨ (ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜)
3. ìºì‹œì— ì˜¤ë˜ëœ ë°ì´í„° ë‚¨ìŒ
```

### í•´ê²° 1: ì¬ì‹œë„

```typescript
async function updateUser(userId: string, data: UserData) {
  await db.users.update(userId, data);
  
  // ì¬ì‹œë„ ë¡œì§
  for (let i = 0; i < 3; i++) {
    try {
      await redis.del(`user:${userId}`);
      break;
    } catch (e) {
      await sleep(100 * (i + 1));
    }
  }
}
```

### í•´ê²° 2: ì´ë²¤íŠ¸ + ì¬ì²˜ë¦¬ í

```typescript
async function updateUser(userId: string, data: UserData) {
  await db.users.update(userId, data);
  
  // ë¬´íš¨í™” ì´ë²¤íŠ¸ë¥¼ íì— ì €ì¥ (ì‹¤íŒ¨í•´ë„ ì¬ì²˜ë¦¬ë¨)
  await queue.add('invalidate-cache', { 
    key: `user:${userId}`,
    retries: 3 
  });
}
```

### í•´ê²° 3: ì§§ì€ TTL ë³‘í–‰

```typescript
// ìºì‹œ ì‚­ì œê°€ ì‹¤íŒ¨í•´ë„ TTLë¡œ ê²°êµ­ ë§Œë£Œë¨
await redis.set(`user:${userId}`, data, 'EX', 300);  // 5ë¶„ TTL
```

---

## ì „ëµ ì„ íƒ ê°€ì´ë“œ

|ìƒí™©|ì¶”ì²œ ì „ëµ|
|---|---|
|ì¼ê´€ì„± ì¤‘ìš” (ê²°ì œ, ì¬ê³ )|Write-Through ë˜ëŠ” ìºì‹œ ì•ˆ ì”€|
|ì½ê¸° ë§ê³  ì“°ê¸° ì ìŒ|Write-Invalidate (Cache-Aside)|
|ì“°ê¸° ë§ìŒ (ì¢‹ì•„ìš”, ì¡°íšŒìˆ˜)|Write-Behind|
|ì—°ê´€ ë°ì´í„° ë§ìŒ|ì´ë²¤íŠ¸ ê¸°ë°˜ ë¬´íš¨í™”|
|ê°„ë‹¨í•˜ê²Œ|TTLë§Œ ì„¤ì •|

---

## ë©´ì ‘ ë‹µë³€ ì˜ˆì‹œ

> **Q: ìºì‹œì™€ DB ë°ì´í„°ê°€ ë¶ˆì¼ì¹˜í•˜ë©´ ì–´ë–»ê²Œ ì²˜ë¦¬í•˜ë‚˜ìš”?**
> 
> A: ìƒí™©ì— ë”°ë¼ ë‹¤ë¥¸ ì „ëµì„ ì‚¬ìš©í•©ë‹ˆë‹¤.
> 
> ì¼ë°˜ì ìœ¼ë¡œëŠ” **Write-Invalidate íŒ¨í„´**ì„ ì‚¬ìš©í•´ì„œ ì“°ê¸° ì‹œ ìºì‹œë¥¼ ì‚­ì œí•˜ê³ , ë‹¤ìŒ ì½ê¸°ì—ì„œ DBë¥¼ ì¡°íšŒí•´ ìºì‹œë¥¼ ê°±ì‹ í•©ë‹ˆë‹¤.
> 
> ê²°ì œë‚˜ ì¬ê³ ì²˜ëŸ¼ **ì •í™•ë„ê°€ ì¤‘ìš”í•œ ë°ì´í„°**ëŠ” ìºì‹œë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šê±°ë‚˜ Write-Throughë¡œ í•­ìƒ ë™ê¸°í™”í•©ë‹ˆë‹¤.
> 
> ì¢‹ì•„ìš” ìˆ˜ì²˜ëŸ¼ **ì•½ê°„ì˜ ë¶ˆì¼ì¹˜ê°€ í—ˆìš©ë˜ëŠ” ë°ì´í„°**ëŠ” Write-Behindë¡œ ì„±ëŠ¥ì„ ìš°ì„ ì‹œí•©ë‹ˆë‹¤.
> 
> ì¶”ê°€ë¡œ ìºì‹œ ìŠ¤íƒ¬í”¼ë“œë¥¼ ë°©ì§€í•˜ê¸° ìœ„í•´ ë½ì´ë‚˜ ë°±ê·¸ë¼ìš´ë“œ ê°±ì‹ ì„ ì ìš©í•©ë‹ˆë‹¤.

---

## í•µì‹¬ ìš”ì•½

|ì „ëµ|ì“°ê¸° ì‹œ ë™ì‘|ì¼ê´€ì„±|ì„±ëŠ¥|
|---|---|---|---|
|TTL|ì•„ë¬´ê²ƒë„ ì•ˆ í•¨|ë‚®ìŒ|ì¢‹ìŒ|
|Write-Through|ìºì‹œ + DB ë™ì‹œ ê°±ì‹ |ë†’ìŒ|ë³´í†µ|
|Write-Invalidate|ìºì‹œ ì‚­ì œ|ì¤‘ê°„|ì¢‹ìŒ|
|Write-Behind|ìºì‹œë§Œ ê°±ì‹ , DBëŠ” ë‚˜ì¤‘ì—|ë‚®ìŒ|ë§¤ìš° ì¢‹ìŒ|
|ì´ë²¤íŠ¸ ê¸°ë°˜|ì´ë²¤íŠ¸ë¡œ ë¬´íš¨í™”|ì¤‘ê°„|ì¢‹ìŒ|

> ğŸ’¡ **ì •ë‹µì€ ì—†ë‹¤** â†’ ë°ì´í„° íŠ¹ì„±ì— ë”°ë¼ ì „ëµ ì„ íƒ