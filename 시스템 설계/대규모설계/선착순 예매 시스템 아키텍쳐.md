# 전체 시스템 구조

  

```

                                  ┌─────────────────────────────────────┐

                                  │      사용자 (10만+ 동시접속)          │

                                  │                                     │

                                  │  브라우저에서 JavaScript 실행         │

                                  │  - 대기열 폴링 (2초마다)              │

                                  │  - 좌석 선택 UI                      │

                                  └──────────────────┬──────────────────┘

                                                     │

                                                     ▼

┌─────────────────────────────────────────────────────────────────────────────────────────┐

│                                         CDN                                             │

│                                                                                         │

│   역할: 정적 리소스 캐싱                                                                  │

│   - HTML 페이지                                                                          │

│   - JavaScript (폴링 로직 포함)                                                           │

│   - CSS 스타일시트                                                                       │

│   - 이미지 (좌석 배치도, 공연 포스터)                                                      │

│                                                                                         │

│   효과: 원본 서버 요청 80% 이상 감소                                                       │

└────────────────────────────────────────────────┬────────────────────────────────────────┘

                                                 │

                                                 ▼

┌─────────────────────────────────────────────────────────────────────────────────────────┐

│                                L7 로드밸런서 (Nginx / HAProxy)                            │

│                                                                                         │

│   ┌──────────────────────┐   ┌──────────────────────┐   ┌──────────────────────┐        │

│   │    Rate Limiting     │   │     DDoS 방어        │   │    Health Check      │        │

│   │                      │   │                      │   │                      │        │

│   │  IP당 초당 100req    │   │  비정상 패턴 차단     │   │  죽은 서버 제외       │        │

│   │  초과 시 429 응답    │   │  Bot 트래픽 필터링    │   │  자동 failover       │        │

│   └──────────────────────┘   └──────────────────────┘   └──────────────────────┘        │

│                                                                                         │

│   라우팅 규칙:                                                                           │

│   - /api/queue/*   → 대기열 서버 그룹                                                    │

│   - /api/booking/* → 예매 서버 그룹                                                      │

│   - /api/payment/* → 결제 서버 그룹                                                      │

└────────────────────────────────────────────────┬────────────────────────────────────────┘

                                                 │

                 ┌───────────────────────────────┼───────────────────────────────┐

                 │                               │                               │

                 ▼                               ▼                               ▼

┌───────────────────────────────┐ ┌───────────────────────────────┐ ┌───────────────────────────────┐

│    대기열 API 서버 (x10)       │ │     예매 API 서버 (x10)        │ │     결제 API 서버 (x5)         │

│                               │ │                               │ │                               │

│ ┌───────────────────────────┐ │ │ ┌───────────────────────────┐ │ │ ┌───────────────────────────┐ │

│ │ POST /queue/enter         │ │ │ │ GET /seats                │ │ │ │ POST /payment/request     │ │

│ │ → Redis ZSet 등록          │ │ │ │ → 좌석 현황 조회           │ │ │ │ → PG사 결제 요청           │ │

│ └───────────────────────────┘ │ │ └───────────────────────────┘ │ │ └───────────────────────────┘ │

│                               │ │                               │ │                               │

│ ┌───────────────────────────┐ │ │ ┌───────────────────────────┐ │ │ ┌───────────────────────────┐ │

│ │ GET /queue/status         │ │ │ │ POST /seats/select        │ │ │ │ POST /payment/confirm     │ │

│ │ → 순번 확인 (폴링)         │ │ │ │ → Lua 스크립트 선점        │ │ │ │ → 결제 확정                │ │

│ └───────────────────────────┘ │ │ └───────────────────────────┘ │ │ └───────────────────────────┘ │

│                               │ │                               │ │                               │

│ ┌───────────────────────────┐ │ │ ┌───────────────────────────┐ │ │ ┌───────────────────────────┐ │

│ │ GET /queue/position       │ │ │ │ DELETE /seats/release     │ │ │ │ POST /payment/cancel      │ │

│ │ → 예상 대기시간 계산       │ │ │ │ → 좌석 선점 해제           │ │ │ │ → 결제 취소 + 좌석 해제    │ │

│ └───────────────────────────┘ │ │ └───────────────────────────┘ │ │ └───────────────────────────┘ │

│                               │ │                               │ │                               │

│ 처리량: 초당 5만 요청         │ │ 처리량: 초당 1만 요청          │ │ 처리량: 초당 1천 요청          │

└───────────────┬───────────────┘ └───────────────┬───────────────┘ └───────────────┬───────────────┘

                │                                 │                                 │

                └─────────────────────────────────┼─────────────────────────────────┘

                                                  │

                                                  ▼

┌─────────────────────────────────────────────────────────────────────────────────────────┐

│                                    Redis Cluster (6노드)                                 │

│                                                                                         │

│  ┌───────────────────────────────────────────────────────────────────────────────────┐  │

│  │                                  대기열 관리                                        │  │

│  │                                                                                   │  │

│  │   키: queue:{eventId}                                                             │  │

│  │   타입: Sorted Set                                                                │  │

│  │   구조: { userId: timestamp }                                                     │  │

│  │                                                                                   │  │

│  │   예시:                                                                           │  │

│  │   queue:event1 = {                                                               │  │

│  │       "user_1001": 1706234567.123,                                               │  │

│  │       "user_1002": 1706234567.456,                                               │  │

│  │       "user_1003": 1706234567.789,                                               │  │

│  │       ...                                                                        │  │

│  │   }                                                                              │  │

│  │                                                                                   │  │

│  │   명령어:                                                                          │  │

│  │   - ZADD queue:event1 {timestamp} {userId}   → 대기열 등록                         │  │

│  │   - ZRANK queue:event1 {userId}              → 순번 조회                           │  │

│  │   - ZRANGE queue:event1 0 999                → 상위 1000명 조회                    │  │

│  │   - ZREM queue:event1 {userId}               → 대기열에서 제거                      │  │

│  └───────────────────────────────────────────────────────────────────────────────────┘  │

│                                                                                         │

│  ┌───────────────────────────────────────────────────────────────────────────────────┐  │

│  │                                활성 사용자 관리                                      │  │

│  │                                                                                   │  │

│  │   키: active:{eventId}                                                            │  │

│  │   타입: Set                                                                       │  │

│  │   용도: 현재 예매 진행 중인 사용자 추적                                               │  │

│  │                                                                                   │  │

│  │   명령어:                                                                          │  │

│  │   - SADD active:event1 {userId}      → 활성 사용자 등록                            │  │

│  │   - SREM active:event1 {userId}      → 활성 사용자 제거                            │  │

│  │   - SCARD active:event1              → 활성 사용자 수 조회                          │  │

│  │   - SISMEMBER active:event1 {userId} → 활성 여부 확인                              │  │

│  └───────────────────────────────────────────────────────────────────────────────────┘  │

│                                                                                         │

│  ┌───────────────────────────────────────────────────────────────────────────────────┐  │

│  │                                 입장 토큰 관리                                      │  │

│  │                                                                                   │  │

│  │   키: entry:{userId}:{eventId}                                                    │  │

│  │   타입: String                                                                    │  │

│  │   TTL: 600초 (10분)                                                               │  │

│  │   값: UUID 토큰                                                                   │  │

│  │                                                                                   │  │

│  │   명령어:                                                                          │  │

│  │   - SET entry:user1:event1 {token} EX 600   → 토큰 발급                           │  │

│  │   - GET entry:user1:event1                  → 토큰 조회                           │  │

│  │   - DEL entry:user1:event1                  → 토큰 삭제                           │  │

│  └───────────────────────────────────────────────────────────────────────────────────┘  │

│                                                                                         │

│  ┌───────────────────────────────────────────────────────────────────────────────────┐  │

│  │                                  좌석 선점 관리                                     │  │

│  │                                                                                   │  │

│  │   키: seat:{eventId}:{seatId}                                                     │  │

│  │   타입: String                                                                    │  │

│  │   TTL: 600초 (10분) - 미결제 시 자동 해제                                           │  │

│  │   값: userId                                                                      │  │

│  │                                                                                   │  │

│  │   Lua 스크립트 (원자적 선점):                                                       │  │

│  │   ┌─────────────────────────────────────────────────────────────────────────────┐ │  │

│  │   │  local seat_key = KEYS[1]                                                   │ │  │

│  │   │  local user_id = ARGV[1]                                                    │ │  │

│  │   │  local ttl = tonumber(ARGV[2])                                              │ │  │

│  │   │                                                                             │ │  │

│  │   │  -- 이미 선점되었는지 확인                                                    │ │  │

│  │   │  local current_holder = redis.call('GET', seat_key)                         │ │  │

│  │   │  if current_holder then                                                     │ │  │

│  │   │      return current_holder  -- 실패: 선점자 반환                              │ │  │

│  │   │  end                                                                        │ │  │

│  │   │                                                                             │ │  │

│  │   │  -- 좌석 선점 (원자적)                                                        │ │  │

│  │   │  redis.call('SET', seat_key, user_id, 'EX', ttl)                            │ │  │

│  │   │  return 'OK'  -- 성공                                                        │ │  │

│  │   └─────────────────────────────────────────────────────────────────────────────┘ │  │

│  └───────────────────────────────────────────────────────────────────────────────────┘  │

│                                                                                         │

│  ┌───────────────────────────────────────────────────────────────────────────────────┐  │

│  │                                  확정 좌석 관리                                     │  │

│  │                                                                                   │  │

│  │   키: confirmed:{eventId}:{seatId}                                                │  │

│  │   타입: String                                                                    │  │

│  │   TTL: 없음 (영구 저장)                                                            │  │

│  │   값: userId                                                                      │  │

│  │                                                                                   │  │

│  │   결제 완료 후:                                                                    │  │

│  │   - DEL seat:event1:A-15                   → 임시 선점 삭제                        │  │

│  │   - SET confirmed:event1:A-15 {userId}    → 확정 등록                             │  │

│  └───────────────────────────────────────────────────────────────────────────────────┘  │

│                                                                                         │

│  ┌───────────────────────────────────────────────────────────────────────────────────┐  │

│  │                                  좌석 현황 캐시                                     │  │

│  │                                                                                   │  │

│  │   키: seats:{eventId}                                                             │  │

│  │   타입: Hash                                                                      │  │

│  │   용도: 좌석 배치도 조회 시 빠른 응답                                                 │  │

│  │                                                                                   │  │

│  │   예시:                                                                           │  │

│  │   seats:event1 = {                                                               │  │

│  │       "A-1": "available",                                                        │  │

│  │       "A-2": "holding:user1",                                                    │  │

│  │       "A-3": "confirmed:user2",                                                  │  │

│  │       ...                                                                        │  │

│  │   }                                                                              │  │

│  └───────────────────────────────────────────────────────────────────────────────────┘  │

└─────────────────────────────────────────────────────────────────────────────────────────┘

                                                  │

                                                  │

                  ┌───────────────────────────────┴───────────────────────────────┐

                  │                                                               │

                  ▼                                                               ▼

┌──────────────────────────────────────────────┐       ┌──────────────────────────────────────────────┐

│          스케줄러 (1초마다 실행)               │       │                   PG사 연동                   │

│                                              │       │                                              │

│   @Scheduled(fixedRate = 1000)               │       │   ┌──────────────────────────────────────┐   │

│   void processQueue() {                      │       │   │            KG이니시스                 │   │

│                                              │       │   │            NHN KCP                   │   │

│       // 1. 현재 활성 사용자 수 확인           │       │   │            토스페이먼츠               │   │

│       Long active = SCARD active:event1      │       │   └──────────────────────────────────────┘   │

│                                              │       │                                              │

│       // 2. 입장 가능 인원 계산               │       │   처리:                                       │

│       int canEnter = 1000 - active           │       │   - 결제 요청/승인                            │

│                                              │       │   - 결제 취소/환불                            │

│       // 3. 대기열에서 N명 조회               │       │   - 타임아웃 처리 (30초)                      │

│       Set<String> users =                    │       │                                              │

│           ZRANGE queue:event1 0 N-1          │       │   실패 시:                                    │

│                                              │       │   - 좌석 선점 해제                            │

│       // 4. 각 사용자 입장 처리               │       │   - 재시도 안내                              │

│       for (user : users) {                   │       │                                              │

│           ZREM queue:event1 user             │       └──────────────────────────────────────────────┘

│           SADD active:event1 user            │

│           SET entry:user:event1 {token}      │

│       }                                      │

│   }                                          │

│                                              │

└──────────────────────────────────────────────┘

                                                  │

                                                  ▼

┌─────────────────────────────────────────────────────────────────────────────────────────┐

│                                      Kafka Cluster                                       │

│                                                                                         │

│  ┌───────────────────────────────────────────────────────────────────────────────────┐  │

│  │                              booking-completed 토픽                                │  │

│  │                                                                                   │  │

│  │   파티션 수: 10                                                                    │  │

│  │   복제 팩터: 3                                                                     │  │

│  │   보존 기간: 7일                                                                   │  │

│  │                                                                                   │  │

│  │   메시지 구조:                                                                     │  │

│  │   {                                                                              │  │

│  │       "bookingId": "B-20240125-001234",                                          │  │

│  │       "userId": 1001,                                                            │  │

│  │       "eventId": 1,                                                              │  │

│  │       "seatIds": ["A-15", "A-16"],                                               │  │

│  │       "paymentId": "PG-123456",                                                  │  │

│  │       "amount": 154000,                                                          │  │

│  │       "createdAt": "2024-01-25T14:30:00"                                         │  │

│  │   }                                                                              │  │

│  └───────────────────────────────────────────────────────────────────────────────────┘  │

│                                                                                         │

│  ┌───────────────────────────────────────────────────────────────────────────────────┐  │

│  │                               notification 토픽                                    │  │

│  │                                                                                   │  │

│  │   용도: 예매 완료 알림 (SMS, 이메일, 푸시)                                           │  │

│  └───────────────────────────────────────────────────────────────────────────────────┘  │

│                                                                                         │

│  ┌───────────────────────────────────────────────────────────────────────────────────┐  │

│  │                                 seat-sync 토픽                                     │  │

│  │                                                                                   │  │

│  │   용도: Redis ↔ DB 좌석 상태 동기화                                                 │  │

│  └───────────────────────────────────────────────────────────────────────────────────┘  │

└─────────────────────────────────────────────────────────────────────────────────────────┘

                                                  │

                                                  ▼

┌─────────────────────────────────────────────────────────────────────────────────────────┐

│                                  Worker (Kafka Consumers)                                │

│                                                                                         │

│  ┌─────────────────────────────┐ ┌─────────────────────────────┐ ┌─────────────────────────────┐

│  │   Booking Worker (x5)       │ │  Notification Worker (x3)   │ │     Sync Worker (x2)        │

│  │                             │ │                             │ │                             │

│  │   토픽: booking-completed   │ │   토픽: notification        │ │   토픽: seat-sync           │

│  │                             │ │                             │ │                             │

│  │   처리:                     │ │   처리:                     │ │   처리:                     │

│  │   - 예매 정보 DB 저장        │ │   - SMS 발송                │ │   - Redis ↔ DB 동기화       │

│  │   - 좌석 상태 업데이트       │ │   - 이메일 발송             │ │   - 불일치 감지 및 복구      │

│  │   - 결제 정보 저장           │ │   - 앱 푸시 알림            │ │                             │

│  │                             │ │                             │ │                             │

│  │   실패 시:                   │ │   외부 연동:                │ │                             │

│  │   - DLQ로 이동              │ │   - AWS SNS                 │ │                             │

│  │   - 수동 재처리             │ │   - Firebase FCM            │ │                             │

│  └─────────────────────────────┘ └─────────────────────────────┘ └─────────────────────────────┘

└─────────────────────────────────────────────────────────────────────────────────────────┘

                                                  │

                                                  ▼

┌─────────────────────────────────────────────────────────────────────────────────────────┐

│                                PostgreSQL (Primary + Replicas)                           │

│                                                                                         │

│  ┌───────────────────────────────────────────────────────────────────────────────────┐  │

│  │                                Primary (쓰기 전용)                                  │  │

│  │                                                                                   │  │

│  │   bookings                       seats                         events             │  │

│  │   ┌───────────────────────┐     ┌───────────────────────┐     ┌───────────────────────┐

│  │   │ id           BIGINT  │     │ id           BIGINT  │     │ id           BIGINT  │

│  │   │ user_id      BIGINT  │     │ event_id     BIGINT  │     │ name         VARCHAR │

│  │   │ event_id     BIGINT  │     │ seat_number  VARCHAR │     │ venue        VARCHAR │

│  │   │ payment_id   VARCHAR │     │ status       ENUM    │     │ event_date   DATETIME│

│  │   │ total_amount DECIMAL │     │ holder_id    BIGINT  │     │ total_seats  INT     │

│  │   │ status       ENUM    │     │ updated_at   DATETIME│     │ open_date    DATETIME│

│  │   │ created_at   DATETIME│     └───────────────────────┘     └───────────────────────┘

│  │   └───────────────────────┘                                                       │  │

│  │                                                                                   │  │

│  │   booking_seats (예매-좌석 매핑)      payments (결제 내역)                          │  │

│  │   ┌───────────────────────┐     ┌───────────────────────┐                        │  │

│  │   │ booking_id   BIGINT  │     │ id           VARCHAR │                        │  │

│  │   │ seat_id      BIGINT  │     │ booking_id   BIGINT  │                        │  │

│  │   └───────────────────────┘     │ pg_tid       VARCHAR │                        │  │

│  │                                 │ amount       DECIMAL │                        │  │

│  │                                 │ status       ENUM    │                        │  │

│  │                                 │ created_at   DATETIME│                        │  │

│  │                                 └───────────────────────┘                        │  │

│  └───────────────────────────────────────────────────────────────────────────────────┘  │

│                                                                                         │

│  ┌───────────────────────────────────────────────────────────────────────────────────┐  │

│  │                           Read Replicas (읽기 전용, x3)                             │  │

│  │                                                                                   │  │

│  │   용도:                                                                           │  │

│  │   - 좌석 현황 조회 (Redis 미스 시)                                                  │  │

│  │   - 내 예매 내역 조회                                                              │  │

│  │   - 관리자 대시보드                                                                │  │

│  │   - 통계/리포트                                                                   │  │

│  └───────────────────────────────────────────────────────────────────────────────────┘  │

└─────────────────────────────────────────────────────────────────────────────────────────┘

```

  

---

  

## 상세 흐름도

  

### Phase 1: 대기열 진입

  

```

┌──────────┐            ┌──────────────┐            ┌──────────────┐            ┌──────────┐

│   사용자  │            │  로드밸런서   │            │  대기열 API   │            │   Redis  │

└────┬─────┘            └───────┬──────┘            └───────┬──────┘            └────┬─────┘

     │                          │                           │                        │

     │  예매하기 클릭            │                           │                        │

     │─────────────────────────▶│                           │                        │

     │                          │  /api/queue/enter         │                        │

     │                          │──────────────────────────▶│                        │

     │                          │                           │                        │

     │                          │                           │  ZADD queue:event1     │

     │                          │                           │  {timestamp} user1     │

     │                          │                           │───────────────────────▶│

     │                          │                           │                        │

     │                          │                           │  ZRANK queue:event1    │

     │                          │                           │  user1                 │

     │                          │                           │───────────────────────▶│

     │                          │                           │                        │

     │                          │                           │◀────── rank: 3846 ─────│

     │                          │                           │                        │

     │                          │◀──────────────────────────│                        │

     │                          │                           │                        │

     │◀─────────────────────────│                           │                        │

     │                          │                           │                        │

     │  응답:                   │                           │                        │

     │  {                       │                           │                        │

     │    position: 3847,       │                           │                        │

     │    token: "abc-123",     │                           │                        │

     │    estimatedWait: 1923   │                           │                        │

     │  }                       │                           │                        │

     │                          │                           │                        │

```

  

### Phase 2: 대기 중 (폴링)

  

```

┌──────────────────┐                 ┌──────────────┐                 ┌──────────┐

│  브라우저 (JS)    │                 │  대기열 API   │                 │   Redis  │

└────────┬─────────┘                 └───────┬──────┘                 └────┬─────┘

         │                                   │                             │

         │  while(waiting) {                 │                             │

         │                                   │                             │

         │    GET /queue/status              │                             │

         │──────────────────────────────────▶│                             │

         │                                   │  GET entry:user1:event1     │

         │                                   │────────────────────────────▶│

         │                                   │◀─────── null (아직 없음) ────│

         │                                   │                             │

         │                                   │  ZRANK queue:event1         │

         │                                   │────────────────────────────▶│

         │                                   │◀─────── rank: 2891 ─────────│

         │                                   │                             │

         │◀────── { canEnter: false,         │                             │

         │          position: 2892 } ────────│                             │

         │                                   │                             │

         │    updateUI(2892)                 │                             │

         │    sleep(2000)                    │                             │

         │                                   │                             │

         │  }  // 2초 후 반복                 │                             │

         │                                   │                             │

```

  

### Phase 3: 입장 허용

  

```

┌────────────┐                                   ┌──────────┐

│  스케줄러   │                                   │   Redis  │

└─────┬──────┘                                   └────┬─────┘

      │                                               │

      │  매 1초마다 실행                               │

      │                                               │

      │  SCARD active:event1                          │

      │──────────────────────────────────────────────▶│

      │◀─────────────────────────────────── 850 ─────│

      │                                               │

      │  입장 가능: 1000 - 850 = 150                  │

      │                                               │

      │  ZRANGE queue:event1 0 149                    │

      │──────────────────────────────────────────────▶│

      │◀──────────────────────── [user1, user2, ...] ─│

      │                                               │

      │  for each user:                               │

      │                                               │

      │    ZREM queue:event1 user1                    │

      │──────────────────────────────────────────────▶│

      │                                               │

      │    SADD active:event1 user1                   │

      │──────────────────────────────────────────────▶│

      │                                               │

      │    SET entry:user1:event1 {token} EX 600      │

      │──────────────────────────────────────────────▶│

      │                                               │

```

  

```

이후 사용자가 폴링하면:

  

┌──────────────────┐                 ┌──────────────┐                 ┌──────────┐

│  브라우저 (JS)    │                 │  대기열 API   │                 │   Redis  │

└────────┬─────────┘                 └───────┬──────┘                 └────┬─────┘

         │                                   │                             │

         │  GET /queue/status                │                             │

         │──────────────────────────────────▶│                             │

         │                                   │  GET entry:user1:event1     │

         │                                   │────────────────────────────▶│

         │                                   │◀─────── "token-xyz" ────────│

         │                                   │                             │

         │◀────── { canEnter: true,          │                             │

         │          entryToken: "..." } ─────│                             │

         │                                   │                             │

         │  // 예매 페이지로 이동             │                             │

         │  location.href =                  │                             │

         │    '/booking?token=...'           │                             │

         │                                   │                             │

```

  

### Phase 4: 좌석 선점

  

```

┌──────────┐            ┌──────────────┐            ┌───────────────────────────────────────────┐

│   사용자  │            │   예매 API   │            │                   Redis                   │

└────┬─────┘            └───────┬──────┘            │                                           │

     │                          │                   │  ┌─────────────────────────────────────┐  │

     │  A-15 좌석 클릭          │                   │  │         Lua 스크립트 실행            │  │

     │─────────────────────────▶│                   │  │                                     │  │

     │                          │                   │  │  1. GET seat:event1:A-15            │  │

     │                          │  EVAL lua...      │  │                                     │  │

     │                          │─────────────────▶ │  │  2. 값이 있으면?                    │  │

     │                          │                   │  │     → return holder (실패)          │  │

     │                          │                   │  │                                     │  │

     │                          │                   │  │  3. 값이 없으면?                    │  │

     │                          │                   │  │     → SET seat:event1:A-15          │  │

     │                          │                   │  │           user1 EX 600              │  │

     │                          │                   │  │     → return 'OK' (성공)            │  │

     │                          │                   │  │                                     │  │

     │                          │                   │  │  ※ 이 과정이 원자적으로 실행         │  │

     │                          │                   │  │  ※ 다른 요청은 블록됨               │  │

     │                          │                   │  └─────────────────────────────────────┘  │

     │                          │◀──────── OK ──────│                                           │

     │                          │                   └───────────────────────────────────────────┘

     │◀─────────────────────────│

     │  "좌석 선점 완료"         │

     │  "10분 내 결제"           │

     │                          │

```

  

```

동시에 다른 사용자가 같은 좌석 선택 시:

  

┌──────────┐            ┌──────────────┐            ┌──────────┐

│  사용자2  │            │   예매 API   │            │   Redis  │

└────┬─────┘            └───────┬──────┘            └────┬─────┘

     │                          │                        │

     │  A-15 좌석 클릭          │                        │

     │─────────────────────────▶│                        │

     │                          │  EVAL lua...           │

     │                          │───────────────────────▶│

     │                          │                        │

     │                          │      이미 user1이      │

     │                          │      선점한 상태       │

     │                          │                        │

     │                          │◀───── "user1" (실패) ──│

     │                          │                        │

     │◀─────────────────────────│                        │

     │  "이미 선택된             │                        │

     │   좌석입니다"             │                        │

     │                          │                        │

```

  

### Phase 5: 결제 및 확정

  

```

┌──────────┐   ┌────────────┐   ┌──────────┐   ┌──────────┐   ┌──────────┐   ┌──────────┐

│   사용자  │   │  결제 API  │   │   PG사   │   │   Redis  │   │   Kafka  │   │  Worker  │

└────┬─────┘   └─────┬──────┘   └────┬─────┘   └────┬─────┘   └────┬─────┘   └────┬─────┘

     │               │               │              │              │              │

     │  결제하기     │               │              │              │              │

     │──────────────▶│               │              │              │              │

     │               │               │              │              │              │

     │               │  결제 요청    │              │              │              │

     │               │──────────────▶│              │              │              │

     │               │               │              │              │              │

     │               │◀── 결제 승인 ─│              │              │              │

     │               │               │              │              │              │

     │               │  Redis 상태 변경             │              │              │

     │               │─────────────────────────────▶│              │              │

     │               │  DEL seat:event1:A-15        │              │              │

     │               │  SET confirmed:event1:A-15   │              │              │

     │               │  SREM active:event1 user1    │              │              │

     │               │               │              │              │              │

     │               │  Kafka 발행   │              │              │              │

     │               │─────────────────────────────────────────────▶│              │

     │               │  { bookingId, userId, seatId, paymentId }   │              │

     │               │               │              │              │              │

     │◀──────────────│               │              │              │              │

     │  "예매 완료!" │               │              │              │              │

     │               │               │              │              │  consume     │

     │               │               │              │              │─────────────▶│

     │               │               │              │              │              │

     │               │               │              │              │   DB INSERT  │

     │               │               │              │              │   bookings   │

     │               │               │              │              │   seats      │

     │               │               │              │              │   payments   │

     │               │               │              │              │              │

```

  

---

  

## 확장 전략

  

| 구분              | 평상시  | 티켓 오픈 시 | 비고          |

|-------------------|--------|-------------|---------------|

| 대기열 API 서버    | 3대    | 30대        | Auto Scaling  |

| 예매 API 서버      | 3대    | 15대        | Auto Scaling  |

| 결제 API 서버      | 2대    | 10대        | Auto Scaling  |

| Redis Cluster     | 6노드  | 12노드      | 수동 확장     |

| Kafka Broker      | 3대    | 6대         | 수동 확장     |

| Worker            | 5대    | 30대        | Auto Scaling  |

| DB Read Replica   | 2대    | 5대         | 수동 확장     |

  

---

  

## 핵심 설계 원칙

  

| 원칙        | 구현 방법                    | 효과                          |

|-------------|------------------------------|-------------------------------|

| DB 보호     | 대기열로 트래픽 제어          | DB 과부하 방지                 |

| 동시성 제어 | Lua 스크립트 원자적 처리      | 중복 예매 방지                 |

| 비동기 처리 | Kafka로 DB 저장 분리          | API 응답 속도 확보             |

| 자동 해제   | Redis TTL 활용               | 미결제 좌석 자동 반환          |

| 장애 격리   | 서비스별 서버 분리            | 부분 장애 시 전체 영향 최소화  |

| 수평 확장   | Stateless API 설계           | 서버 추가만으로 처리량 증가    |
## 컴포넌트별 역할

### 1. CDN

- 정적 리소스 캐싱 (HTML, JS, CSS, 이미지)
- 서버 부하 감소

### 2. 로드밸런서 (Nginx/HAProxy)

- 트래픽 분산
- Rate Limiting
- DDoS 방어

### 3. 대기열 API 서버

|엔드포인트|역할|
|---|---|
|`POST /queue/enter`|대기열 진입|
|`GET /queue/status`|순번 확인 (폴링)|

### 4. 예매 API 서버

|엔드포인트|역할|
|---|---|
|`GET /seats`|좌석 현황 조회|
|`POST /seats/select`|좌석 선점|
|`POST /payment`|결제 처리|

### 5. Redis Cluster

|키 패턴|자료구조|용도|TTL|
|---|---|---|---|
|`queue:{eventId}`|Sorted Set|대기열 (시각순 정렬)|-|
|`active:{eventId}`|Set|현재 예매 중인 사용자|-|
|`entry:{userId}:{eventId}`|String|입장 토큰|10분|
|`seat:{eventId}:{seatId}`|String|좌석 임시 선점|10분|
|`confirmed:{eventId}:{seatId}`|String|좌석 확정|없음|

### 6. 스케줄러 (1초마다 실행)

1. 현재 활성 사용자 수 확인
2. 입장 가능 인원 계산 (최대 동시 수 - 현재 활성 수)
3. 대기열에서 N명 꺼내기
4. 입장 토큰 발급

### 7. Kafka

- 토픽: `booking-completed`
- 예매 완료 이벤트 발행
- 비동기로 DB 저장 처리

### 8. Worker (Kafka Consumer)

- 예매 정보 DB 저장
- 좌석 상태 업데이트

### 9. PostgreSQL

- 예매 내역 영구 저장
- Primary + Read Replicas 구성

---

## 데이터 흐름

### 1단계: 대기열 진입

```
사용자 → 대기열 API → Redis ZSet 등록
```

- `ZADD queue:event1 {timestamp} user1`

### 2단계: 대기 중 (폴링)

```
브라우저 JS (2초마다) → 대기열 API → Redis 순번 조회
```

- `ZRANK queue:event1 user1`

### 3단계: 입장 처리

```
스케줄러 → Redis에서 N명 꺼내기 → 입장 토큰 발급
```

- `ZRANGE queue:event1 0 199`
- `ZREM queue:event1 user1`
- `SADD active:event1 user1`
- `SET entry:user1:event1 {token} EX 600`

### 4단계: 좌석 선점 (Lua 스크립트)

```
사용자 → 예매 API → Redis Lua 스크립트 (원자적)
```

```lua
local holder = redis.call('GET', seat_key)
if holder then
    return 'FAIL'
end
redis.call('SET', seat_key, user_id, 'EX', 600)
return 'OK'
```

### 5단계: 결제 + 확정

```
사용자 → 예매 API → PG사 결제 → Kafka 발행 → Worker → DB 저장
```

---

## 핵심 설계 원칙

|원칙|설명|
|---|---|
|**DB 보호**|대기열로 트래픽 제어, Redis가 1차 방어선|
|**동시성 제어**|Lua 스크립트로 원자적 좌석 선점 (중복 예매 방지)|
|**비동기 처리**|Kafka로 DB 저장 분리 (API 응답 속도 확보)|
|**자동 해제**|Redis TTL로 미결제 좌석 자동 반환|

---

## 확장 전략

|구분|평상시|티켓 오픈 시|
|---|---|---|
|API 서버|3대|30대 (Auto Scaling)|
|대기열 서버|2대|10대|
|Redis|3대 (Cluster)|6대 (Cluster)|
|DB Read Replica|2대|5대|
|Worker|5대|20대|