## 전체 시스템 구조

```
						┌───────────────────────┐
						│  사용자 (10만+ 동시)   │
						│                       │
						│  브라우저 JS 실행      │
						│  - 대기열 폴링 (2초)   │
						│  - 좌석 선택 UI        │
						└───────────┬───────────┘
									│
									▼
			┌───────────────────────────────────────────────┐
			│                     CDN                       │
			│                                               │
			│  역할: 정적 리소스 캐싱                          │
			│  - HTML, JS, CSS, 이미지                       │
			│  - 원본 서버 요청 80% 감소                      │
			└───────────────────────┬───────────────────────┘
			                        │
			                        ▼
			┌───────────────────────────────────────────────┐
			│          로드밸런서 (Nginx / HAProxy)          │
			│                                               │
			│  ┌─────────────┐ ┌─────────────┐              │
			│  │Rate Limiting│ │ DDoS 방어   │               │
			│  │IP당 100/초  │ │ Bot 필터링  │                │
			│  └─────────────┘ └─────────────┘              │
			│                                               │
			│  라우팅:                                       │
			│  - /api/queue/*   → 대기열 서버                │
			│  - /api/booking/* → 예매 서버                  │
			│  - /api/payment/* → 결제 서버                  │
			└───────────────────────┬───────────────────────┘
			                        │
			        ┌───────────────┼───────────────┐
			        │               │               │
			        ▼               ▼               ▼
			┌─────────────┐ ┌─────────────┐ ┌─────────────┐
			│ 대기열 API  │ │  예매 API   │ │  결제 API   │
			│   (x10)     │ │   (x10)     │ │    (x5)     │
			├─────────────┤ ├─────────────┤ ├─────────────┤
			│POST /enter  │ │GET /seats   │ │POST /request│
			│→ZSet 등록   │ │→현황 조회   │ │→PG 결제요청 │
			├─────────────┤ ├─────────────┤ ├─────────────┤
			│GET /status  │ │POST /select │ │POST /confirm│
			│→순번 확인   │ │→Lua 선점    │ │→결제 확정   │
			├─────────────┤ ├─────────────┤ ├─────────────┤
			│GET /position│ │DEL /release │ │POST /cancel │
			│→대기시간    │ │→선점 해제   │ │→결제 취소   │
			├─────────────┤ ├─────────────┤ ├─────────────┤
			│ 5만 req/sec │ │ 1만 req/sec │ │ 1천 req/sec │
			└──────┬──────┘ └──────┬──────┘ └──────┬──────┘
			       │               │               │
			       └───────────────┼───────────────┘
			                       │
			                       ▼
			┌───────────────────────────────────────────────┐
			│              Redis Cluster (6노드)             │
			│                                               │
			│  ┌─────────────────────────────────────────┐  │
			│  │             대기열 관리                  │  │
			│  │                                         │  │
			│  │  키: queue:{eventId}                    │  │
			│  │  타입: Sorted Set                       │  │
			│  │  구조: { userId: timestamp }            │  │
			│  │                                         │  │
			│  │  예시:                                  │  │
			│  │  queue:event1 = {                       │  │
			│  │    "user_1001": 1706234567.123,         │  │
			│  │    "user_1002": 1706234567.456          │  │
			│  │  }                                      │  │
			│  │                                         │  │
			│  │  명령어:                                │  │
			│  │  - ZADD  → 대기열 등록                  │  │
			│  │  - ZRANK → 순번 조회                    │  │
			│  │  - ZRANGE → 상위 N명 조회               │  │
			│  │  - ZREM  → 대기열 제거                  │  │
			│  └─────────────────────────────────────────┘  │
			│                                               │
			│  ┌─────────────────────────────────────────┐  │
			│  │           활성 사용자 관리               │  │
			│  │                                         │  │
			│  │  키: active:{eventId}                   │  │
			│  │  타입: Set                              │  │
			│  │  용도: 현재 예매 중인 사용자             │  │
			│  │                                         │  │
			│  │  명령어:                                │  │
			│  │  - SADD      → 활성 등록                │  │
			│  │  - SREM      → 활성 제거                │  │
			│  │  - SCARD     → 활성 수 조회             │  │
			│  │  - SISMEMBER → 활성 여부                │  │
			│  └─────────────────────────────────────────┘  │
			│                                               │
			│  ┌─────────────────────────────────────────┐  │
			│  │            입장 토큰 관리                │  │
			│  │                                         │  │
			│  │  키: entry:{userId}:{eventId}           │  │
			│  │  타입: String                           │  │
			│  │  TTL: 600초 (10분)                      │  │
			│  │  값: UUID 토큰                          │  │
			│  │                                         │  │
			│  │  명령어:                                │  │
			│  │  - SET {token} EX 600 → 토큰 발급       │  │
			│  │  - GET → 토큰 조회                      │  │
			│  │  - DEL → 토큰 삭제                      │  │
			│  └─────────────────────────────────────────┘  │
			│                                               │
			│  ┌─────────────────────────────────────────┐  │
			│  │            좌석 선점 관리                │  │
			│  │                                         │  │
			│  │  키: seat:{eventId}:{seatId}            │  │
			│  │  타입: String                           │  │
			│  │  TTL: 600초 (미결제시 자동해제)          │  │
			│  │  값: userId                             │  │
			│  │                                         │  │
			│  │  Lua 스크립트 (원자적 선점):            │  │
			│  │  ┌───────────────────────────────────┐  │  │
			│  │  │ local holder = GET(seat_key)      │  │  │
			│  │  │ if holder then                    │  │  │
			│  │  │   return holder -- 실패           │  │  │
			│  │  │ end                               │  │  │
			│  │  │                                   │  │  │
			│  │  │ SET(seat_key, user_id, EX, ttl)   │  │  │
			│  │  │ return 'OK' -- 성공               │  │  │
			│  │  └───────────────────────────────────┘  │  │
			│  └─────────────────────────────────────────┘  │
			│                                               │
			│  ┌─────────────────────────────────────────┐  │
			│  │            확정 좌석 관리                │  │
			│  │                                         │  │
			│  │  키: confirmed:{eventId}:{seatId}       │  │
			│  │  타입: String                           │  │
			│  │  TTL: 없음 (영구)                       │  │
			│  │  값: userId                             │  │
			│  │                                         │  │
			│  │  결제 완료 후:                          │  │
			│  │  - DEL seat:event1:A-15                 │  │
			│  │  - SET confirmed:event1:A-15 {userId}   │  │
			│  └─────────────────────────────────────────┘  │
			└───────────────────────┬───────────────────────┘
			                        │
			        ┌───────────────┴───────────────┐
			        │                               │
			        ▼                               ▼
			┌─────────────────────┐ ┌─────────────────────┐
			│ 스케줄러 (1초마다)    │ │      PG사 연동       │
			│                     │ │                     │
			│ 1. 활성 수 확인       │ │ - KG이니시스         │
			│    SCARD active     │ │ - NHN KCP           │
			│                     │ │ - 토스페이먼츠        │
			│ 2. 입장가능 계산      │ │                     │
			│    1000 - 현재수     │ │ 처리:                │
			│                     │ │ - 결제 요청/승인      │
			│ 3. N명 조회          │ │ - 결제 취소/환불      │
			│    ZRANGE 0 N-1     │ │ - 타임아웃 (30초)     │
			│                     │ │                      │
			│ 4. 입장 처리         │ │ 실패 시:              │
			│    ZREM             │ │ - 좌석 해제           │
			│    SADD             │ │ - 재시도 안내         │
			│    SET entry token  │ │                     │
			└─────────────────────┘ └─────────────────────┘
			                        │
			                        ▼
			┌───────────────────────────────────────────────┐
			│                 Kafka Cluster                  │
			│                                               │
			│  ┌─────────────────────────────────────────┐  │
			│  │         booking-completed 토픽           │  │
			│  │                                         │  │
			│  │  파티션: 10 / 복제: 3 / 보존: 7일         │  │
			│  │                                         │  │
			│  │  메시지:                                 │  │
			│  │  {                                      │  │
			│  │    "bookingId": "B-20240125-001",       │  │
			│  │    "userId": 1001,                      │  │
			│  │    "eventId": 1,                        │  │
			│  │    "seatIds": ["A-15", "A-16"],         │  │
			│  │    "paymentId": "PG-123456",            │  │
			│  │    "amount": 154000                     │  │
			│  │  }                                      │  │
			│  └─────────────────────────────────────────┘  │
			│                                               │
			│  ┌─────────────────────────────────────────┐  │
			│  │          notification 토픽               │  │
			│  │  용도: SMS, 이메일, 푸시 알림              │  │
			│  └─────────────────────────────────────────┘  │
			│                                               │
			│  ┌─────────────────────────────────────────┐  │
			│  │            seat-sync 토픽                │  │
			│  │  용도: Redis ↔ DB 좌석 동기화             │  │
			│  └─────────────────────────────────────────┘  │
			└───────────────────────┬───────────────────────┘
			                        │
			                        ▼
			┌───────────────────────────────────────────────┐
			│             Worker (Kafka Consumer)            │
			│                                               │
			│ ┌─────────────┐ ┌─────────────┐ ┌───────────┐ │
			│ │Booking (x5) │ │Notif (x3)   │ │Sync (x2)  │ │
			│ │             │ │             │ │           │ │
			│ │booking-     │ │notification │ │seat-sync  │ │
			│ │completed    │ │             │ │           │ │
			│ │             │ │             │ │           │ │
			│ │처리:         │ │처리:        │ │처리:       │ │
			│ │-DB 저장      │ │-SMS 발송    │ │-동기화     │ │
			│ │-좌석 상태     │ │-이메일      │ │-불일치     │ │
			│ │-결제 정보     │ │-앱 푸시     │ │ 복구       │ │
			│ │              │ │            │ │           │ │
			│ │실패시:        │ │외부연동:    │ │           │ │
			│ │-DLQ 이동      │ │-AWS SNS    │ │           │ │
			│ │-수동 재처리   │ │-FCM         │ │           │ │
			│ └─────────────┘ └─────────────┘ └───────────┘ │
			└───────────────────────┬───────────────────────┘
			                        │
			                        ▼
			┌───────────────────────────────────────────────┐
			│          PostgreSQL (Primary + Replica)        │
			│                                               │
			│  ┌─────────────────────────────────────────┐  │
			│  │            Primary (쓰기 전용)           │  │
			│  │                                         │  │
			│  │  bookings         seats       events    │  │
			│  │  ┌──────────┐ ┌──────────┐ ┌──────────┐ │  │
			│  │  │id        │ │id        │ │id        │ │  │
			│  │  │user_id   │ │event_id  │ │name      │ │  │
			│  │  │event_id  │ │seat_num  │ │venue     │ │  │
			│  │  │payment_id│ │status    │ │date      │ │  │
			│  │  │amount    │ │holder_id │ │seats     │ │  │
			│  │  │status    │ │updated_at│ │open_date │ │  │
			│  │  │created_at│ └──────────┘ └──────────┘ │  │
			│  │  └──────────┘                           │  │
			│  │                                         │  │
			│  │  booking_seats      payments            │  │
			│  │  ┌──────────┐    ┌──────────┐           │  │
			│  │  │booking_id│    │id        │           │  │
			│  │  │seat_id   │    │booking_id│           │  │
			│  │  └──────────┘    │pg_tid    │           │  │
			│  │                  │amount    │           │  │
			│  │                  │status    │           │  │
			│  │                  └──────────┘           │  │
			│  └─────────────────────────────────────────┘  │
			│                                               │
			│  ┌─────────────────────────────────────────┐  │
			│  │        Read Replicas (읽기 전용, x3)     │  │
			│  │                                         │  │
			│  │  용도:                                   │  │
			│  │  - 좌석 현황 (Redis 미스 시)              │  │
			│  │  - 내 예매 내역 조회                      │  │
			│  │  - 관리자 대시보드                        │  │
			│  │  - 통계/리포트                            │  │
			│  └─────────────────────────────────────────┘  │
			└───────────────────────────────────────────────┘
```

---

## 상세 흐름도

### Phase 1: 대기열 진입

```
┌────────┐      ┌──────────┐      ┌─────────┐      ┌───────┐
│ 사용자  │      │로드밸런서│        │대기열API│      │ Redis │
└───┬────┘      └────┬─────┘      └────┬────┘      └───┬───┘
    │                │                 │               │
    │ 예매하기 클릭   │                 │               │
    │───────────────▶│                 │               │
    │                │ /queue/enter    │               │
    │                │────────────────▶│               │
    │                │                 │               │
    │                │                 │ ZADD queue    │
    │                │                 │ {time} user1  │
    │                │                 │──────────────▶│
    │                │                 │               │
    │                │                 │ ZRANK queue   │
    │                │                 │ user1         │
    │                │                 │──────────────▶│
    │                │                 │               │
    │                │                 │◀─ rank:3846 ──│
    │                │                 │               │
    │                │◀────────────────│               │
    │◀───────────────│                 │               │
    │                │                 │               │
    │ 응답:          │                 │               │
    │ {              │                 │               │
    │   position:    │                 │               │
    │     3847,      │                 │               │
    │   token:       │                 │               │
    │     "abc-123", │                 │               │
    │   wait: 1923   │                 │               │
    │ }              │                 │               │
```

### Phase 2: 대기 중 (폴링)

```
┌──────────────┐          ┌─────────┐          ┌───────┐
│ 브라우저(JS)  │          │대기열API│          │ Redis │
└──────┬───────┘          └────┬────┘          └───┬───┘
       │                       │                   │
       │ while(waiting) {      │                   │
       │                       │                   │
       │   GET /queue/status   │                   │
       │──────────────────────▶│                   │
       │                       │ GET entry:user1   │
       │                       │──────────────────▶│
       │                       │◀── null (없음) ───│
       │                       │                   │
       │                       │ ZRANK queue user1 │
       │                       │──────────────────▶│
       │                       │◀── rank: 2891 ────│
       │                       │                   │
       │◀──────────────────────│                   │
       │ { canEnter: false,    │                   │
       │   position: 2892 }    │                   │
       │                       │                   │
       │   updateUI(2892)      │                   │
       │   sleep(2000)         │                   │
       │                       │                   │
       │ } // 2초 후 반복       │                   │
```

### Phase 3: 입장 허용

```
┌──────────┐                         ┌───────┐
│ 스케줄러  │                         │ Redis │
└────┬─────┘                         └───┬───┘
     │                                   │
     │ 매 1초마다 실행                    │
     │                                   │
     │ SCARD active:event1               │
     │──────────────────────────────────▶│
     │◀───────────────────────── 850 ────│
     │                                   │
     │ 입장 가능: 1000 - 850 = 150       │
     │                                   │
     │ ZRANGE queue:event1 0 149         │
     │──────────────────────────────────▶│
     │◀────────── [user1, user2, ...] ───│
     │                                   │
     │ for each user:                    │
     │                                   │
     │   ZREM queue:event1 user1         │
     │──────────────────────────────────▶│
     │                                   │
     │   SADD active:event1 user1        │
     │──────────────────────────────────▶│
     │                                   │
     │   SET entry:user1:event1          │
     │       {token} EX 600              │
     │──────────────────────────────────▶│
```

```
이후 사용자 폴링:

┌──────────────┐          ┌─────────┐          ┌───────┐
│ 브라우저(JS)  │          │대기열API│          │ Redis │
└──────┬───────┘          └────┬────┘          └───┬───┘
       │                       │                   │
       │ GET /queue/status     │                   │
       │──────────────────────▶│                   │
       │                       │ GET entry:user1   │
       │                       │──────────────────▶│
       │                       │◀─ "token-xyz" ────│
       │                       │                   │
       │◀──────────────────────│                   │
       │ { canEnter: true,     │                   │
       │   token: "..." }      │                   │
       │                       │                   │
       │ // 예매 페이지 이동    │                   │
       │ location.href =       │                   │
       │   '/booking?token=..' │                   │
```

### Phase 4: 좌석 선점

```
┌────────┐      ┌────────┐      ┌───────────────────┐
│ 사용자  │      │예매 API│      │       Redis       │
└───┬────┘      └───┬────┘      │                   │
    │               │           │ ┌───────────────┐ │
    │ A-15 클릭     │           │ │ Lua 스크립트   │ │
    │──────────────▶│           │ │               │ │
    │               │ EVAL lua  │ │ 1.GET seat    │ │
    │               │──────────▶│ │               │ │
    │               │           │ │ 2.있으면?     │ │
    │               │           │ │   →FAIL      │ │
    │               │           │ │               │ │
    │               │           │ │ 3.없으면?     │ │
    │               │           │ │   →SET+TTL   │ │
    │               │           │ │   →OK        │ │
    │               │           │ │               │ │
    │               │           │ │ ※ 원자적실행  │ │
    │               │           │ │ ※ 블록처리    │ │
    │               │◀── OK ────│ └───────────────┘ │
    │◀──────────────│           └───────────────────┘
    │ "선점 완료"    │
    │ "10분내 결제"  │
```

```
동시 선택 시 (다른 사용자):

┌────────┐      ┌────────┐      ┌───────┐
│ 사용자2 │      │예매 API│      │ Redis │
└───┬────┘      └───┬────┘      └───┬───┘
    │               │               │
    │ A-15 클릭     │               │
    │──────────────▶│               │
    │               │ EVAL lua...   │
    │               │──────────────▶│
    │               │               │
    │               │  이미 user1   │
    │               │  선점 상태    │
    │               │               │
    │               │◀─ "user1" ────│
    │◀──────────────│    (실패)     │
    │ "이미 선택된   │               │
    │  좌석입니다"   │               │
```

### Phase 5: 결제 및 확정

```
┌──────┐ ┌──────┐ ┌────┐ ┌─────┐ ┌─────┐ ┌──────┐
│사용자│ │결제  │ │PG사│ │Redis│ │Kafka│ │Worker│
│      │ │API   │ │    │ │     │ │     │ │      │
└──┬───┘ └──┬───┘ └─┬──┘ └──┬──┘ └──┬──┘ └──┬───┘
   │        │       │       │       │       │
   │결제하기│       │       │       │       │
   │───────▶│       │       │       │       │
   │        │결제   │       │       │       │
   │        │요청   │       │       │       │
   │        │──────▶│       │       │       │
   │        │◀승인──│       │       │       │
   │        │       │       │       │       │
   │        │ Redis 상태변경│       │       │
   │        │──────────────▶│       │       │
   │        │ DEL seat      │       │       │
   │        │ SET confirmed │       │       │
   │        │ SREM active   │       │       │
   │        │       │       │       │       │
   │        │ Kafka 발행    │       │       │
   │        │──────────────────────▶│       │
   │        │ {booking...}  │       │       │
   │        │       │       │       │       │
   │◀───────│       │       │       │       │
   │"완료!" │       │       │       │       │
   │        │       │       │consume│       │
   │        │       │       │──────────────▶│
   │        │       │       │       │       │
   │        │       │       │       │DB저장 │
   │        │       │       │       │bookings
   │        │       │       │       │seats  │
   │        │       │       │       │payments
```

---

## 확장 전략

|구분|평상시|오픈시|비고|
|---|---|---|---|
|대기열 API|3대|30대|Auto Scaling|
|예매 API|3대|15대|Auto Scaling|
|결제 API|2대|10대|Auto Scaling|
|Redis Cluster|6노드|12노드|수동 확장|
|Kafka Broker|3대|6대|수동 확장|
|Worker|5대|30대|Auto Scaling|
|DB Read Replica|2대|5대|수동 확장|

---

## 핵심 설계 원칙

|원칙|구현 방법|효과|
|---|---|---|
|DB 보호|대기열로 트래픽 제어|DB 과부하 방지|
|동시성 제어|Lua 원자적 처리|중복 예매 방지|
|비동기 처리|Kafka로 DB저장 분리|API 응답속도 확보|
|자동 해제|Redis TTL 활용|미결제 좌석 반환|
|장애 격리|서비스별 서버 분리|부분장애 영향 최소화|
|수평 확장|Stateless API 설계|서버추가로 처리량↑|
## 컴포넌트별 역할

### 1. CDN

- 정적 리소스 캐싱 (HTML, JS, CSS, 이미지)
- 서버 부하 감소

### 2. 로드밸런서 (Nginx/HAProxy)

- 트래픽 분산
- Rate Limiting
- DDoS 방어

### 3. 대기열 API 서버

|엔드포인트|역할|
|---|---|
|`POST /queue/enter`|대기열 진입|
|`GET /queue/status`|순번 확인 (폴링)|

### 4. 예매 API 서버

|엔드포인트|역할|
|---|---|
|`GET /seats`|좌석 현황 조회|
|`POST /seats/select`|좌석 선점|
|`POST /payment`|결제 처리|

### 5. Redis Cluster

|키 패턴|자료구조|용도|TTL|
|---|---|---|---|
|`queue:{eventId}`|Sorted Set|대기열 (시각순 정렬)|-|
|`active:{eventId}`|Set|현재 예매 중인 사용자|-|
|`entry:{userId}:{eventId}`|String|입장 토큰|10분|
|`seat:{eventId}:{seatId}`|String|좌석 임시 선점|10분|
|`confirmed:{eventId}:{seatId}`|String|좌석 확정|없음|

### 6. 스케줄러 (1초마다 실행)

1. 현재 활성 사용자 수 확인
2. 입장 가능 인원 계산 (최대 동시 수 - 현재 활성 수)
3. 대기열에서 N명 꺼내기
4. 입장 토큰 발급

### 7. Kafka

- 토픽: `booking-completed`
- 예매 완료 이벤트 발행
- 비동기로 DB 저장 처리

### 8. Worker (Kafka Consumer)

- 예매 정보 DB 저장
- 좌석 상태 업데이트

### 9. PostgreSQL

- 예매 내역 영구 저장
- Primary + Read Replicas 구성

---

## 데이터 흐름

### 1단계: 대기열 진입

```
사용자 → 대기열 API → Redis ZSet 등록
```

- `ZADD queue:event1 {timestamp} user1`

### 2단계: 대기 중 (폴링)

```
브라우저 JS (2초마다) → 대기열 API → Redis 순번 조회
```

- `ZRANK queue:event1 user1`

### 3단계: 입장 처리

```
스케줄러 → Redis에서 N명 꺼내기 → 입장 토큰 발급
```

- `ZRANGE queue:event1 0 199`
- `ZREM queue:event1 user1`
- `SADD active:event1 user1`
- `SET entry:user1:event1 {token} EX 600`

### 4단계: 좌석 선점 (Lua 스크립트)

```
사용자 → 예매 API → Redis Lua 스크립트 (원자적)
```

```lua
local holder = redis.call('GET', seat_key)
if holder then
    return 'FAIL'
end
redis.call('SET', seat_key, user_id, 'EX', 600)
return 'OK'
```

### 5단계: 결제 + 확정

```
사용자 → 예매 API → PG사 결제 → Kafka 발행 → Worker → DB 저장
```

---

## 핵심 설계 원칙

|원칙|설명|
|---|---|
|**DB 보호**|대기열로 트래픽 제어, Redis가 1차 방어선|
|**동시성 제어**|Lua 스크립트로 원자적 좌석 선점 (중복 예매 방지)|
|**비동기 처리**|Kafka로 DB 저장 분리 (API 응답 속도 확보)|
|**자동 해제**|Redis TTL로 미결제 좌석 자동 반환|

---

## 확장 전략

|구분|평상시|티켓 오픈 시|
|---|---|---|
|API 서버|3대|30대 (Auto Scaling)|
|대기열 서버|2대|10대|
|Redis|3대 (Cluster)|6대 (Cluster)|
|DB Read Replica|2대|5대|
|Worker|5대|20대|