Idempotency(멱등성)는 **같은 요청을 여러 번 보내도 결과가 동일한 것**이다.

결제, 주문, 재고 같은 핵심 도메인에서 중복 처리 방지를 위해 필수

---

## 문제 상황

```
사용자 → 결제 요청 → 서버 처리 완료 → 응답 중 네트워크 끊김
                                        ↓
                              사용자: "결제 안 됐나?" 재시도
                                        ↓
                                    결제 2번 됨
```

---

## 해결: 멱등성 키

```
첫 번째 요청: Idempotency-Key: abc-123 → 처리 O, 결과 저장
두 번째 요청: Idempotency-Key: abc-123 → 이미 처리됨, 저장된 결과 반환
```

---

## 구현 방법

**DB 저장**
```java
Optional<Payment> existing = paymentRepository.findByIdempotencyKey(key);
if (existing.isPresent()) {
    return existing.get().getResult();  // 저장된 결과 반환
}
// 처리 후 저장
```

**Redis SETNX**
```java
Boolean isNew = redisTemplate.opsForValue()
    .setIfAbsent(key, "PROCESSING", Duration.ofHours(24));
if (!isNew) return cached;  // 이미 처리됨
```

---

## HTTP 메서드와 멱등성

| 메서드 | 멱등성 | 설명 |
|--------|--------|------|
| GET | ✅ | 조회만 |
| PUT | ✅ | 덮어씀 |
| DELETE | ✅ | 이미 없으면 성공 |
| POST | ❌ | **멱등성 키 필요** |

---

## Kafka Consumer 멱등성

```java
@KafkaListener(topics = "order-events")
public void handle(OrderEvent event) {
    if (processedEventRepository.existsById(event.getEventId())) {
        return;  // 이미 처리됨
    }
    // 처리 후 기록
    processedEventRepository.save(event.getEventId());
}
```

---

## 언제 필요?

| 필수 | 선택 |
|------|------|
| 결제, 송금 | 게시글 작성 |
| 주문 | 댓글 |
| 포인트 적립 | 좋아요 |

**돈 관련 = 필수**

---

## 관련 개념

- [[03. Outbox Pattern (해결책)]]
- [[05. Circuit Breaker Pattern (회로 차단기)]]

---

## Tags

#Idempotency #멱등성 #중복처리 #분산시스템
