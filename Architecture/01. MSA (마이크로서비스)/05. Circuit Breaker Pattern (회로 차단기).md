Circuit Breaker는 **외부 서비스 호출 실패가 반복되면 호출을 차단해서 장애 전파를 막는 패턴**이다.
Resilience4j, Hystrix 등으로 구현한다.

---

## 문제 상황

```
재고 서비스 장애 시:
사용자 요청 → 주문 서비스 → 재고 서비스 (응답 없음)
                  ↓
             스레드 점유 (30초 대기)
                  ↓
             스레드 풀 고갈
                  ↓
             주문 서비스도 장애 ← 장애 전파!
```

---

## 3가지 상태

```
[CLOSED] ──실패 N회──→ [OPEN] ──일정 시간──→ [HALF-OPEN]
    ▲                                            │
    └────────────성공하면 CLOSED로────────────────┘
```

| 상태 | 동작 |
|------|------|
| CLOSED | 정상 호출, 실패 횟수 카운트 |
| OPEN | 호출 차단, 바로 fallback 실행 |
| HALF-OPEN | 일부만 테스트 호출, 복구 확인 |

---

## 코드 예시

```java
@CircuitBreaker(name = "inventory", fallbackMethod = "fallback")
public void deductInventory(Order order) {
    restTemplate.post("http://inventory-service/deduct", order);
}

public void fallback(Order order, Exception e) {
    pendingQueue.add(order);  // 큐에 저장 → 나중에 재처리
}
```

---

## Fallback 전략

| 작업 유형 | 전략 | 예시 |
|----------|------|------|
| 쓰기 | 큐 저장 → 재처리 | 재고 차감 |
| 읽기 | 캐시 반환 | 상품 정보 |
| 필수 | 대체 서비스 | 결제 → 백업 PG |

---

## Outbox + Circuit Breaker

```
Outbox 테이블 → 스케줄러 → Kafka 발행
                  ↓
           Kafka 장애 시 Circuit Breaker OPEN
                  ↓
           발행 차단 (PENDING 유지)
                  ↓
           복구되면 자동 발행
```

- **Outbox**: 데이터 유실 방지
- **Circuit Breaker**: 무한 재시도 방지

---

## Circuit Breaker vs Retry

| 패턴 | 목적 |
|------|------|
| Retry | 일시적 실패 극복 |
| Circuit Breaker | 지속적 실패 시 장애 전파 방지 |

```java
@Retry(name = "inventory")
@CircuitBreaker(name = "inventory", fallbackMethod = "fallback")
public void deductInventory(Order order) { ... }
```

---

## 장단점

| 장점 | 단점 |
|------|------|
| 장애 전파 방지 | 설정 튜닝 필요 |
| 빠른 실패 | fallback 로직 필요 |

---

## 관련 개념

- [[01. Microservices Architecture (기본 개념)]]
- [[03. Outbox Pattern (해결책)]]

---

## Tags

#CircuitBreaker #MSA #장애전파 #Resilience4j
