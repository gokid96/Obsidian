

Distributed Tracing은 **여러 서비스를 거치는 요청의 흐름을 추적하는 방법**
Jaeger, Zipkin, AWS X-Ray 등으로 구현

---

## 왜 필요한가

**MSA에서 에러 발생 시:**

```
Client → API Gateway → Order → Payment → Inventory → ???
                                              ↓
                                           어디서 느려졌지?
                                           어디서 에러났지?
```

서비스가 많으면 로그만으로 추적 어려움.

---

## Trace와 Span

```
Trace (하나의 요청 전체 흐름)
│
├── Span: API Gateway (10ms)
│
├── Span: Order Service (50ms)
│     │
│     └── Span: DB Query (30ms)
│
├── Span: Payment Service (100ms)
│
└── Span: Inventory Service (20ms)

총 180ms
```

|용어|설명|
|---|---|
|Trace|요청의 전체 여정 (하나의 요청 = 하나의 Trace)|
|Span|각 서비스/작업 단위의 구간|
|Trace ID|전체 요청 식별자 (모든 서비스가 공유)|
|Span ID|각 구간 식별자|

---

## 동작 방식

```
1. Client 요청 → Trace ID 생성 (abc-123)

2. 각 서비스가 Trace ID를 헤더로 전달
   Order (abc-123) → Payment (abc-123) → Inventory (abc-123)

3. 각 서비스가 자신의 Span 정보를 수집 서버로 전송

4. 수집 서버가 Trace ID로 묶어서 시각화
```

---

## 구조

```
┌───────┐  ┌───────┐  ┌───────┐
│ Order │→ │Payment│→ │ Inventory │
└───┬───┘  └───┬───┘  └───┬───┘
    │          │          │
    └──────────┼──────────┘
               ▼
        ┌─────────────┐
        │ Trace 수집   │  (Jaeger, Zipkin)
        └──────┬──────┘
               ▼
        ┌─────────────┐
        │  Dashboard  │  ← 시각화
        └─────────────┘
```

---

## 코드 예시 (Spring + Micrometer)

```yaml
# application.yml
management:
  tracing:
    sampling:
      probability: 1.0  # 100% 샘플링
  zipkin:
    tracing:
      endpoint: http://zipkin:9411/api/v2/spans
```

설정만 하면 자동으로 Trace ID 전파됨.

---

## 주요 도구

|도구|특징|
|---|---|
|Jaeger|CNCF, Uber 개발, 가장 많이 사용|
|Zipkin|Twitter 개발, 단순함|
|AWS X-Ray|AWS 관리형|

---

## 확인할 수 있는 것

|항목|설명|
|---|---|
|병목 구간|어떤 서비스가 느린지|
|에러 위치|어디서 실패했는지|
|호출 순서|서비스 간 호출 흐름|
|지연 시간|각 구간별 소요 시간|

---

## 장단점

|장점|단점|
|---|---|
|전체 흐름 파악|수집 서버 운영 필요|
|병목/에러 빠르게 찾음|성능 오버헤드 (약간)|
|디버깅 쉬움|샘플링 설정 필요|

---

## 관련 개념

- [[01. Microservices Architecture (기본 개념)]]
- [[05. Circuit Breaker Pattern (회로 차단기)]]

---

## Tags

#DistributedTracing #Jaeger #Zipkin #MSA #모니터링