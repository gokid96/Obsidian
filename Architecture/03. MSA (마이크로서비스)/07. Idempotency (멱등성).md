
IdempotencyëŠ” **ê°™ì€ ìš”ì²­ì„ ì—¬ëŸ¬ ë²ˆ ë³´ë‚´ë„ ê²°ê³¼ê°€ ë™ì¼í•œ ê²ƒ**ì„ ë§í•œë‹¤. ë¶„ì‚° ì‹œìŠ¤í…œì—ì„œ ì¬ì‹œë„ ì‹œ ì¤‘ë³µ ì²˜ë¦¬ë¥¼ ë°©ì§€í•˜ê¸° ìœ„í•´ í•„ìˆ˜ë‹¤.

```
POST /payments     â†’ í˜¸ì¶œí•  ë•Œë§ˆë‹¤ ê²°ì œ ìƒì„± 
POST /orders       â†’ í˜¸ì¶œí•  ë•Œë§ˆë‹¤ ì£¼ë¬¸ ìƒì„± 
PATCH /balance     â†’ {"add": 10000} í˜¸ì¶œí•  ë•Œë§ˆë‹¤ ì”ì•¡ ì¦ê°€ 
```

- ì´ëŸ° ê²ƒë“¤ì— **ë©±ë“±ì„± í‚¤**ë¥¼ ë¶™ì—¬ì„œ ì¤‘ë³µ ì²˜ë¦¬ë¥¼ ë°©ì§€

---

## ë¬¸ì œ ìƒí™©

```java
// ê²°ì œ ìš”ì²­
POST /payments
{ "orderId": 123, "amount": 10000 }
```
```
ì‚¬ìš©ì â†’ ê²°ì œ ìš”ì²­ â†’ ì„œë²„ ì²˜ë¦¬ ì™„ë£Œ â†’ ì‘ë‹µ ì „ì†¡ ì¤‘ ë„¤íŠ¸ì›Œí¬ ëŠê¹€
                                              â†“
                                    ì‚¬ìš©ìëŠ” ì‘ë‹µ ëª» ë°›ìŒ
                                              â†“
                                    "ê²°ì œ ì•ˆ ëë‚˜?" ì¬ì‹œë„
                                              â†“
                                    ê²°ì œ 2ë²ˆ ë¨ ğŸ’€
```

---

## í•´ê²°: ë©±ë“±ì„± í‚¤

ìš”ì²­ë§ˆë‹¤ **ê³ ìœ í•œ í‚¤**ë¥¼ ë¶™ì—¬ì„œ, ê°™ì€ í‚¤ë©´ ì¤‘ë³µ ì²˜ë¦¬ ì•ˆ í•¨.
```
ì²« ë²ˆì§¸ ìš”ì²­:
POST /payments
Idempotency-Key: abc-123
â†’ ì²˜ë¦¬ O, ê²°ê³¼ ì €ì¥

ë‘ ë²ˆì§¸ ìš”ì²­ (ì¬ì‹œë„):
POST /payments
Idempotency-Key: abc-123
â†’ ì´ë¯¸ ì²˜ë¦¬ë¨, ì €ì¥ëœ ê²°ê³¼ ë°˜í™˜
````

---

## êµ¬í˜„ ë°©ë²•

### 1. DBì— ë©±ë“±ì„± í‚¤ ì €ì¥

```java
@Service
public class PaymentService {
    
    @Transactional
    public PaymentResult pay(String idempotencyKey, PaymentRequest request) {
        // 1. ì´ë¯¸ ì²˜ë¦¬ëœ ìš”ì²­ì¸ì§€ í™•ì¸
        Optional<Payment> existing = paymentRepository.findByIdempotencyKey(idempotencyKey);
        if (existing.isPresent()) {
            return existing.get().getResult();  // ì €ì¥ëœ ê²°ê³¼ ë°˜í™˜
        }
        
        // 2. ê²°ì œ ì²˜ë¦¬
        Payment payment = processPayment(request);
        payment.setIdempotencyKey(idempotencyKey);
        paymentRepository.save(payment);
        
        return payment.getResult();
    }
}
```

### 2. Redisë¡œ ì¤‘ë³µ ì²´í¬

```java
@Service
public class PaymentService {
    
    @Autowired
    private RedisTemplate<String, String> redisTemplate;
    
    public PaymentResult pay(String idempotencyKey, PaymentRequest request) {
        // 1. Redisì— í‚¤ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸ (setIfAbsent = SETNX)
        Boolean isNew = redisTemplate.opsForValue()
            .setIfAbsent(idempotencyKey, "PROCESSING", Duration.ofHours(24));
        
        if (!isNew) {
            // ì´ë¯¸ ì²˜ë¦¬ ì¤‘ì´ê±°ë‚˜ ì™„ë£Œëœ ìš”ì²­
            String result = redisTemplate.opsForValue().get(idempotencyKey);
            return parseResult(result);
        }
        
        // 2. ê²°ì œ ì²˜ë¦¬
        PaymentResult result = processPayment(request);
        
        // 3. ê²°ê³¼ ì €ì¥
        redisTemplate.opsForValue().set(idempotencyKey, toJson(result), Duration.ofHours(24));
        
        return result;
    }
}
```

---

## í…Œì´ë¸” ì˜ˆì‹œ

```sql
CREATE TABLE payments (
    id BIGINT PRIMARY KEY,
    idempotency_key VARCHAR(100) UNIQUE,  -- ìœ ë‹ˆí¬ ì œì•½
    order_id BIGINT,
    amount DECIMAL,
    status VARCHAR(20),
    result JSON,
    created_at TIMESTAMP
);
```

|id|idempotency_key|order_id|amount|status|result|
|---|---|---|---|---|---|
|1|abc-123|123|10000|SUCCESS|{"paymentId": 1, ...}|
|2|def-456|124|20000|SUCCESS|{"paymentId": 2, ...}|

---

## ë©±ë“±ì„± í‚¤ ìƒì„± ë°©ë²•

```java
// í´ë¼ì´ì–¸íŠ¸ì—ì„œ ìƒì„±
String idempotencyKey = UUID.randomUUID().toString();

// ë˜ëŠ” ë¹„ì¦ˆë‹ˆìŠ¤ í‚¤ ì¡°í•©
String idempotencyKey = "order-" + orderId + "-payment";
```

|ë°©ì‹|ì˜ˆì‹œ|íŠ¹ì§•|
|---|---|---|
|UUID|`550e8400-e29b-41d4-a716-446655440000`|ë²”ìš©ì |
|ë¹„ì¦ˆë‹ˆìŠ¤ í‚¤|`order-123-payment`|ì˜ë¯¸ ìˆìŒ, ì¤‘ë³µ ë°©ì§€ ì‰¬ì›€|

---

## HTTP ë©”ì„œë“œì™€ ë©±ë“±ì„±

| ë©”ì„œë“œ    | ë©±ë“±ì„± | ì„¤ëª…                      |
| ------ | --- | ----------------------- |
| GET    | âœ…   | ì¡°íšŒë§Œ í•¨                   |
| PUT    | âœ…   | ê°™ì€ ë°ì´í„°ë¡œ ë®ì–´ì”€             |
| DELETE | âœ…   | ì´ë¯¸ ì—†ìœ¼ë©´ ê·¸ëƒ¥ ì„±ê³µ            |
| POST   | âŒ   | ë§¤ë²ˆ ìƒˆë¡œ ìƒì„± â†’ **ë©±ë“±ì„± í‚¤ í•„ìš”** |
| PATCH  | âŒ   | ë¶€ë¶„ ìˆ˜ì • â†’ ìƒí™©ì— ë”°ë¼ ë‹¤ë¦„       |

---

## Kafka Consumerì—ì„œì˜ ë©±ë“±ì„±

Outbox íŒ¨í„´ì—ì„œ ì¤‘ë³µ ë°œí–‰ë˜ë©´ Consumerë„ ë©±ë“±ì„± ì²˜ë¦¬ í•„ìš”:

```java
@KafkaListener(topics = "order-events")
public void handle(OrderEvent event) {
    // 1. ì´ë¯¸ ì²˜ë¦¬ëœ ì´ë²¤íŠ¸ì¸ì§€ í™•ì¸
    if (processedEventRepository.existsById(event.getEventId())) {
        log.info("ì´ë¯¸ ì²˜ë¦¬ëœ ì´ë²¤íŠ¸: {}", event.getEventId());
        return;
    }
    
    // 2. ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ì²˜ë¦¬
    inventoryService.deduct(event.getProductId(), event.getQuantity());
    
    // 3. ì²˜ë¦¬ ì™„ë£Œ ê¸°ë¡
    processedEventRepository.save(new ProcessedEvent(event.getEventId()));
}
```

---

## ì£¼ì˜ì‚¬í•­

### ë™ì‹œ ìš”ì²­ ì²˜ë¦¬

java

```java
// ë™ì‹œì— ê°™ì€ í‚¤ë¡œ ìš”ì²­ ì˜¤ë©´?
ìš”ì²­ A: idempotency-key: abc-123 â†’ ì²˜ë¦¬ ì‹œì‘
ìš”ì²­ B: idempotency-key: abc-123 â†’ ì²˜ë¦¬ ì‹œì‘  // ë‘˜ ë‹¤ í†µê³¼í•´ë²„ë¦¼ ğŸ’€
```

í•´ê²°: **DB ìœ ë‹ˆí¬ ì œì•½** ë˜ëŠ” **Redis SETNX**

java

```java
// Redis SETNXë¡œ ë½ íšë“
Boolean locked = redisTemplate.opsForValue()
    .setIfAbsent("lock:" + idempotencyKey, "1", Duration.ofSeconds(10));

if (!locked) {
    throw new DuplicateRequestException("ì²˜ë¦¬ ì¤‘ì¸ ìš”ì²­ì…ë‹ˆë‹¤");
}
```

---

## ì¥ë‹¨ì 

|ì¥ì |ë‹¨ì |
|---|---|
|ì¤‘ë³µ ì²˜ë¦¬ ë°©ì§€|í‚¤ ì €ì¥ì†Œ í•„ìš” (DB, Redis)|
|ì•ˆì „í•œ ì¬ì‹œë„|í‚¤ ë§Œë£Œ ì •ì±… ê´€ë¦¬ í•„ìš”|
|ë„¤íŠ¸ì›Œí¬ ì¥ì•  ëŒ€ì‘|êµ¬í˜„ ë³µì¡ë„ ì¦ê°€|

---

## ê´€ë ¨ ê°œë…

- [[03. Outbox Pattern (í•´ê²°ì±…)]]
- [[01. Saga Pattern (ë¶„ì‚° íŠ¸ëœì­ì…˜ ê¸°ë³¸)]]
- [[Circuit Breaker Pattern]]

---

## Tags

#Idempotency #ë©±ë“±ì„± #MSA #ë¶„ì‚°ì‹œìŠ¤í…œ #ì¤‘ë³µì²˜ë¦¬