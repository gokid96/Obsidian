# λ‚™κ΄€μ  λ½(Optimistic Lock)μ„ ν™μ©ν• λ™μ‹ μμ • μ¶©λ ν•΄κ²°

##  κ°μ”

**λ¬Έμ  μƒν™©**: λ™μΌ λ¬Έμ„λ¥Ό μ—¬λ¬ νƒ­/κΈ°κΈ°μ—μ„ λ™μ‹μ— μμ •ν•  λ• λ°μ΄ν„° μ μ‹¤ λ°μƒ

---
##  λ¬Έμ  μ •μ
### μƒν™©
 μ‚¬μ©μκ°€ **μ—¬λ¬ λΈλΌμ°μ € νƒ­**μ΄λ‚ **λ‹¤λ¥Έ κΈ°κΈ°**μ—μ„ λ™μΌν• λ¬Έμ„λ¥Ό μ—΄κ³  μμ •ν•λ” κ²½μ°κ°€ λ°μƒν•λ‹¤.


### λ¬Έμ μ 

μΌλ°μ μΈ PUT μ”μ²­μΌλ΅ μ €μ¥ μ‹, **λ§μ§€λ§‰μ— μ €μ¥ν• λ‚΄μ©λ§ λ°μ**λμ–΄ μ΄μ „ μμ • λ‚΄μ©μ΄ λ®μ–΄μ”μ›μ§€λ” **Lost Update** λ¬Έμ κ°€ λ°μƒν•λ‹¤.

  

```

[μ‹λ‚λ¦¬μ¤]

1. μ‚¬μ©μ Aκ°€ λ¬Έμ„(version=1)λ¥Ό μ—΄μ–΄ "λ‚΄μ© A" μ‘μ„± μ¤‘

2. μ‚¬μ©μ Aκ°€ λ‹¤λ¥Έ νƒ­μ—μ„ κ°™μ€ λ¬Έμ„(version=1)λ¥Ό μ—΄μ–΄ "λ‚΄μ© B" μ‘μ„± ν›„ μ €μ¥ β†’ version=2

3. μ‚¬μ©μ Aκ°€ μ²« λ²μ§Έ νƒ­μ—μ„ "λ‚΄μ© A" μ €μ¥ (version=1 κΈ°μ¤€)

4. κ²°κ³Ό: "λ‚΄μ© B"κ°€ μ μ‹¤λ¨ (Lost Update)

```

  

### ν•΄κ²° λ°©μ• λΉ„κµ

  

| λ°©μ‹ | μ¥μ  | λ‹¨μ  |

|------|------|------|

| **λΉ„κ΄€μ  λ½** | μ¶©λ μμ²΄λ¥Ό λ°©μ§€ | λ½ λ€κΈ° μ‹κ°„ λ°μƒ, λ™μ‹μ„± μ €ν• |

| **λ‚™κ΄€μ  λ½** | λ™μ‹μ„± μ μ§€, μ¶©λμ΄ λ“λ¬Έ κ²½μ° ν¨μ¨μ  | μ¶©λ μ‹ μ¬μ‹λ„ λ΅μ§ ν•„μ” |

  

β†’ λ¬Έμ„ νΈμ§‘ μ„λΉ„μ¤λ” **λ™μ‹ μμ •μ΄ λ“λ¬Όκ³ **, μ¶©λ μ‹ **μ‚¬μ©μ μ„ νƒ**μ΄ μ¤‘μ”ν•λ―€λ΅ **λ‚™κ΄€μ  λ½** μ±„νƒ

  

---

  

## π›  κµ¬ν„

  

### 1. Entity - @Version ν•„λ“ μ¶”κ°€

  

```java

@Entity

@Table(name = "post")

@Getter

@NoArgsConstructor(access = AccessLevel.PROTECTED)

@AllArgsConstructor(access = AccessLevel.PRIVATE)

@Builder

public class Post {

Β  Β  @Id

Β  Β  @GeneratedValue(strategy = GenerationType.IDENTITY)

Β  Β  @Column(name = "post_id")

Β  Β  private Long postId;

  

Β  Β  @Version Β // JPA λ‚™κ΄€μ  λ½ ν•µμ‹¬

Β  Β  private Long version;

  

Β  Β  @Column(nullable = false, length = 200)

Β  Β  private String title;

Β  Β  @Column(nullable = false, columnDefinition = "MEDIUMTEXT")

Β  Β  private String content;

  

Β  Β  @Column(name = "created_at", nullable = false, updatable = false)

Β  Β  @CreationTimestamp

Β  Β  private LocalDateTime createdAt;

Β  Β  @Column(name = "updated_at", nullable = false)

Β  Β  @UpdateTimestamp

Β  Β  private LocalDateTime updatedAt;

Β  Β  @ManyToOne(fetch = FetchType.LAZY)

Β  Β  @JoinColumn(name = "user_id", nullable = false)

Β  Β  private Users author;

  

Β  Β  @ManyToOne(fetch = FetchType.LAZY)

Β  Β  @JoinColumn(name = "folder_id")

Β  Β  private Folder folder;

  

Β  Β  @ManyToOne(fetch = FetchType.LAZY)

Β  Β  @JoinColumn(name = "workspace_id", nullable = false)

Β  Β  private Workspace workspace;

  

Β  Β  public void updateTitle(String title) {

Β  Β  Β  Β  this.title = title;

Β  Β  }

Β  Β  public void updateContent(String content) {

Β  Β  Β  Β  this.content = content;

Β  Β  }

}

```

  

**@Version λ™μ‘ μ›λ¦¬**:

- JPAκ°€ μλ™μΌλ΅ λ²„μ „μ„ κ΄€λ¦¬ν•λ©°, μ €μ¥ μ‹ versionμ΄ 1μ”© μ¦κ°€

- UPDATE μΏΌλ¦¬ μ‹¤ν–‰ μ‹ `WHERE version = ?` μ΅°κ±΄μ΄ μλ™ μ¶”κ°€λ¨

- μ΅°ν μ‹μ μ versionκ³Ό μ €μ¥ μ‹μ μ versionμ΄ λ‹¤λ¥΄λ©΄ `OptimisticLockException` λ°μƒ

  

### 2. DTO - Version ν•„λ“ ν¬ν•¨

  

```java

@Getter

@AllArgsConstructor

@NoArgsConstructor

@Builder

public class PostUpdateRequestDTO {

Β  Β  @Size(max = 200)

Β  Β  private String title;

Β  Β  @Size(max = 50000)

Β  Β  private String content;

Β  Β  private Long version; Β // ν΄λΌμ΄μ–ΈνΈκ°€ λ³΄μ ν• version

}

```

  

### 3. Service - μ¶©λ κ°μ§€ λ΅μ§

  

```java

@Service

@RequiredArgsConstructor

public class PostService {

  

Β  Β  private final PostRepository postRepository;

Β  Β  private final FolderRepository folderRepository;

Β  Β  private final UserRepository userRepository;

Β  Β  private final WorkspaceRepository workspaceRepository;

Β  Β  private final WorkspaceMemberRepository workspaceMemberRepository;

  

Β  Β  /**

Β  Β  Β * κ²μ‹κΈ€ μμ • - λ‚™κ΄€μ  λ½ μ μ©

Β  Β  Β */

Β  Β  public PostResponseDTO updatePost(Long userId, Long workspaceId,

Β  Β  Β  Β  Β  Β  Β  Β  Β  Β  Β  Β  Β  Β  Β  Β  Β  Β  Β  Β Long postId, PostUpdateRequestDTO request) {

Β  Β  Β  Β  // 1. κ¶ν• κ²€μ¦

Β  Β  Β  Β  WorkspaceMember member = getMemberOrThrow(userId, workspaceId);

Β  Β  Β  Β  checkWritePermission(member);

  

Β  Β  Β  Β  // 2. κ²μ‹κΈ€ μ΅°ν

Β  Β  Β  Β  Post post = postRepository.findByPostIdAndWorkspaceWorkspaceId(postId, workspaceId)

Β  Β  Β  Β  Β  Β  Β  Β  .orElseThrow(() -> new IllegalArgumentException("κ²μ‹κΈ€μ„ μ°Ύμ„ μ μ—†μµλ‹λ‹¤."));

  

Β  Β  Β  Β  // 3. ν΄λΌμ΄μ–ΈνΈ versionκ³Ό DB version λΉ„κµ

Β  Β  Β  Β  if (request.getVersion() != null && !request.getVersion().equals(post.getVersion())) {

Β  Β  Β  Β  Β  Β  throw new OptimisticLockException("λ‹¤λ¥Έ κ³³μ—μ„ μμ •λμ—μµλ‹λ‹¤.");

Β  Β  Β  Β  }

  

Β  Β  Β  Β  // 4. μμ • μ μ©

Β  Β  Β  Β  if (request.getTitle() != null) {

Β  Β  Β  Β  Β  Β  post.updateTitle(request.getTitle());

Β  Β  Β  Β  }

Β  Β  Β  Β  if (request.getContent() != null) {

Β  Β  Β  Β  Β  Β  post.updateContent(request.getContent());

Β  Β  Β  Β  }

  

Β  Β  Β  Β  // 5. μ €μ¥ (saveAndFlushλ΅ μ¦‰μ‹ λ°μν•μ—¬ version μ¦κ°€ ν™•μΈ)

Β  Β  Β  Β  return PostResponseDTO.from(postRepository.saveAndFlush(post));

Β  Β  }

  

Β  Β  private WorkspaceMember getMemberOrThrow(Long userId, Long workspaceId) {

Β  Β  Β  Β  Workspace workspace = workspaceRepository.findById(workspaceId)

Β  Β  Β  Β  Β  Β  Β  Β  .orElseThrow(() -> new IllegalArgumentException("μ›ν¬μ¤νμ΄μ¤λ¥Ό μ°Ύμ„ μ μ—†μµλ‹λ‹¤."));

Β  Β  Β  Β  Users user = userRepository.findById(userId)

Β  Β  Β  Β  Β  Β  Β  Β  .orElseThrow(() -> new IllegalArgumentException("μ‚¬μ©μλ¥Ό μ°Ύμ„ μ μ—†μµλ‹λ‹¤."));

  

Β  Β  Β  Β  return workspaceMemberRepository.findByWorkspaceAndUser(workspace, user)

Β  Β  Β  Β  Β  Β  Β  Β  .orElseThrow(() -> new IllegalArgumentException("μ›ν¬μ¤νμ΄μ¤ μ ‘κ·Ό κ¶ν•μ΄ μ—†μµλ‹λ‹¤."));

Β  Β  }

  

Β  Β  private void checkWritePermission(WorkspaceMember member) {

Β  Β  Β  Β  if (member.getRole() == WorkspaceRole.VIEWER) {

Β  Β  Β  Β  Β  Β  throw new IllegalArgumentException("μ“°κΈ° κ¶ν•μ΄ μ—†μµλ‹λ‹¤.");

Β  Β  Β  Β  }

Β  Β  }

}

```

  

**ν•µμ‹¬ ν¬μΈνΈ**:

- ν΄λΌμ΄μ–ΈνΈκ°€ λ³΄λ‚Έ `version`κ³Ό ν„μ¬ DBμ `version`μ„ λ…μ‹μ μΌλ΅ λΉ„κµ

- λ¶μΌμΉ μ‹ `OptimisticLockException`μ„ λμ Έ 409 Conflict μ‘λ‹µ μ λ„

- `saveAndFlush()`λ΅ μ¦‰μ‹ DBμ— λ°μν•μ—¬ version μ¦κ°€λ¥Ό λ³΄μ¥

  

### 4. Global Exception Handler - 409 Conflict μ‘λ‹µ

  

```java

@Slf4j

@RestControllerAdvice

public class GlobalExceptionHandler {

  

Β  Β  /**

Β  Β  Β * λ‚™κ΄€μ  λ½ μ¶©λ β†’ 409 Conflict

Β  Β  Β */

Β  Β  @ExceptionHandler({

Β  Β  Β  Β  Β  Β  OptimisticLockException.class,

Β  Β  Β  Β  Β  Β  ObjectOptimisticLockingFailureException.class,

Β  Β  Β  Β  Β  Β  StaleObjectStateException.class

Β  Β  })

Β  Β  public ResponseEntity<Map<String, Object>> handleOptimisticLockException(Exception e) {

Β  Β  Β  Β  log.warn("Optimistic lock conflict: {}", e.getMessage());

Β  Β  Β  Β  return createErrorResponse(HttpStatus.CONFLICT, "λ‹¤λ¥Έ κ³³μ—μ„ μμ •λμ—μµλ‹λ‹¤.");

Β  Β  }

  

Β  Β  /**

Β  Β  Β * νΈλμ­μ… λ‚΄λ¶€μ—μ„ λ°μƒν• λ‚™κ΄€μ  λ½ μμ™Έ μ²λ¦¬

Β  Β  Β * - @Transactional λ©”μ„λ“ λ‚΄μ—μ„ λ°μƒν• OptimisticLockExceptionμ€

Β  Β  Β * Β  TransactionSystemExceptionμΌλ΅ λν•‘λμ–΄ μ „νλ¨

Β  Β  Β */

Β  Β  @ExceptionHandler(TransactionSystemException.class)

Β  Β  public ResponseEntity<Map<String, Object>> handleTransactionException(TransactionSystemException e) {

Β  Β  Β  Β  Throwable cause = e.getRootCause();

  

Β  Β  Β  Β  if (cause instanceof OptimisticLockException ||

Β  Β  Β  Β  Β  Β  Β  Β  cause instanceof StaleObjectStateException) {

Β  Β  Β  Β  Β  Β  log.warn("Optimistic lock conflict in transaction: {}", cause.getMessage());

Β  Β  Β  Β  Β  Β  return createErrorResponse(HttpStatus.CONFLICT, "λ‹¤λ¥Έ κ³³μ—μ„ μμ •λμ—μµλ‹λ‹¤.");

Β  Β  Β  Β  }

  

Β  Β  Β  Β  log.error("Transaction error: ", e);

Β  Β  Β  Β  return createErrorResponse(HttpStatus.INTERNAL_SERVER_ERROR, "μ„λ²„ μ¤λ¥κ°€ λ°μƒν–μµλ‹λ‹¤.");

Β  Β  }

  

Β  Β  private ResponseEntity<Map<String, Object>> createErrorResponse(HttpStatus status, String message) {

Β  Β  Β  Β  Map<String, Object> response = new HashMap<>();

Β  Β  Β  Β  response.put("status", "error");

Β  Β  Β  Β  response.put("code", status.value());

Β  Β  Β  Β  response.put("message", message);

Β  Β  Β  Β  return ResponseEntity.status(status).body(response);

Β  Β  }

}

```

  

**μμ™Έ μ²λ¦¬ ν¬μΈνΈ**:

- `OptimisticLockException`: JPA ν‘μ¤€ μμ™Έ

- `ObjectOptimisticLockingFailureException`: Spring Data JPA μμ™Έ

- `StaleObjectStateException`: Hibernate μμ™Έ

- `TransactionSystemException`: νΈλμ­μ… μ»¤λ°‹ μ‹μ μ— λν•‘λ μμ™Έ

  

### 5. Controller

  

```java

@RestController

@RequestMapping("/api/v1/workspaces/{workspaceId}/posts")

@RequiredArgsConstructor

public class PostController {

  

Β  Β  private final PostService postService;

  

Β  Β  @PutMapping("/{postId}")

Β  Β  public ResponseEntity<PostResponseDTO> updatePost(

Β  Β  Β  Β  Β  Β  @AuthenticationPrincipal CustomUserDetails userDetails,

Β  Β  Β  Β  Β  Β  @PathVariable Long workspaceId,

Β  Β  Β  Β  Β  Β  @PathVariable Long postId,

Β  Β  Β  Β  Β  Β  @RequestBody @Valid PostUpdateRequestDTO request) {

Β  Β  Β  Β  return ResponseEntity.ok(

Β  Β  Β  Β  Β  Β  postService.updatePost(userDetails.getUserId(), workspaceId, postId, request)

Β  Β  Β  Β  );

Β  Β  }

}

```

  

---

  

## π“ λ™μ‘ νλ¦„

  

```

β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β” Β  Β  Β  Β  β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β” Β  Β  Β  Β  β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”

β”‚ Β  Client A Β  β”‚ Β  Β  Β  Β  β”‚ Β  Β Server Β  Β β”‚ Β  Β  Β  Β  β”‚ Β  Client B Β  β”‚

β””β”€β”€β”€β”€β”€β”€β”¬β”€β”€β”€β”€β”€β”€β”€β” Β  Β  Β  Β  β””β”€β”€β”€β”€β”€β”€β”¬β”€β”€β”€β”€β”€β”€β”€β” Β  Β  Β  Β  β””β”€β”€β”€β”€β”€β”€β”¬β”€β”€β”€β”€β”€β”€β”€β”

Β  Β  Β  Β β”‚ Β  Β  Β  Β  Β  Β  Β  Β  Β  Β  Β  Β β”‚ Β  Β  Β  Β  Β  Β  Β  Β  Β  Β  Β  Β β”‚

Β  Β  Β  Β β”‚ Β GET /posts/1 Β  Β  Β  Β  Β β”‚ Β  Β  Β  Β  Β  Β  Β  Β  Β  Β  Β  Β β”‚

Β  Β  Β  Β β”‚ β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β–Ί β”‚ Β  Β  Β  Β  Β  Β  Β  Β  Β  Β  Β  Β β”‚

Β  Β  Β  Β β”‚ Β {version: 1, ...} Β  Β  β”‚ Β  Β  Β  Β  Β  Β  Β  Β  Β  Β  Β  Β β”‚

Β  Β  Β  Β β”‚ β—„β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€ β”‚ Β  Β  Β  Β  Β  Β  Β  Β  Β  Β  Β  Β β”‚

Β  Β  Β  Β β”‚ Β  Β  Β  Β  Β  Β  Β  Β  Β  Β  Β  Β β”‚ Β  Β  Β  Β  Β  Β  Β  Β  Β  Β  Β  Β β”‚

Β  Β  Β  Β β”‚ Β  Β  Β  Β  Β  Β  Β  Β  Β  Β  Β  Β β”‚ Β  GET /posts/1 Β  Β  Β  Β  β”‚

Β  Β  Β  Β β”‚ Β  Β  Β  Β  Β  Β  Β  Β  Β  Β  Β  Β β”‚ β—„β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”‚

Β  Β  Β  Β β”‚ Β  Β  Β  Β  Β  Β  Β  Β  Β  Β  Β  Β β”‚ Β  {version: 1, ...} Β  Β β”‚

Β  Β  Β  Β β”‚ Β  Β  Β  Β  Β  Β  Β  Β  Β  Β  Β  Β β”‚ β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β–Ίβ”‚

Β  Β  Β  Β β”‚ Β  Β  Β  Β  Β  Β  Β  Β  Β  Β  Β  Β β”‚ Β  Β  Β  Β  Β  Β  Β  Β  Β  Β  Β  Β β”‚

Β  Β  Β  Β β”‚ Β  Β  Β  Β  Β  Β  Β  Β  Β  Β  Β  Β β”‚ Β PUT {version: 1, ..} Β β”‚

Β  Β  Β  Β β”‚ Β  Β  Β  Β  Β  Β  Β  Β  Β  Β  Β  Β β”‚ β—„β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”‚

Β  Β  Β  Β β”‚ Β  Β  Β  Β  Β  Β  Β  Β  Β  Β  Β  Β β”‚ Β  Β  Β  Β  Β  Β  Β  Β  Β  Β  Β  Β β”‚

Β  Β  Β  Β β”‚ Β  Β  Β  Β  Β  Β  Β  Β  Β  Β  Β  Β β”‚ Β [version λΉ„κµ: 1 == 1]β”‚

Β  Β  Β  Β β”‚ Β  Β  Β  Β  Β  Β  Β  Β  Β  Β  Β  Β β”‚ Β [μ €μ¥ μ„±κ³µ] Β  Β  Β  Β  Β  β”‚

Β  Β  Β  Β β”‚ Β  Β  Β  Β  Β  Β  Β  Β  Β  Β  Β  Β β”‚ Β [version β†’ 2] Β  Β  Β  Β  β”‚

Β  Β  Β  Β β”‚ Β  Β  Β  Β  Β  Β  Β  Β  Β  Β  Β  Β β”‚ Β  Β  Β  Β  Β  Β  Β  Β  Β  Β  Β  Β β”‚

Β  Β  Β  Β β”‚ Β  Β  Β  Β  Β  Β  Β  Β  Β  Β  Β  Β β”‚ Β β… 200 OK Β  Β  Β  Β  Β  Β  β”‚

Β  Β  Β  Β β”‚ Β  Β  Β  Β  Β  Β  Β  Β  Β  Β  Β  Β β”‚ Β {version: 2, ...} Β  Β  β”‚

Β  Β  Β  Β β”‚ Β  Β  Β  Β  Β  Β  Β  Β  Β  Β  Β  Β β”‚ β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β–Ίβ”‚

Β  Β  Β  Β β”‚ Β  Β  Β  Β  Β  Β  Β  Β  Β  Β  Β  Β β”‚ Β  Β  Β  Β  Β  Β  Β  Β  Β  Β  Β  Β β”‚

Β  Β  Β  Β β”‚ PUT {version: 1, ...} Β β”‚ Β  Β  Β  Β  Β  Β  Β  Β  Β  Β  Β  Β β”‚

Β  Β  Β  Β β”‚ β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β–Ί β”‚ Β  Β  Β  Β  Β  Β  Β  Β  Β  Β  Β  Β β”‚

Β  Β  Β  Β β”‚ Β  Β  Β  Β  Β  Β  Β  Β  Β  Β  Β  Β β”‚ Β  Β  Β  Β  Β  Β  Β  Β  Β  Β  Β  Β β”‚

Β  Β  Β  Β β”‚ Β [version λΉ„κµ: 1 != 2]β”‚ Β  Β  Β  Β  Β  Β  Β  Β  Β  Β  Β  Β β”‚

Β  Β  Β  Β β”‚ Β [μ¶©λ κ°μ§€!] Β  Β  Β  Β  Β β”‚ Β  Β  Β  Β  Β  Β  Β  Β  Β  Β  Β  Β β”‚

Β  Β  Β  Β β”‚ Β  Β  Β  Β  Β  Β  Β  Β  Β  Β  Β  Β β”‚ Β  Β  Β  Β  Β  Β  Β  Β  Β  Β  Β  Β β”‚

Β  Β  Β  Β β”‚ Β β 409 Conflict Β  Β  Β  β”‚ Β  Β  Β  Β  Β  Β  Β  Β  Β  Β  Β  Β β”‚

Β  Β  Β  Β β”‚ Β "λ‹¤λ¥Έ κ³³μ—μ„ μμ •λ¨" Β β”‚ Β  Β  Β  Β  Β  Β  Β  Β  Β  Β  Β  Β β”‚

Β  Β  Β  Β β”‚ β—„β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€ β”‚ Β  Β  Β  Β  Β  Β  Β  Β  Β  Β  Β  Β β”‚

```

  

---

  

## β… κ²°κ³Ό

  

### Before

- λ§μ§€λ§‰ μ €μ¥ λ‚΄μ©λ§ λ°μ (Lost Update)

- μ‚¬μ©μκ°€ μ‘μ—… λ‚΄μ© μ μ‹¤μ„ μΈμ§€ν•μ§€ λ»ν•¨

- λ°μ΄ν„° μ •ν•©μ„± λ³΄μ¥ λ¶κ°€

  

### After

- μ¶©λ μ¦‰μ‹ κ°μ§€ λ° **409 Conflict** μ‘λ‹µ

- ν΄λΌμ΄μ–ΈνΈμ—μ„ μ¶©λ μƒν™©μ„ μΈμ§€ν•κ³  μ μ ν• μ²λ¦¬ κ°€λ¥

- λ°μ΄ν„° μ μ‹¤ λ°©μ§€

  

---

  

## π’΅ ν•µμ‹¬ ν•™μµ ν¬μΈνΈ

  

1. **JPA @Version**

Β  Β - μ—”ν‹°ν‹°μ— `@Version` ν•„λ“ μ¶”κ°€λ§μΌλ΅ λ‚™κ΄€μ  λ½ κµ¬ν„ κ°€λ¥

Β  Β - UPDATE μΏΌλ¦¬μ— `WHERE version = ?` μ΅°κ±΄μ΄ μλ™ μ¶”κ°€λ¨

  

2. **λ…μ‹μ  Version λΉ„κµ**

Β  Β - `@Version`λ§μΌλ΅λ” JPA μμ†μ„± μ»¨ν…μ¤νΈ λ‚΄μ—μ„λ§ λ™μ‘

Β  Β - REST APIμ—μ„λ” ν΄λΌμ΄μ–ΈνΈκ°€ λ³΄λ‚Έ versionμ„ λ…μ‹μ μΌλ΅ λΉ„κµν•΄μ•Ό ν•¨

  

3. **μμ™Έ κ³„μΈµ μ΄ν•΄**

Β  Β - `OptimisticLockException` β†’ `TransactionSystemException`μΌλ΅ λν•‘λλ” κ²½μ° μ΅΄μ¬

Β  Β - μ—¬λ¬ μμ™Έ νƒ€μ…μ„ λ¨λ‘ ν•Έλ“¤λ§ν•΄μ•Ό λ„λ½ μ—†μ΄ μ²λ¦¬ κ°€λ¥

  

4. **HTTP μƒνƒ μ½”λ“**

Β  Β - **409 Conflict**: λ¦¬μ†μ¤ μ¶©λμ„ λ‚νƒ€λ‚΄λ” ν‘μ¤€ μƒνƒ μ½”λ“

Β  Β - ν΄λΌμ΄μ–ΈνΈκ°€ μ¶©λ μƒν™©μ„ λ…ν™•ν μΈμ§€ν•κ³  μ¬μ‹λ„ λ΅μ§ κµ¬ν„ κ°€λ¥

  

5. **saveAndFlush() μ‚¬μ©**

Β  Β - μ¦‰μ‹ DBμ— λ°μν•μ—¬ version μ¦κ°€λ¥Ό λ³΄μ¥

Β  Β - μ‘λ‹µμ— μµμ‹  versionμ„ ν¬ν•¨μ‹μΌ ν΄λΌμ΄μ–ΈνΈμ— μ „λ‹¬

  

---

  

## π”— κ΄€λ ¨ νμΌ

  

```

untitles-api/src/main/java/com/untitles/

β”β”€β”€ domain/post/

β”‚ Β  β”β”€β”€ entity/Post.java Β  Β  Β  Β  Β  Β  Β  Β  Β  Β # @Version ν•„λ“ μ •μ

β”‚ Β  β”β”€β”€ dto/request/PostUpdateRequestDTO.java Β # version ν¬ν•¨

β”‚ Β  β”β”€β”€ service/PostService.java Β  Β  Β  Β  Β  Β # version λΉ„κµ λ΅μ§

β”‚ Β  β””β”€β”€ controller/PostController.java

β””β”€β”€ global/exception/

Β  Β  β””β”€β”€ GlobalExceptionHandler.java Β  Β  Β  Β  # 409 Conflict μ‘λ‹µ μ²λ¦¬

```