## 영속성 컨텍스트란?

영속성 컨텍스트(Persistence Context)는 JPA에서 엔티티를 관리하는 논리적인 작업 공간데이터베이스와 애플리케이션 사이의 중요한 중간 계층 역할을 수행
![[Pasted image 20251110163746.png]]
### 주요 특징

- 엔티티의 생명주기를 관리
- 데이터베이스와 애플리케이션 간의 캐시 역할
- 엔티티의 상태 추적 및 변경 감지

## 영속성 컨텍스트의 핵심 기능

### 1. 엔티티 상태 관리

- **비영속(New)**: 영속성 컨텍스트와 전혀 관계없는 상태
- **영속(Managed)**: 영속성 컨텍스트에 저장된 상태
- **준영속(Detached)**: 영속성 컨텍스트에서 분리된 상태
- **삭제(Removed)**: 삭제된 상태
```java
EntityManager entityManager = entityManagerFactory.createEntityManager();
EntityTransaction transaction = entityManager.getTransaction();

transaction.begin();

// 비영속 상태
Member member = new Member();
member.setId(1L);
member.setName("홍길동");

// 영속 상태 - 영속성 컨텍스트에 저장
entityManager.persist(member);

// 준영속 상태
entityManager.detach(member);

// 삭제 상태
entityManager.remove(member);

transaction.commit();
```

### 2. 1차 캐시

- 영속성 컨텍스트 내부의 캐시 메모리
- 엔티티를 키-값 형태로 저장
- 동일한 엔티티 조회 시 데이터베이스가 아닌 캐시에서 조회

### 3. 변경 감지 (Dirty Checking)

- 트랜잭션 커밋 시점에 엔티티의 변경사항 자동 감지
- 스냅샷과 현재 엔티티 상태 비교
- 변경된 엔티티에 대해 자동으로 UPDATE SQL 생성

### 4. 쓰기 지연 (Transaction Write-behind)

- SQL 쓰기 작업을 즉시 수행하지 않고 지연
- 트랜잭션 커밋 시점에 모아둔 SQL 한 번에 실행

```java
@Transactional
public void saveMultipleEntities() {
    entityManager.persist(member1); // SQL 생성, but 실행 지연
    entityManager.persist(member2); // SQL 생성, but 실행 지연
    
    // 트랜잭션 커밋 시점에 모든 SQL 한 번에 실행
}
```

## 영속성 컨텍스트의 장점

### 성능 최적화

- 데이터베이스 왕복 최소화
- 캐싱을 통한 조회 성능 향상
- 트랜잭션 단위의 효율적인 데이터 처리

### 일관성 유지

- 엔티티의 상태를 일관되게 관리
- 데이터베이스와 애플리케이션 간의 동기화 보장

## 주의사항

### 성능과 메모리

- 영속성 컨텍스트는 메모리를 사용
- 대량의 엔티티 처리 시 메모리 관리에 주의
- 필요에 따라 `clear()`, `flush()` 메서드 활용

### 트랜잭션 범위

- 일반적으로 트랜잭션과 생명주기 동일
- 트랜잭션 종료 시 영속성 컨텍스트도 종료

## 결론

영속성 컨텍스트는 JPA의 핵심 메커니즘으로, 데이터베이스 작업의 효율성과 일관성을 크게 향상시킵니다. 적절히 활용하면 성능과 코드의 간결성을 동시에 얻을 수 있습니다.