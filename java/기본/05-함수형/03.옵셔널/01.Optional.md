# 옵셔널 (Optional)

## Optional이란?
**null을 안전하게 다루기 위한 래퍼 클래스**. NullPointerException 방지.
```java
// 기존 방식
String name = person.getName();
if (name != null) {
    System.out.println(name.toUpperCase());
}

// Optional
Optional.ofNullable(person.getName())
    .map(String::toUpperCase)
    .ifPresent(System.out::println);
```

## 생성
```java
// 값이 있을 때 (null이면 NPE)
Optional<String> opt1 = Optional.of("hello");

// 값이 null일 수도 있을 때
Optional<String> opt2 = Optional.ofNullable(nullable);

// 빈 Optional
Optional<String> opt3 = Optional.empty();
```

## 값 확인 & 추출

| 메서드 | 설명 |
|--------|------|
| `isPresent()` | 값 존재 여부 |
| `isEmpty()` | 값 없음 여부 (Java 11+) |
| `get()` | 값 반환 (없으면 예외) ⚠️ |
| `orElse(T)` | 값 또는 기본값 |
| `orElseGet(Supplier)` | 값 또는 Supplier 결과 |
| `orElseThrow()` | 값 또는 예외 |
```java
// 값 추출
String value = opt.orElse("default");
String value = opt.orElseGet(() -> computeDefault());
String value = opt.orElseThrow(() -> new RuntimeException("없음"));
String value = opt.orElseThrow();  // NoSuchElementException
```

### orElse vs orElseGet
```java
// orElse: 항상 실행됨
opt.orElse(expensiveMethod());  // 값 있어도 메서드 호출!

// orElseGet: 값 없을 때만 실행
opt.orElseGet(() -> expensiveMethod());  // 값 있으면 호출 안함
```

## 조건부 실행
```java
// 값 있으면 실행
opt.ifPresent(v -> System.out.println(v));
opt.ifPresent(System.out::println);

// 값 있으면/없으면 (Java 9+)
opt.ifPresentOrElse(
    v -> System.out.println("값: " + v),
    () -> System.out.println("없음")
);
```

## 변환 & 필터링
```java
// map: 값 변환
Optional<Integer> length = opt.map(String::length);

// flatMap: Optional 반환 함수에 사용
Optional<String> result = opt.flatMap(this::findByName);
// findByName이 Optional<String> 반환할 때

// filter: 조건 검사
Optional<String> filtered = opt.filter(s -> s.length() > 3);
```

### map vs flatMap
```java
class Person {
    Optional<Address> getAddress() { ... }
}
class Address {
    String getCity() { ... }
}

// map 사용 시 중첩됨
Optional<Optional<Address>> nested = person.map(Person::getAddress);

// flatMap으로 평탄화
Optional<String> city = person
    .flatMap(Person::getAddress)
    .map(Address::getCity);
```

## 스트림 연동
```java
// Optional → Stream (Java 9+)
opt.stream().forEach(System.out::println);

// Stream에서 Optional 처리
List<String> names = people.stream()
    .map(Person::getName)       // Optional<String>
    .flatMap(Optional::stream)  // 값 있는 것만
    .collect(Collectors.toList());

// Java 8
List<String> names = people.stream()
    .map(Person::getName)
    .filter(Optional::isPresent)
    .map(Optional::get)
    .collect(Collectors.toList());
```

## or() 메서드 (Java 9+)
```java
// 값 없으면 다른 Optional 반환
Optional<String> result = opt
    .or(() -> findAlternative())
    .or(() -> Optional.of("최종 기본값"));
```

## 기본형 Optional
```java
OptionalInt optInt = OptionalInt.of(10);
OptionalLong optLong = OptionalLong.of(100L);
OptionalDouble optDouble = OptionalDouble.of(3.14);

int value = optInt.orElse(0);
optInt.ifPresent(System.out::println);
```

## 안티패턴 ⚠️
```java
// ❌ 나쁜 예
if (opt.isPresent()) {
    return opt.get();
}
return "default";

// ✅ 좋은 예
return opt.orElse("default");

// ❌ 나쁜 예
Optional<String> opt = Optional.of(value);
if (opt.isPresent()) { ... }

// ✅ 좋은 예 (null 체크로 충분)
if (value != null) { ... }
```

## 사용 지침

| 상황 | 사용 여부 |
|------|----------|
| 메서드 반환값 | ✅ 권장 |
| 메서드 매개변수 | ❌ 비권장 |
| 필드 타입 | ❌ 비권장 |
| 컬렉션 요소 | ❌ 비권장 |
| null 가능 반환값 | ✅ 권장 |

## 실전 예시
```java
// 체이닝으로 안전하게 접근
String cityName = user
    .flatMap(User::getAddress)
    .flatMap(Address::getCity)
    .map(City::getName)
    .orElse("Unknown");

// DB 조회 결과 처리
public Optional<User> findById(Long id) {
    return Optional.ofNullable(userRepository.findById(id));
}

User user = userService.findById(1L)
    .orElseThrow(() -> new UserNotFoundException(1L));
```