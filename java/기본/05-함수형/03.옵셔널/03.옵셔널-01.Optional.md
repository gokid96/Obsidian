# Optional

## Optional이란?
- **null을 감싸는 래퍼 클래스**
- NullPointerException 방지
- 값이 있을 수도, 없을 수도 있음을 명시
- Java 8+

---

## Optional 생성

### of() - 값이 있을 때
```java
Optional<String> opt = Optional.of("Hello");

// null 넣으면 NPE!
// Optional.of(null);  // NullPointerException
```

### ofNullable() - null 가능
```java
Optional<String> opt1 = Optional.ofNullable("Hello");  // 값 있음
Optional<String> opt2 = Optional.ofNullable(null);     // 빈 Optional
```

### empty() - 빈 Optional
```java
Optional<String> empty = Optional.empty();
```

---

## 값 확인

### isPresent() / isEmpty()
```java
Optional<String> opt = Optional.of("Hello");

if (opt.isPresent()) {
    System.out.println("값 있음: " + opt.get());
}

// Java 11+
if (opt.isEmpty()) {
    System.out.println("값 없음");
}
```

### ifPresent() - 값 있으면 실행
```java
Optional<String> opt = Optional.of("Hello");

opt.ifPresent(value -> System.out.println(value));
opt.ifPresent(System.out::println);
```

### ifPresentOrElse() - Java 9+
```java
opt.ifPresentOrElse(
    value -> System.out.println("값: " + value),
    () -> System.out.println("값 없음")
);
```

---

## 값 가져오기

### get() - 직접 추출 (위험)
```java
Optional<String> opt = Optional.of("Hello");
String value = opt.get();  // "Hello"

Optional<String> empty = Optional.empty();
// empty.get();  // NoSuchElementException!
```

### orElse() - 기본값
```java
String value = opt.orElse("기본값");

// 빈 Optional이면 기본값
String result = Optional.<String>empty().orElse("기본값");  // "기본값"
```

### orElseGet() - 지연 생성
```java
// 값 없을 때만 Supplier 실행
String value = opt.orElseGet(() -> createDefault());

// orElse vs orElseGet
opt.orElse(createDefault());       // 항상 실행됨!
opt.orElseGet(() -> createDefault()); // 필요할 때만 실행
```

### orElseThrow() - 예외 발생
```java
String value = opt.orElseThrow();  // NoSuchElementException

String value2 = opt.orElseThrow(
    () -> new IllegalArgumentException("값이 없습니다")
);
```

---

## 변환

### map() - 값 변환
```java
Optional<String> name = Optional.of("hello");

Optional<String> upper = name.map(String::toUpperCase);  // "HELLO"
Optional<Integer> length = name.map(String::length);     // 5

// 빈 Optional이면 빈 Optional 반환
Optional<String> empty = Optional.<String>empty().map(String::toUpperCase);
// Optional.empty()
```

### flatMap() - Optional 반환 함수
```java
Optional<String> name = Optional.of("hello");

// map은 Optional<Optional<T>> 가능성
Optional<Optional<Integer>> nested = name.map(s -> Optional.of(s.length()));

// flatMap은 평탄화
Optional<Integer> flat = name.flatMap(s -> Optional.of(s.length()));
```

### filter() - 조건 필터
```java
Optional<Integer> num = Optional.of(10);

Optional<Integer> positive = num.filter(n -> n > 0);   // 10
Optional<Integer> negative = num.filter(n -> n < 0);   // empty
```

---

## 체이닝

```java
Optional<String> result = Optional.of("  hello  ")
    .map(String::trim)
    .filter(s -> !s.isEmpty())
    .map(String::toUpperCase);

// "HELLO"
```

```java
// 사용자 이메일 도메인 추출
String domain = Optional.ofNullable(user)
    .map(User::getEmail)
    .filter(email -> email.contains("@"))
    .map(email -> email.substring(email.indexOf("@") + 1))
    .orElse("unknown");
```

---

## Optional 사용 패턴

### 반환 타입으로 사용 (권장)
```java
public Optional<User> findById(Long id) {
    User user = userRepository.get(id);
    return Optional.ofNullable(user);
}

// 사용
findById(1L)
    .map(User::getName)
    .ifPresent(System.out::println);
```

### null 체크 대체
```java
// 기존
if (user != null) {
    Address address = user.getAddress();
    if (address != null) {
        String city = address.getCity();
        if (city != null) {
            System.out.println(city);
        }
    }
}

// Optional
Optional.ofNullable(user)
    .map(User::getAddress)
    .map(Address::getCity)
    .ifPresent(System.out::println);
```

### 기본값 처리
```java
// 기존
String name = user.getName();
if (name == null) {
    name = "Unknown";
}

// Optional
String name = Optional.ofNullable(user.getName())
    .orElse("Unknown");
```

---

## 잘못된 사용

### 필드로 사용 (X)
```java
// 잘못된 사용
class User {
    private Optional<String> name;  // X
}

// 올바른 사용
class User {
    private String name;  // null 가능
}
```

### 매개변수로 사용 (X)
```java
// 잘못된 사용
public void process(Optional<String> opt) { }

// 올바른 사용
public void process(String value) { }  // null 가능
public void process(String value, String defaultValue) { }
```

### get() 바로 사용 (X)
```java
// 위험
String value = optional.get();

// 안전
String value = optional.orElse("default");
String value = optional.orElseThrow();
```

### isPresent() + get() (X)
```java
// 나쁜 패턴
if (opt.isPresent()) {
    String value = opt.get();
    System.out.println(value);
}

// 좋은 패턴
opt.ifPresent(System.out::println);
```

---

## 스트림과 함께

### Optional 결과
```java
Optional<String> first = list.stream()
    .filter(s -> s.startsWith("A"))
    .findFirst();

Optional<Integer> max = list.stream()
    .mapToInt(String::length)
    .max();
```

### Optional 스트림 (Java 9+)
```java
// Optional을 Stream으로
Optional<String> opt = Optional.of("Hello");
Stream<String> stream = opt.stream();  // Stream of 1 element

// 여러 Optional에서 값 있는 것만
List<Optional<String>> optionals = Arrays.asList(
    Optional.of("A"),
    Optional.empty(),
    Optional.of("B")
);

List<String> values = optionals.stream()
    .flatMap(Optional::stream)
    .collect(Collectors.toList());  // [A, B]
```

---

## or() - Java 9+

### 대안 Optional 제공
```java
Optional<String> opt1 = Optional.empty();
Optional<String> opt2 = Optional.of("backup");

Optional<String> result = opt1.or(() -> opt2);  // "backup"
```

---

## 실전 예제

### 설정값 읽기
```java
public String getConfig(String key) {
    return Optional.ofNullable(configMap.get(key))
        .orElseGet(() -> defaultConfigMap.get(key));
}
```

### 안전한 문자열 처리
```java
public int safeLength(String str) {
    return Optional.ofNullable(str)
        .map(String::length)
        .orElse(0);
}
```

### 연쇄 null 체크
```java
public String getCompanyName(Employee emp) {
    return Optional.ofNullable(emp)
        .map(Employee::getDepartment)
        .map(Department::getCompany)
        .map(Company::getName)
        .orElse("Unknown");
}
```

### 조건부 실행
```java
Optional.ofNullable(user)
    .filter(User::isActive)
    .filter(u -> u.getAge() >= 18)
    .ifPresent(u -> sendEmail(u.getEmail()));
```

---

> [!tip] 핵심 정리
> - **Optional.of()**: null 불가
> - **Optional.ofNullable()**: null 허용
> - **orElse()**: 기본값 (항상 평가)
> - **orElseGet()**: 기본값 (지연 평가)
> - **map()**: 값 변환
> - **filter()**: 조건 필터
> - 반환 타입으로 사용 O, 필드/매개변수 X
> - get() 직접 호출 피하기

---

#Java #Optional #Null처리 #함수형프로그래밍
