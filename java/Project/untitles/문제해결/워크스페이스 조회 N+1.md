### 1. 문제 정의

사용자의 워크스페이스 목록 조회 시, `WorkspaceMember`를 먼저 조회한 후 각 멤버의 `Workspace` 정보를 가져오는 과정에서 워크스페이스 개수만큼 추가 쿼리가 발생하여 성능 저하

|상황|쿼리 수|
|---|---|
|워크스페이스 10개|1 + 10 = 11번|
|워크스페이스 100개|1 + 100 = 101번|

---

### 2. 원인 분석

`WorkspaceMember` 엔티티에서 `workspace` 필드가 Lazy Loading으로 설정되어 프록시 객체로 생성됨


```java
@ManyToOne(fetch = FetchType.LAZY)
private Workspace workspace;  // 프록시 객체 (ID만 있음)
```

`getMyWorkspaces()`에서 `WorkspaceMember` 목록을 조회한 후, stream으로 `WorkspaceResponse`를 생성하는 과정에서 `member.getWorkspace()` 호출 시마다 프록시 객체가 실제 DB를 조회함

```java
return memberRepository.findAllByUser(user).stream()  // 1번 쿼리: WorkspaceMember 목록
        .map(member -> WorkspaceResponse.from(
                member.getWorkspace(),  // N번 쿼리: 프록시 → DB 조회
                member.getRole()
        ))
        .toList();
```

---

### 3. 해결 방안

Fetch Join으로 `WorkspaceMember` 조회 시 연관된 `Workspace`와 `members`를 한 번에 조회하는 JPQL 작성

```java
@Query("SELECT m FROM WorkspaceMember m " +
       "JOIN FETCH m.workspace w " +
       "JOIN FETCH w.members " +
       "WHERE m.user = :user")
List<WorkspaceMember> findAllByUserWithWorkspaceAndMembers(@Param("user") Users user);
```

---

### 4. 적용 및 검증

**WorkspaceMemberRepository.java**

```java
@Query("SELECT m FROM WorkspaceMember m " +
       "JOIN FETCH m.workspace w " +
       "JOIN FETCH w.members " +
       "WHERE m.user = :user")
List<WorkspaceMember> findAllByUserWithWorkspaceAndMembers(@Param("user") Users user);
```

**WorkspaceService.java**

```java
public List<WorkspaceResponse> getMyWorkspaces(Long userId) {
    Users user = userRepository.findById(userId)
            .orElseThrow(() -> new IllegalArgumentException("사용자를 찾을 수 없습니다."));

    return memberRepository.findAllByUserWithWorkspaceAndMembers(user).stream()
            .map(member -> WorkspaceResponse.from(
                    member.getWorkspace(),  // 이미 조회됨, 추가 쿼리 없음
                    member.getRole()
            ))
            .toList();
}
```

**검증: 쿼리 로그**

Before (N+1)

```sql
SELECT * FROM workspace_member WHERE user_id = ?;
SELECT * FROM workspace WHERE workspace_id = ?;
SELECT * FROM workspace WHERE workspace_id = ?;
SELECT * FROM workspace WHERE workspace_id = ?;
```

After (Fetch Join)
```sql
SELECT m.*, w.*, wm.* 
FROM workspace_member m
JOIN workspace w ON m.workspace_id = w.workspace_id
JOIN workspace_member wm ON w.workspace_id = wm.workspace_id
WHERE m.user_id = ?;
```

→ **1번 쿼리로 해결**