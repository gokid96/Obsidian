### 1. 문제 정의

워크스페이스의 폴더 트리 조회 시, 루트 폴더를 조회한 후 각 폴더의 `children`을 가져오는 과정에서 폴더 개수만큼 추가 쿼리가 발생하여 성능 저하

| 상황      | 쿼리 수           |
| ------- | -------------- |
| 폴더 10개  | 1 + 10 = 11번   |
| 폴더 100개 | 1 + 100 = 101번 |

**실제 로그**: 167ms 소요, `[SLOW SERVICE]` 경고 발생

---

### 2. 원인 분석

`Folder` 엔티티에서 `children` 필드가 Lazy Loading으로 설정되어 프록시 객체로 생성됨


```java
@OneToMany(mappedBy = "parent", cascade = CascadeType.ALL, orphanRemoval = true)
private List<Folder> children = new ArrayList<>();  // 프록시 (접근 시 쿼리 발생)
```

`FolderResponseDTO.from()`에서 `folder.getChildren()` 호출 시마다 프록시 객체가 실제 DB를 조회함

```java
public static FolderResponseDTO from(Folder folder) {
    return FolderResponseDTO.builder()
            .children(folder.getChildren().stream()  // N번 쿼리 발생
                    .map(FolderResponseDTO::from)    // 재귀적으로 또 발생
                    .collect(Collectors.toList()))
            .build();
}
```

---

### 3. 해결 방안

**전체 폴더를 한 번에 조회 후 메모리에서 트리 구조 조립**

1. 워크스페이스의 모든 폴더를 1번 쿼리로 조회
2. Map에 DTO 저장 (폴더ID → DTO)
3. 순회하면서 부모-자식 관계 연결
4. 루트 폴더만 필터링하여 반환

---

### 4. 적용 및 검증

**FolderService.java**

```java
public List<FolderResponseDTO> getRootFolders(Long userId, Long workspaceId) {
    getMemberOrThrow(userId, workspaceId);

    // 1. 워크스페이스의 모든 폴더를 한 번에 조회 (쿼리 1번)
    List<Folder> allFolders = folderRepository.findAllByWorkspaceWorkspaceId(workspaceId);

    // 2. Map 생성: 폴더ID → DTO (children은 빈 리스트로 초기화)
    Map<Long, FolderResponseDTO> dtoMap = allFolders.stream()
            .collect(Collectors.toMap(
                    Folder::getFolderId,
                    FolderResponseDTO::fromSimple
            ));

    // 3. 부모-자식 관계 연결
    for (Folder folder : allFolders) {
        if (folder.getParent() != null) {
            FolderResponseDTO parent = dtoMap.get(folder.getParent().getFolderId());
            FolderResponseDTO child = dtoMap.get(folder.getFolderId());
            if (parent != null) {
                parent.getChildren().add(child);
            }
        }
    }

    // 4. 루트 폴더만 반환 (children에 하위 폴더들이 이미 연결되어 있음)
    return allFolders.stream()
            .filter(f -> f.getParent() == null)
            .map(f -> dtoMap.get(f.getFolderId()))
            .toList();
}
```

**검증: 쿼리 로그**

Before (N+1)

```sql
SELECT * FROM folder WHERE workspace_id = ? AND parent_id IS NULL;
SELECT * FROM folder WHERE parent_id = ?;
SELECT * FROM folder WHERE parent_id = ?;
SELECT * FROM folder WHERE parent_id = ?;
-- ... 폴더 개수만큼 반복
```

After (메모리 조립)

```sql
SELECT * FROM folder WHERE workspace_id = ?;
```

→ **1번 쿼리로 해결**

|항목|수정 전|수정 후|
|---|---|---|
|응답 시간|167ms|84ms|
|쿼리 수|10번+|1번|
|경고|`[SLOW SERVICE]`|없음|
