# 

## 1. 전체 시스템 구조도

```
┌─────────────────────────────────────────────────────────────────┐
│                         클라이언트 레이어                          │
├─────────────────────────────────────────────────────────────────┤
│  ┌──────────────┐              ┌──────────────┐                 │
│  │  아동 앱      │              │  부모 앱      │                 │
│  │ (React Native)│              │(React Native) │                 │
│  └──────┬───────┘              └──────┬────────┘                 │
│         │                              │                          │
│         └──────────────┬───────────────┘                          │
└────────────────────────┼──────────────────────────────────────────┘
                         │ HTTPS
                         │
┌────────────────────────┼──────────────────────────────────────────┐
│                  API Gateway (AWS API Gateway)                    │
│                     - 인증/인가 (JWT)                              │
│                     - Rate Limiting                               │
│                     - 로깅                                         │
└────────────────────────┼──────────────────────────────────────────┘
                         │
        ┌────────────────┼────────────────┐
        │                │                │
┌───────▼────────┐ ┌────▼──────┐ ┌──────▼─────┐
│  인증 서비스    │ │ 사용자     │ │ 거래        │
│  Auth Service  │ │ Service    │ │ Service    │
│  (Node.js)     │ │(Node.js)   │ │(Node.js)   │
└───────┬────────┘ └────┬───────┘ └──────┬─────┘
        │               │                │
┌───────▼────────┐ ┌────▼──────┐ ┌──────▼─────┐
│  교육 서비스    │ │ 미션/레벨  │ │ 용돈        │
│  Education     │ │ Gamification│ │ Payment    │
│  (Node.js)     │ │(Node.js)   │ │(Node.js)   │
└───────┬────────┘ └────┬───────┘ └──────┬─────┘
        │               │                │
        └───────────────┼────────────────┘
                        │
┌───────────────────────┼──────────────────────────────┐
│                  메시지 큐 (RabbitMQ)                  │
│              - 비동기 작업 처리                         │
│              - 이벤트 기반 통신                         │
└───────────────────────┼──────────────────────────────┘
                        │
        ┌───────────────┼───────────────┐
        │               │               │
┌───────▼────────┐ ┌───▼────────┐ ┌───▼────────┐
│   PostgreSQL   │ │   Redis     │ │    S3      │
│  (사용자 DB)    │ │  (캐시)     │ │ (미디어)    │
└────────────────┘ └─────────────┘ └────────────┘
                        │
                ┌───────┼───────┐
                │               │
        ┌───────▼────────┐ ┌───▼────────────┐
        │  외부 API       │ │  알림 서비스    │
        │ - 주식 시세     │ │   (FCM)        │
        │ - 결제(토스)    │ └────────────────┘
        └─────────────────┘
```

---

## 2. 마이크로서비스 구성

### 2.1 Auth Service (인증 서비스)

**책임**:

- 회원가입 / 로그인
- JWT 토큰 발급 및 검증
- 부모-자녀 계정 연동
- 소셜 로그인 (카카오, 네이버)

**기술 스택**:

- Node.js + Express
- JWT
- bcrypt (비밀번호 암호화)

**DB 테이블**:

- users (사용자 정보)
- user_roles (역할: 아동/부모)
- family_relations (가족 관계)

---

### 2.2 User Service (사용자 서비스)

**책임**:

- 사용자 프로필 관리
- 레벨/경험치 관리
- 친구 관계 관리
- 활동 내역 조회

**DB 테이블**:

- user_profiles
- user_levels
- friendships
- activity_logs

---

### 2.3 Trading Service (거래 서비스)

**책임**:

- 모의 주식 매수/매도
- 포트폴리오 관리
- 수익률 계산
- 거래 내역 관리

**주요 API**:

```javascript
POST   /api/trading/orders          // 주문 생성
GET    /api/trading/portfolio       // 포트폴리오 조회
GET    /api/trading/orders/:id      // 주문 상세
DELETE /api/trading/orders/:id      // 주문 취소
GET    /api/trading/history          // 거래 내역
```

**DB 테이블**:

- portfolios (포트폴리오)
- orders (주문 내역)
- holdings (보유 종목)
- virtual_money (가상 자금)

**핵심 로직**:

```javascript
// 매수 로직
async function buyStock(userId, stockCode, quantity, price) {
  // 1. 가상머니 잔액 확인
  const balance = await getVirtualMoney(userId);
  const totalCost = quantity * price;
  
  if (balance < totalCost) {
    throw new Error('잔액 부족');
  }
  
  // 2. 주문 생성
  const order = await createOrder({
    userId,
    stockCode,
    quantity,
    price,
    type: 'BUY'
  });
  
  // 3. 가상머니 차감
  await deductVirtualMoney(userId, totalCost);
  
  // 4. 포트폴리오 업데이트
  await updatePortfolio(userId, stockCode, quantity);
  
  // 5. 이벤트 발행 (미션 체크용)
  await publishEvent('STOCK_PURCHASED', { userId, stockCode });
  
  return order;
}
```

---

### 2.4 Market Data Service (시세 서비스)

**책임**:

- 실시간 주식 시세 조회
- 차트 데이터 제공
- 종목 검색
- 뉴스 크롤링

**데이터 흐름**:

```
한국거래소 API → Market Data Service → Redis 캐싱 → 클라이언트
         (1분마다)              (15분 TTL)
```

**Redis 캐싱 전략**:

```javascript
// 시세 데이터 캐싱
const stockPrice = await redis.get(`stock:${stockCode}:price`);
if (!stockPrice) {
  const price = await fetchFromExternalAPI(stockCode);
  await redis.setex(`stock:${stockCode}:price`, 60, price); // 1분 TTL
  return price;
}
return stockPrice;
```

**주요 API**:

```javascript
GET /api/market/stocks/:code        // 종목 상세
GET /api/market/stocks/:code/chart  // 차트 데이터
GET /api/market/search?q=삼성       // 종목 검색
GET /api/market/news                // 경제 뉴스
```

---

### 2.5 Gamification Service (게임화 서비스)

**책임**:

- 레벨/경험치 관리
- 뱃지 시스템
- 일일/주간 미션
- 리더보드

**이벤트 기반 처리**:

```javascript
// 미션 달성 체크
eventBus.on('STOCK_PURCHASED', async (event) => {
  const { userId, stockCode } = event;
  
  // "첫 주식 매수" 미션 체크
  const isFirstPurchase = await checkFirstPurchase(userId);
  if (isFirstPurchase) {
    await awardBadge(userId, 'FIRST_PURCHASE');
    await addExperience(userId, 100);
  }
  
  // 일일 미션 "1개 종목 매수" 체크
  await updateDailyMission(userId, 'BUY_ONE_STOCK');
});
```

**DB 테이블**:

- user_levels
- badges
- user_badges
- missions
- mission_progress

---

### 2.6 Payment Service (용돈 서비스)

**책임**:

- 용돈 목표 설정
- 용돈 요청 처리
- 실제 송금 (토스페이먼츠 연동)
- 거래 내역 관리

**용돈 요청 플로우**:

```javascript
// 1. 아이가 용돈 요청
async function requestAllowance(childId, goalId) {
  // 목표 달성 여부 확인
  const goal = await getGoal(goalId);
  const portfolio = await getPortfolio(childId);
  
  if (portfolio.returnRate < goal.targetRate) {
    throw new Error('목표 수익률 미달성');
  }
  
  // 요청 생성
  const request = await createAllowanceRequest({
    childId,
    goalId,
    amount: goal.rewardAmount,
    status: 'PENDING'
  });
  
  // 부모에게 푸시 알림
  await sendPushNotification(goal.parentId, {
    title: '용돈 요청',
    body: '자녀가 목표를 달성했어요! 용돈을 보내주세요.'
  });
  
  return request;
}

// 2. 부모가 승인
async function approveAllowance(requestId, parentId) {
  const request = await getAllowanceRequest(requestId);
  
  // 권한 확인
  if (request.parentId !== parentId) {
    throw new Error('권한 없음');
  }
  
  // 토스페이먼츠 송금 API 호출
  const payment = await transferMoney({
    from: parentId,
    to: request.childId,
    amount: request.amount
  });
  
  // 상태 업데이트
  await updateRequestStatus(requestId, 'APPROVED');
  
  // 자녀에게 알림
  await sendPushNotification(request.childId, {
    title: '용돈 도착!',
    body: `${request.amount}원이 입금되었어요!`
  });
  
  return payment;
}
```

**DB 테이블**:

- allowance_goals (목표 설정)
- allowance_requests (요청)
- payment_transactions (송금 내역)

---

### 2.7 Education Service (교육 서비스)

**책임**:

- 교육 콘텐츠 관리
- 학습 진도 추적
- 퀴즈 채점
- 수료증 발급

**DB 테이블**:

- courses (강좌)
- lessons (강의)
- user_progress (진도)
- quiz_results (퀴즈 결과)

---

### 2.8 Community Service (커뮤니티 서비스)

**책임**:

- 게시글/댓글 관리
- 신고 처리
- 리그전 운영
- 랭킹 시스템

**안전 기능**:

```javascript
// 욕설 필터링
async function createPost(userId, content) {
  // 1. 욕설 필터링
  const filtered = await filterBadWords(content);
  
  // 2. AI 유해성 검사
  const toxicity = await checkToxicity(filtered);
  if (toxicity > 0.7) {
    throw new Error('부적절한 내용이 포함되어 있습니다');
  }
  
  // 3. 게시글 생성
  const post = await createPostInDB({
    userId,
    content: filtered,
    status: 'PUBLISHED'
  });
  
  return post;
}
```

---

## 3. 데이터베이스 설계

### 3.1 PostgreSQL 주요 테이블

```sql
-- 사용자
CREATE TABLE users (
  id UUID PRIMARY KEY,
  email VARCHAR(255) UNIQUE,
  password_hash VARCHAR(255),
  role VARCHAR(20), -- 'CHILD' or 'PARENT'
  created_at TIMESTAMP DEFAULT NOW()
);

-- 프로필
CREATE TABLE user_profiles (
  user_id UUID PRIMARY KEY REFERENCES users(id),
  nickname VARCHAR(50),
  birth_date DATE,
  level INT DEFAULT 1,
  experience INT DEFAULT 0,
  virtual_money BIGINT DEFAULT 1000000
);

-- 가족 관계
CREATE TABLE family_relations (
  id UUID PRIMARY KEY,
  parent_id UUID REFERENCES users(id),
  child_id UUID REFERENCES users(id),
  created_at TIMESTAMP DEFAULT NOW()
);

-- 포트폴리오
CREATE TABLE portfolios (
  id UUID PRIMARY KEY,
  user_id UUID REFERENCES users(id),
  total_value BIGINT,
  total_cost BIGINT,
  return_rate DECIMAL(10,2),
  updated_at TIMESTAMP DEFAULT NOW()
);

-- 보유 종목
CREATE TABLE holdings (
  id UUID PRIMARY KEY,
  portfolio_id UUID REFERENCES portfolios(id),
  stock_code VARCHAR(10),
  stock_name VARCHAR(100),
  quantity INT,
  avg_price BIGINT,
  current_price BIGINT,
  profit_loss BIGINT,
  return_rate DECIMAL(10,2)
);

-- 주문
CREATE TABLE orders (
  id UUID PRIMARY KEY,
  user_id UUID REFERENCES users(id),
  stock_code VARCHAR(10),
  order_type VARCHAR(10), -- 'BUY' or 'SELL'
  quantity INT,
  price BIGINT,
  status VARCHAR(20), -- 'PENDING', 'COMPLETED', 'CANCELLED'
  created_at TIMESTAMP DEFAULT NOW()
);

-- 미션
CREATE TABLE missions (
  id UUID PRIMARY KEY,
  type VARCHAR(20), -- 'DAILY', 'WEEKLY', 'SPECIAL'
  title VARCHAR(100),
  description TEXT,
  reward_money INT,
  reward_exp INT
);

-- 사용자 미션 진행
CREATE TABLE mission_progress (
  id UUID PRIMARY KEY,
  user_id UUID REFERENCES users(id),
  mission_id UUID REFERENCES missions(id),
  progress INT DEFAULT 0,
  target INT,
  completed BOOLEAN DEFAULT FALSE,
  completed_at TIMESTAMP
);

-- 뱃지
CREATE TABLE badges (
  id UUID PRIMARY KEY,
  name VARCHAR(100),
  description TEXT,
  image_url VARCHAR(255),
  requirement_type VARCHAR(50)
);

-- 사용자 뱃지
CREATE TABLE user_badges (
  id UUID PRIMARY KEY,
  user_id UUID REFERENCES users(id),
  badge_id UUID REFERENCES badges(id),
  earned_at TIMESTAMP DEFAULT NOW()
);

-- 용돈 목표
CREATE TABLE allowance_goals (
  id UUID PRIMARY KEY,
  parent_id UUID REFERENCES users(id),
  child_id UUID REFERENCES users(id),
  target_rate DECIMAL(10,2),
  reward_amount INT,
  monthly_limit INT,
  max_requests_per_month INT
);

-- 용돈 요청
CREATE TABLE allowance_requests (
  id UUID PRIMARY KEY,
  child_id UUID REFERENCES users(id),
  parent_id UUID REFERENCES users(id),
  goal_id UUID REFERENCES allowance_goals(id),
  amount INT,
  status VARCHAR(20), -- 'PENDING', 'APPROVED', 'REJECTED'
  requested_at TIMESTAMP DEFAULT NOW(),
  responded_at TIMESTAMP
);
```

### 3.2 Redis 캐시 구조

```
# 주식 시세 (1분 TTL)
stock:{종목코드}:price → "50000"
stock:{종목코드}:change → "+2.5"

# 사용자 세션 (1시간 TTL)
session:{userId} → {토큰, 권한 정보}

# 실시간 랭킹 (Sorted Set)
ranking:weekly → {userId: score}

# 일일 미션 진행 (하루 TTL)
mission:{userId}:daily → {미션ID: 진행률}

# 최근 접속자 (Set)
online:users → {userId1, userId2, ...}
```

---

## 4. API 설계

### 4.1 RESTful API 구조

```
Base URL: https://api.stockkingkids.com/v1

# 인증
POST   /auth/signup          # 회원가입
POST   /auth/login           # 로그인
POST   /auth/refresh         # 토큰 갱신
POST   /auth/link-family     # 가족 연동

# 사용자
GET    /users/me             # 내 정보
PUT    /users/me             # 정보 수정
GET    /users/:id/profile    # 프로필 조회

# 거래
POST   /trading/orders       # 주문
GET    /trading/portfolio    # 포트폴리오
GET    /trading/holdings     # 보유 종목
GET    /trading/history      # 거래 내역

# 시세
GET    /market/stocks/:code  # 종목 상세
GET    /market/stocks/search # 종목 검색
GET    /market/news          # 경제 뉴스

# 미션/레벨
GET    /gamification/missions/daily    # 일일 미션
GET    /gamification/badges            # 뱃지 목록
POST   /gamification/missions/:id/claim # 보상 수령

# 용돈
POST   /allowance/goals      # 목표 설정
POST   /allowance/requests   # 용돈 요청
PUT    /allowance/requests/:id/approve  # 승인
GET    /allowance/history    # 내역

# 교육
GET    /education/courses    # 강좌 목록
GET    /education/lessons/:id # 강의 상세
POST   /education/quiz       # 퀴즈 제출

# 커뮤니티
GET    /community/posts      # 게시글 목록
POST   /community/posts      # 게시글 작성
POST   /community/posts/:id/report # 신고
```

---

## 5. 보안 아키텍처

### 5.1 인증/인가

```
클라이언트 → API Gateway → JWT 검증 → 서비스

# JWT 페이로드
{
  "userId": "uuid",
  "role": "CHILD" or "PARENT",
  "exp": "만료시간"
}
```

### 5.2 민감 데이터 처리

- 비밀번호: bcrypt 암호화
- 개인정보: AES-256 암호화
- 결제 정보: PCI-DSS 준수
- HTTPS 필수

### 5.3 Rate Limiting

```javascript
// API Gateway에서 처리
{
  "/api/trading/orders": "10 req/min", // 거래는 느슨하게
  "/api/auth/login": "5 req/min",      // 로그인 제한
  "/api/market/stocks": "100 req/min"  // 조회는 여유있게
}
```

---

## 6. 확장성 고려사항

### 6.1 수평 확장

- 모든 서비스는 Stateless 설계
- 로드 밸런서(ALB) 사용
- Auto Scaling 적용

### 6.2 DB 샤딩 전략 (향후)

```
사용자 ID 기반 샤딩
- 사용자 100만 명 이상 시 고려
- Hash 기반 샤딩: userId % N
```

### 6.3 캐싱 전략

```
3단계 캐싱:
1. 클라이언트 캐시 (앱 내부)
2. CDN 캐시 (정적 자산)
3. Redis 캐시 (API 레벨)
```

---

## 7. 모니터링 및 로깅

### 7.1 모니터링

- **APM**: New Relic 또는 DataDog
- **Error Tracking**: Sentry
- **Logs**: AWS CloudWatch

### 7.2 주요 메트릭

```
- API 응답 시간 (< 500ms)
- 에러율 (< 1%)
- 트랜잭션 성공률 (> 99%)
- 동시 접속자 수
- 일일 활성 사용자 (DAU)
```

---

## 8. 배포 전략

### 8.1 CI/CD 파이프라인

```
GitHub Push → GitHub Actions → 테스트 → 빌드 → ECR → ECS 배포
```

### 8.2 Blue-Green 배포

```
- 무중단 배포
- 문제 발생 시 즉시 롤백
```

---

## 9. 비용 예측 (월간)

|항목|비용|
|---|---|
|AWS EC2 (t3.medium x 3)|약 20만 원|
|AWS RDS (db.t3.medium)|약 15만 원|
|AWS ElastiCache (Redis)|약 10만 원|
|AWS S3 + CloudFront|약 5만 원|
|주식 API 라이선스|약 50만 원|
|**총 예상 비용**|**약 100만 원**|

---

## 10. 다음 단계

1. ✅ 기술 스택 확정
2. ✅ DB 스키마 상세 설계
3. ✅ API 명세서 작성
4. ⏳ 프로토타입 개발 시작
5. ⏳ 외부 API 연동 테스트

---

이 아키텍처는 **초기 10만 명 사용자**를 목표로 설계되었으며, 향후 확장 가능하도록 마이크로서비스 패턴을 적용했습니다.