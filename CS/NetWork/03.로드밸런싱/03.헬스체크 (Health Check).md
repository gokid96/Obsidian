
## 필요성

- 장애 서버로 트래픽 보내면 안 됨
- 자동으로 장애 감지 및 제외

## 종류

### TCP Health Check

```
LB → Server:Port 연결 시도
성공: Healthy
실패: Unhealthy
```

### HTTP Health Check

```
LB → GET /health HTTP/1.1
200 OK: Healthy
5xx or timeout: Unhealthy
```

## 주요 설정값

|설정|설명|예시|
|---|---|---|
|interval|체크 주기|5초|
|timeout|응답 대기 시간|3초|
|healthy_threshold|정상 판정 횟수|2회 연속 성공|
|unhealthy_threshold|비정상 판정 횟수|3회 연속 실패|

## 헬스체크 엔드포인트 구현 예시 (Spring Boot)

```java
@RestController
public class HealthController {
    
    @GetMapping("/health")
    public ResponseEntity<String> health() {
        // DB 연결, 필수 서비스 체크 등
        if (isHealthy()) {
            return ResponseEntity.ok("OK");
        }
        return ResponseEntity.status(503).body("Service Unavailable");
    }
}
```

## 세션 유지 (Session Persistence / Sticky Session)

### 필요한 경우

- 로그인 세션이 서버 메모리에 저장될 때
- WebSocket 연결 유지

### 방법

1. **Cookie 기반**: L7에서 쿠키로 서버 식별
2. **IP Hash**: 클라이언트 IP로 서버 고정
3. **Session Replication**: 서버 간 세션 공유 (Redis 등)

### 권장 방식

세션을 Redis/DB에 저장하여 Stateless 구조로 만들기 → Sticky Session 불필요, 어떤 서버로 가도 OK

## Nginx 설정 예시

```nginx
upstream backend {
    least_conn;
    server 10.0.0.1:8080 weight=3;
    server 10.0.0.2:8080 weight=3;
    server 10.0.0.3:8080 weight=2;
}

server {
    location /api {
        proxy_pass http://backend;
        proxy_connect_timeout 3s;
        proxy_read_timeout 30s;
    }
}
```

## HAProxy 설정 예시

```haproxy
frontend http_front
    bind *:80
    default_backend http_back

backend http_back
    balance roundrobin
    option httpchk GET /health
    server web1 10.0.0.1:8080 check
    server web2 10.0.0.2:8080 check
    server web3 10.0.0.3:8080 check backup
```