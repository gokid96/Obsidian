
```
═══════════════════════════════════════════════════════════════════════════════
                              1단계: 대기열 진입
═══════════════════════════════════════════════════════════════════════════════

[사용자]                          [서버]                           [Redis]
    │                               │                                │
    │  예매 페이지 클릭               │                                │
    │ ─────────────────────────────▶│                                │
    │                               │  ZADD queue:event1 {시각} user1 │
    │                               │───────────────────────────────▶│
    │                               │                                │
    │                               │◀───────────────────────────────│
    │  "대기번호 3,847번"             │                                │
    │  + JavaScript 폴링 코드        │                                │
    │◀─────────────────────────────│                                │
    │                               │                                │


═══════════════════════════════════════════════════════════════════════════════
                              2단계: 대기 중 (폴링)
═══════════════════════════════════════════════════════════════════════════════

[사용자 브라우저]                  [서버]                           [Redis]
    │                               │                                │
    │  JavaScript 실행 중            │                                │
    │  while(true) {                │                                │
    │                               │                                │
    │    2초마다 "나 몇 번?"          │                                │
    │ ─────────────────────────────▶│  ZRANK queue:event1 user1      │
    │                               │───────────────────────────────▶│
    │                               │◀───── 3,512번 ─────────────────│
    │◀── "3,512번, 아직 대기" ───────│                                │
    │                               │                                │
    │    화면에 순번 표시             │                                │
    │    sleep(2초)                 │                                │
    │  }                            │                                │
    │                               │                                │


═══════════════════════════════════════════════════════════════════════════════
                         3단계: 스케줄러가 입장 처리 (백그라운드)
═══════════════════════════════════════════════════════════════════════════════

                                [스케줄러]                         [Redis]
                                    │                                │
                              (1초마다 실행)                          │
                                    │                                │
                                    │  현재 활성 사용자 몇 명?          │
                                    │  SCARD active:event1            │
                                    │───────────────────────────────▶│
                                    │◀───── 800명 ───────────────────│
                                    │                                │
                                    │  200명 더 입장 가능              │
                                    │  ZRANGE queue:event1 0 199     │
                                    │───────────────────────────────▶│
                                    │◀───── [user1, user2, ...] ─────│
                                    │                                │
                                    │  대기열에서 제거                 │
                                    │  ZREM queue:event1 user1       │
                                    │───────────────────────────────▶│
                                    │                                │
                                    │  활성 사용자로 등록              │
                                    │  SADD active:event1 user1      │
                                    │───────────────────────────────▶│
                                    │                                │
                                    │  입장 토큰 발급                  │
                                    │  SET entry:user1 {토큰} EX 600  │
                                    │───────────────────────────────▶│
                                    │                                │


═══════════════════════════════════════════════════════════════════════════════
                              4단계: 입장 허용
═══════════════════════════════════════════════════════════════════════════════

[사용자 브라우저]                  [서버]                           [Redis]
    │                               │                                │
    │  (폴링 계속 중)                │                                │
    │  "나 몇 번?"                   │                                │
    │ ─────────────────────────────▶│  GET entry:user1               │
    │                               │───────────────────────────────▶│
    │                               │◀───── 토큰 있음! ──────────────│
    │◀── "입장 가능! 토큰: abc123" ──│                                │
    │                               │                                │
    │  예매 페이지로 이동             │                                │
    │  location.href = '/booking'   │                                │
    │                               │                                │


═══════════════════════════════════════════════════════════════════════════════
                              5단계: 좌석 조회
═══════════════════════════════════════════════════════════════════════════════

[사용자]                          [서버]                           [Redis]
    │                               │                                │
    │  좌석 현황 요청                 │                                │
    │  (토큰: abc123)               │                                │
    │ ─────────────────────────────▶│                                │
    │                               │  토큰 검증                      │
    │                               │  GET entry:user1               │
    │                               │───────────────────────────────▶│
    │                               │◀───── abc123 (일치!) ──────────│
    │                               │                                │
    │                               │  좌석 현황 조회                  │
    │                               │  HGETALL seats:event1          │
    │                               │───────────────────────────────▶│
    │                               │◀───── {A1:선점, A2:빈, ...} ───│
    │                               │                                │
    │◀── 좌석 배치도 (빈자리 표시) ───│                                │
    │                               │                                │


═══════════════════════════════════════════════════════════════════════════════
                              6단계: 좌석 선점 (Lua 스크립트)
═══════════════════════════════════════════════════════════════════════════════

[사용자]                          [서버]                           [Redis]
    │                               │                                │
    │  "A-15 좌석 선택"              │                                │
    │ ─────────────────────────────▶│                                │
    │                               │  Lua 스크립트 실행 요청          │
    │                               │  EVAL "                        │
    │                               │    local holder = GET(seat)    │
    │                               │    if holder then return FAIL  │
    │                               │    SET seat user1 EX 600       │
    │                               │    return OK                   │
    │                               │  "                             │
    │                               │───────────────────────────────▶│
    │                               │                                │
    │                               │         [Redis 내부]            │
    │                               │         Lua 실행 (원자적)       │
    │                               │         다른 요청 블록됨         │
    │                               │                                │
    │                               │◀───── OK (선점 성공) ──────────│
    │◀── "좌석 선점 완료, 10분 내 결제" │                               │
    │                               │                                │

    ※ 동시에 다른 사용자가 같은 좌석 선택하면?
    
[사용자2]                         [서버]                           [Redis]
    │  "A-15 좌석 선택"              │                                │
    │ ─────────────────────────────▶│  EVAL Lua...                   │
    │                               │───────────────────────────────▶│
    │                               │◀───── FAIL (이미 선점됨) ───────│
    │◀── "이미 선택된 좌석입니다"     │                                │


═══════════════════════════════════════════════════════════════════════════════
                              7단계: 결제
═══════════════════════════════════════════════════════════════════════════════

[사용자]                          [서버]                      [PG사]
    │                               │                           │
    │  결제 요청                     │                           │
    │ ─────────────────────────────▶│  결제 요청                 │
    │                               │─────────────────────────▶│
    │                               │◀───── 결제 성공 ──────────│
    │                               │                           │
    │◀── 결제 완료 ─────────────────│                           │


═══════════════════════════════════════════════════════════════════════════════
                              8단계: 예매 확정 → Kafka → DB
═══════════════════════════════════════════════════════════════════════════════

[서버]                           [Kafka]                    [Worker]         [DB]
    │                               │                           │              │
    │  예매 이벤트 발행              │                           │              │
    │  {user1, A-15, 결제완료}       │                           │              │
    │ ─────────────────────────────▶│                           │              │
    │                               │  메시지 저장               │              │
    │                               │─────────────────────────▶│              │
    │                               │                           │  INSERT      │
    │                               │                           │  booking     │
    │                               │                           │─────────────▶│
    │                               │                           │              │
    │                               │                           │  UPDATE      │
    │                               │                           │  seat 상태   │
    │                               │                           │─────────────▶│
    │                               │                           │              │

[서버]                                                        [Redis]
    │                                                            │
    │  임시 선점 → 확정으로 변경                                   │
    │  DEL seat:event1:A-15                                      │
    │  SET confirmed:event1:A-15 user1                           │
    │───────────────────────────────────────────────────────────▶│
    │                                                            │
    │  활성 사용자에서 제거                                        │
    │  SREM active:event1 user1                                  │
    │───────────────────────────────────────────────────────────▶│


═══════════════════════════════════════════════════════════════════════════════
                              9단계: 완료
═══════════════════════════════════════════════════════════════════════════════

[사용자]                          [서버]
    │                               │
    │◀── "예매 완료! 티켓 번호: T-12345" │
    │                               │
    │  끝!                          │


═══════════════════════════════════════════════════════════════════════════════
                         (예외) 10분 내 결제 안 하면?
═══════════════════════════════════════════════════════════════════════════════

                                                              [Redis]
                                                                 │
    10분 경과                                                     │
                                                                 │
    SET seat:event1:A-15 user1 EX 600  ←── 이게 만료됨            │
                                                                 │
    → 자동으로 키 삭제됨                                           │
    → 다른 사람이 해당 좌석 선점 가능해짐                            │
```

## 요약

|단계|사용자 행동|서버/Redis 처리|
|---|---|---|
|1|예매 페이지 클릭|Redis ZSet에 대기열 등록|
|2|대기 화면 보기|브라우저가 2초마다 폴링|
|3|(백그라운드)|스케줄러가 순차 입장 처리|
|4|입장 허용 받음|폴링 응답에 토큰 포함|
|5|좌석 조회|Redis에서 현황 반환|
|6|좌석 클릭|Lua 스크립트로 원자적 선점|
|7|결제|PG사 연동|
|8|(백그라운드)|Kafka → Worker → DB 저장|
|9|완료|티켓 발급|
