엔티티를 관리하는 임시 저장소. 트랜잭션을 사용할때 JPA가 DB랑 애플리케이션 사이에서 엔티티를 캐싱하고 관리하는 공간

---

### 엔티티 생명주기

| 상태             | 설명                        |
| -------------- | ------------------------- |
| 비영속 (new)      | 그냥 new로 만든 객체. JPA랑 관계 없음 |
| 영속 (managed)   | 영속성 컨텍스트에 저장된 상태          |
| 준영속 (detached) | 영속성 컨텍스트에서 분리된 상태         |
| 삭제 (removed)   | 삭제 예정 상태                  |


```java
Member member = new Member();  // 비영속

em.persist(member);  // 영속

em.detach(member);   // 준영속

em.remove(member);   // 삭제
```
### 언제 영속/준영속인지 판단하는 법

`@Transactional` 범위로 판단

| 상황                         | 상태  |
| -------------------------- | --- |
| @Transactional 안에서 조회한 엔티티 | 영속  |
| @Transactional 끝난 후        | 준영속 |
| new로 만든 객체                 | 비영속 |
| delete() 호출한 엔티티           | 삭제  |

```java
@Transactional
public void update(Long id) {
    Member member = memberRepository.findById(id).get();
    // 영속 상태 → 변경 감지 동작
    
    member.setName("변경");
}  // 트랜잭션 끝 → 준영속

public void noTx() {
    Member member = memberRepository.findById(1L).get();
    // 이미 준영속 → 지연 로딩 안 됨
}
```
---

### 영속성 컨텍스트의 이점

**1차 캐시**

- 같은 트랜잭션 내에서 같은 엔티티 조회하면 DB 안 가고 캐시에서 가져옴
```java
Member a = em.find(Member.class, 1L); //DB 조회
Member b = em.find(Member.class, 1L); //캐시에서 가져옴
// a == b (같은 객체)
```

#### 변경 감지 (Dirty Checking)
- 엔티티 수정하면 알아서 UPDATE쿼리 날림. 따로 SAVE 안 해도 됨
```java
Member member = em.find(Member.class, 1L);
member.setName("변경된 이름");
// 트랜잭션 커밋 시점에 자동으로 UPDATE
```
쓰기 지연
- persist() 해도 바로 INSERT 안함. 커밋할 때 모아서 한 번에 보냄

---

### flush vs commit

|구분|설명|
|---|---|
|flush|영속성 컨텍스트 변경사항을 DB에 반영 (쿼리 날림)|
|commit|flush + 트랜잭션 확정|
flush 해도 트랜잭션 안 끝남. commit 해야 진짜 확정.
**flush**: 쿼리를 DB에 "보내기만" 함 **commit**: 그 쿼리를 "확정"함

```java
em.persist(member);
em.flush();  // INSERT 쿼리 DB로 날아감. 하지만 아직 확정 아님

// 여기서 예외 터지면?
em.getTransaction().rollback();  // INSERT 취소됨
```
---

### 정리

| 용어       | 의미                    |
| -------- | --------------------- |
| 영속성 컨텍스트 | 엔티티 관리하는 임시 저장소       |
| 1차 캐시    | 같은 엔티티 또 조회하면 DB 안 감  |
| 변경 감지    | 수정하면 자동으로 체크 후 UPDATE |
| 쓰기 지연    | 커밋할 때 모아서 쿼리 날림       |

