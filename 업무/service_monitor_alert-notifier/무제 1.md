```
	항공사 (148개) 
			↓ 
	각자 다른 프로토콜 E-border (중간 통합) 
			↓ 
	표준화된 형식 법무부 Immigration Server 
			↓ 
	승인/거부 E-border 
			↓ 
	각 항공사 프로토콜로 재변환 항공사
```

```
법무부는 표준 EDIFACT PAXLST만 받음 
- EDIFACT: UN 표준 전자문서 형식 
- PAXLST: Passenger List (승객 명단) 문제: 각 항공사가 법무부에 직접 보내는 방식이 다름 

1. MATIP/HTH (1980년대 프로토콜)
2. MQ/HTH (ActiveMQ + HTH 헤더)
3. MQ/NoHTH (ActiveMQ, HTH 없음)
     
→ 법무부가 148개 항공사 프로토콜 다 받을 수 없음 
→ E-border가 중간에서 통합/변환
```



## Monitor 프로세스의 역할

````ruby
## 실제 메시지 흐름 (더 정확한 버전)
```
┌─────────────────────────────────────────────────────────────────┐
│                        항공사 (아시아나)                         │
└────────────────────────┬────────────────────────────────────────┘
                         │ MATIP TCP Socket
                         ↓
┌─────────────────────────────────────────────────────────────────┐
│  Ruby Process: airlineMessageHandler_v3_1A1 (PID: 3853)        │
│                                                                 │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ AirlineServerWorker (Celluloid Actor)                   │  │
│  │ - Socket에서 PAXLST 수신                                 │  │
│  │ - Redis List에 lpush                                    │  │
│  └──────────────────────────────────────────────────────────┘  │
│                          ↓                                      │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ Redis: AirlineRequestIDs:Request:1A1                    │  │
│  │ (localhost:7399)                                        │  │
│  └──────────────────────────────────────────────────────────┘  │
│                          ↓                                      │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ AirlineMessageDispatcher (Celluloid Actor)              │  │
│  │ - Redis에서 brpop                                       │  │
│  │ - HTH 파싱, 검증                                        │  │
│  │ - 법무부 Queue로 전달                                   │  │
│  └──────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                         ↓
┌─────────────────────────────────────────────────────────────────┐
│  Redis: AirlineRequestIDs:Request (전체 공용)                  │
└─────────────────────────────────────────────────────────────────┘
                         ↓
┌─────────────────────────────────────────────────────────────────┐
│  immigrationClient (PID: 7215)                                  │
│  - PAXLST 법무부로 전송                                         │
│  - CUSRES/Reject 수신                                           │
└─────────────────────────────────────────────────────────────────┘
                         ↓
┌─────────────────────────────────────────────────────────────────┐
│  Redis: AirlineRequestIDs:Response:1A1                         │
└─────────────────────────────────────────────────────────────────┘
                         ↓
┌─────────────────────────────────────────────────────────────────┐
│  Ruby Process: airlineMessageHandler_v3_1A1                    │
│                                                                 │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ AirlineServerSender (Celluloid Actor)                   │  │
│  │ - Redis에서 brpop                                       │  │
│  │ - HTH 헤더 추가                                         │  │
│  │ - Socket으로 전송                                       │  │
│  └──────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                         ↓
                      항공사
````

---

## Node.js Extension (xaAMR)의 역할
````ruby
```
// ActiveMQ에서 메시지 수신

xaAMR (PID: 8005) - 메인 프로세스
  │
  ├─ Extension Worker 92122  (ServiceName: 1A1)
  │  └─ 1A1.QueueToRedis.js
  │     - ActiveMQ 메시지 수신
  │     - Redis Queue에 전달
  │
  ├─ Extension Worker 92138  (ServiceName: 1A2)
  │  └─ 1A2.QueueToRedis.js
  │
  ├─ Extension Worker 138870 (ServiceName: TW1)
  │  └─ TW1.QueueToRedis.js
  │
  └─ ... (각 ServiceName별)

// MQ 방식 항공사만 이 경로 사용
// MATIP 방식은 직접 Socket 연결이라 xaAMR 안 거침
```
````
