31번서버
docker
```liux
ea5dc74679ed   gitea.yhtdev.net/eborder/service-monitor:latest   "ruby serviceMonitor…"   2 weeks ago   Up 7 days   0.0.0.0:1112->1112/tcp                                           service-monitor

259f71ed68e5   gitea.yhtdev.net/eborder/alert-notifier:latest    "ruby lib/alertNotif…"   2 weeks ago   Up 8 days   0.0.0.0:6277->5277/tcp                                           alert-notifier
```
 
## 전체 시스템 구조
```bash
┌─────────────────────────────────────────────────────────────┐
│  각 원격 서버 (11, 12, 21, 22, 23번 등)                        │
│                                                              │
│  ┌────────────────────────────────────────────┐              │
│  │ Ruby 데몬 프로세스들 (Native, Not Docker)    │              │
│  │                                            │              │
│  │ ├── airlineMessageHandler_v3_<Service>    │              │
│  │ │   (WE1, WE2, 1A1, 1A2, UA1, UA2, BX...) │              │
│  │ │   └── 항공사 메시지 처리 (MATIP/MQ)       │              │
│  │ │                                          │              │
│  │ ├── serviceMonitor_<ServerName>           │              │
│  │ │   (예: ./bin/serviceMonitor KorApp Prod2)│              │
│  │ │   ├── serverConnectionCheck.rb          │              │
│  │ │   │   └── 31번 서버와 연결 상태 체크      │              │
│  │ │   ├── commonContainerCheck.rb           │              │
│  │ │   │   └── Ruby 데몬 프로세스 상태 체크   │              │
│  │ │   │       (airlineMessageHandler 등)     │              │
│  │ │   └── commonSessionCheck.rb (추정)      │              │
│  │ │       └── 세션/포트 상태 체크            │              │
│  │ │                                          │              │
│  │ ├── immigrationClient                     │              │
│  │ │   └── 법무부 시스템 연동                 │              │
│  │ │                                          │              │
│  │ └── pfmsPumper                            │              │
│  │     └── PFMS 메시지 처리                   │              │
│  └────────────┬───────────────────────────────┘              │
│               │ TCP Socket                                   │
│               ├─→ 31번:5277로 이벤트 전송 (alert-notifier)    │
│               └─→ 31번:1112로 Health Check 전송 (양방향)     │
└───────────────┼──────────────────────────────────────────────┘
                │
                ▼
┌─────────────────────────────────────────────────────────────┐
│  31번 서버 (USTD-DEV1-31, mercury-dev, 192.168.14.31)       │
│                                                              │
│  ┌────────────────────────────────────────────┐              │
│  │ service-monitor (Docker 컨테이너)           │              │
│  │ image: gitea.../service-monitor:latest     │              │
│  │ port: 0.0.0.0:1112->1112/tcp               │              │
│  │                                            │              │
│  │ 동일한 Ruby 코드베이스 사용:                 │              │
│  │ ├── serverConnectionCheck.rb               │              │
│  │ │   ├── 1112 포트 LISTEN                    │              │
│  │ │   ├── 원격 서버들에 연결 시도 (양방향)       │              │
│  │ │   └── 원격 서버들의 health check 수신      │              │
│  │ │                                          │              │
│  │ ├── commonContainerCheck.rb                │              │
│  │ │   └── 31번 Docker 컨테이너 상태 체크       │              │
│  │ │                                          │              │
│  │ └── amrAlarmCheck.rb                       │              │
│  │     └── PostgreSQL DB 알람 조회             │              │
│  └────────────┬───────────────────────────────┘              │
│               │ TCP Socket (port 5277)                       │
│               │ (31번 자신의 이벤트도 alert-notifier로 전송)    │
│               ▼                                              │
│  ┌────────────────────────────────────────────┐              │
│  │ alert-notifier (Docker 컨테이너)            │ ◄───────────┤
│  │ image: gitea.../alert-notifier:latest      │             │
│  │ port: 0.0.0.0:6277->5277/tcp               │             │
│  │                                            │             │
│  │ 역할: 중앙 알림 허브                         │             │
│  │ ├── TCP 5277 포트 LISTEN                    │             │
│  │ ├── 모든 서버의 이벤트 수신:                 │             │
│  │ │   - 원격 서버들 (11,12,21,22번)           │─────────────┘
│  │ │   - 31번 자신의 service-monitor           │
│  │ │                                          │
│  │ ├── 이벤트 타입별 분류 및 라우팅:             │
│  │ │   - W/E (Warning/Error)                 │
│  │ │     → yht.ustd.05@gmail.com            │
│  │ │   - I (Info)                            │
│  │ │     → InfoRecipients                   │
│  │ │   - S (Special)                         │
│  │ │     → SuReceipient                     │
│  │ │                                          │
│  │ └── SMTP 이메일 발송                        │
│  │     - 서버: mail.yht.co.kr:465            │
│  │     - 계정: eborder.monitor               │
│  └────────────────────────────────────────────┘
│                                                            
│  ┌────────────────────────────────────────────┐              │
│  │ 기타 Docker 컨테이너들                       │              │
│  │ ├── PostgreSQL (port 5010)                │              │
│  │ ├── Redis (port 6379)                     │              │
│  │ ├── MariaDB                                │              │
│  │ ├── eborder-dashboard-server-1            │              │
│  │ ├── tools-prometheus-1 (port 5200)        │              │
│  │ ├── Gitea                                  │              │
│  │ ├── Portainer                              │              │
│  │ └── Nginx Proxy Manager                   │              │
│  └────────────────────────────────────────────┘              │
└──────────────────────────────────────────────────────────────┘
```

## 주요 수정 사항
### 데이터 흐름
```
1. 원격 서버 Ruby 데몬 프로세스 실행 중
   airlineMessageHandler_v3_WE1
   airlineMessageHandler_v3_1A1
   ...

2. serviceMonitor_KorAppProd2 (Ruby 데몬)
   → ps aux | grep airlineMessageHandler
   → 프로세스 다운 감지
   → JSON 이벤트 생성
   {
     "ServiceName": "KOR-APP-PROD2",
     "EventType": "E",
     "EventName": "Process Down",
     "EventMessage": "airlineMessageHandler_v3_WE1 is not running",
     "EventTime": "2025-11-20 11:30:00"
   }

3. TCP Socket으로 전송
   → 192.168.14.31:5277 (alert-notifier)
   → ["M", size, JSON].pack("a4Na*")

4. alert-notifier (Docker)
   → 이벤트 수신
   → EventType 확인: "E" → @Recipients
   → 이메일 생성

5. SMTP 발송
   → mail.yht.co.kr:465
   → yht.ustd.05@gmail.com
   Subject: [KOR-APP-PROD2] - E, Process Down
   Body: airlineMessageHandler_v3_WE1 is not running
```


## Alertmanager 전환 시 변경점
```bash
┌─ 전환 후 ─┐
│ alert-notifier (제거) → Alertmanager (신규)
│ - 프로토콜: TCP → HTTP
│ - 모든 serviceMonitor Ruby 코드 수정 필요
└──────────┘
```

