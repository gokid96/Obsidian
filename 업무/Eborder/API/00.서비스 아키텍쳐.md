```
┌─────────────────────────────────────────────────────────────────────────────┐
│                            항공사 (요청: PAXLST)                             │
└──────────────────────────────────┬──────────────────────────────────────────┘
                                   │
                                   │ (메시지 전송)
                                   ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                      IBM MQ (144.243.224.230:1414)                           │
│                      Queue: YUHAN.KOR.IAPP.FROM.1A                           │
└──────────────────────────────────┬──────────────────────────────────────────┘
                                   │
                                   │ PULL (당겨옴)
                                   ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                              xaAMR (MQ 브로커)                               │
│                              PID: 3726945                                   │
│  ┌─────────────────────┐                    ┌─────────────────────┐        │
│  │  QueueToRedis.js    │                    │  RedisToQueue.js    │        │
│  │  (1A1 서비스)        │                    │  (1A1 서비스)        │        │
│  └─────────────────────┘                    └─────────────────────┘        │
└──────────┬───────────────────────────────────────────▲──────────────────────┘
           │                                           │
           │ LPUSH                                     │ BRPOP
           │                                           │
           ▼                                           │
┌──────────────────────────────────────────────────────┴──────────────────────┐
│                                Redis                                        │
│  ┌──────────────────────────────┐    ┌──────────────────────────────┐      │
│  │ AirlineRequestIDs:Request:1A1│    │ AirlineRequestMessages:1A1   │      │
│  │ (요청 큐)                     │    │ (응답 큐)                     │      │
│  └──────────────────────────────┘    └──────────────────────────────┘      │
└──────────┬───────────────────────────────────────────▲──────────────────────┘
           │                                           │
           │ BRPOP                                     │ LPUSH
           │                                           │
           ▼                                           │
┌─────────────────────────────────────────────────────────────────────────────┐
│                    airlineMessageHandler.rb (Ruby)                          │
│  ┌─────────────────────┐                    ┌─────────────────────┐        │
│  │ AirlineMessage      │                    │ AirlineServer       │        │
│  │ Dispatcher          │ ──── 검증 ────→    │ Sender              │        │
│  │ (요청 처리)          │                    │ (응답 전송)          │        │
│  └─────────────────────┘                    └─────────────────────┘        │
└──────────────────────────────┬──────────────────────▲───────────────────────┘
                               │                      │
                               │ LPUSH                │ BRPOP
                               ▼                      │
┌─────────────────────────────────────────────────────┴───────────────────────┐
│                                Redis                                        │
│                    ┌──────────────────────────────┐                         │
│                    │ AirlineRequestIDs:Request    │                         │
│                    │ (법무부 전송용 큐)            │                         │
│                    └──────────────────────────────┘                         │
└──────────────────────────────┬──────────────────────▲───────────────────────┘
                               │                      │
                               │ BRPOP                │ LPUSH
                               ▼                      │
┌─────────────────────────────────────────────────────────────────────────────┐
│                             법무부 시스템                                    │
│                    (immigrationServer / immigrationClient)                  │
└─────────────────────────────────────────────────────────────────────────────┘
                                   │
                                   │ (응답 완료 후 역순으로 전달)
                                   ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                      IBM MQ (144.243.224.230:1414)                           │
│                      Queue: YUHAN.KOR.IAPP.TO.1A                             │
└──────────────────────────────────┬──────────────────────────────────────────┘
                                   │
                                   │ PUSH (밀어넣음)
                                   ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                           항공사 (응답: CUSRES)                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 흐름 요약


|단계|출발|도착|방식|
|---|---|---|---|
|1|항공사|IBM MQ (FROM 큐)|MQ 프로토콜|
|2|IBM MQ|xaAMR|**PULL (당겨옴)**|
|3|QueueToRedis.js|Redis (요청큐)|LPUSH|
|4|Redis (요청큐)|AirlineMessageDispatcher|BRPOP|
|5|AirlineMessageDispatcher|Redis (법무부큐)|LPUSH|
|6|Redis (법무부큐)|법무부|BRPOP|
|7|법무부|Redis (응답큐)|LPUSH|
|8|Redis (응답큐)|AirlineServerSender|BRPOP|
|9|AirlineServerSender|Redis (MQ응답큐)|LPUSH|
|10|Redis (MQ응답큐)|RedisToQueue.js|BRPOP|
|11|xaAMR|IBM MQ (TO 큐)|**PUSH (밀어넣음)**|
|12|IBM MQ|항공사|MQ 프로토콜|


```
항공사 (요청: PAXLST)
    │
    │ (메시지 전송)
    ▼
┌─────────────────────────────────┐
│  IBM MQ (144.243.224.230:1414)  │
│  Queue: YUHAN.KOR.IAPP.FROM.1A  │
└─────────────────────────────────┘
    │
    │ PULL (당겨옴)
    ▼
   xaAMR (MQ 브로커)
    │
    │ onMessage
    ▼
[JS: QueueToRedis] ──LPUSH──→ Redis (AirlineRequestIDs:Request:1A1)
                                │
                                │ BRPOP
                                ▼
                    [Ruby: AirlineMessageDispatcher]
                                │
                                │ 검증
                                ▼
                             법무부
                                │
                                │ 응답
                                ▼
                    [Ruby: AirlineServerSender]
                                │
                                │ LPUSH
                                ▼
[JS: RedisToQueue] ←─BRPOP── Redis (AirlineRequestMessages:1A1)
    │
    │ message.push
    ▼
   xaAMR (MQ 브로커)
    │
    │ PUSH (밀어넣음)
    ▼
┌─────────────────────────────────┐
│  IBM MQ (144.243.224.230:1414)  │
│  Queue: YUHAN.KOR.IAPP.TO.1A    │
└─────────────────────────────────┘
    │
    ▼
항공사 (응답: CUSRES)
```

PROD1 레거시 포함 (레거시 MATIP은 PROD1에만 있음 직접 통신)
```
┌─────────────────────────────────────────────────────────────────────────────┐
│                                                                             │
│  PROD1 (MATIP 직접 + MQ 혼재)                                               │
│  ─────────────────────────────                                              │
│                                                                             │
│  [항공사]                                                                    │
│      │                                                                      │
│      ├── MATIP TCP ──▶ Ruby Handler (직접 Socket) ──▶ Redis                │
│      │                 (1A1, 1A2, 1E, BX, DL, EK...)                        │
│      │                 ServerPort: 2001~2089                                │
│      │                                                                      │
│      └── IBM MQ ──▶ xaAMR ──▶ Node.js ──▶ Redis ──▶ Ruby Handler           │
│                    (1T1, 1T2, Q11, Q12, UA1, UA2, XS.* 등)                  │
│                    ServiceType: MQ                                          │
│                                                                             │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  PROD2 (전부 xaAMR 경유)                                                    │
│  ────────────────────────                                                   │
│                                                                             │
│  [항공사]                                                                    │
│      │                                                                      │
│      ├── MATIP TCP ──▶ xaAMR (MATIPBroker) ──┐                              │
│      │                                        │                             │
│      └── IBM MQ ──▶ xaAMR (MQAdapter) ───────┤                              │
│                                               │                             │
│                                               ▼                             │
│                                          LocalMQ                            │
│                                               │                             │
│                                               ▼                             │
│                                     Node.js (QueueToRedis)                  │
│                                               │                             │
│                                               ▼                             │
│                                            Redis                            │
│                                               │                             │
│                                               ▼                             │
│                          Ruby Handler (모든 ServiceType = MQ)               │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
- xaAMR = MATIP + MQ 둘 다 처리 (MATIPBroker, MQAdapter)
- Ruby Handler = xaAMR 또는 직접 연결 모두 처리 
- Ruby의 ServiceType이 MATIP이면 직접 연결, MQ이면 xaAMR 경유
```


### 전체 메시지 흐름

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              항공사 (Airline)                                │
│                         PAXLST 요청 → CUSRES 응답                           │
└───────────────┬─────────────────────────────────────────▲────────────────────┘
                │                                         │
                │ 요청 (PAXLST)                           │ 응답 (CUSRES)
                ▼                                         │
┌───────────────────────────────────────────────────────────────────────────────┐
│                        통신 프로토콜 (2가지)                                   │
│  ┌─────────────────────────┐       ┌─────────────────────────────────────┐   │
│  │   MATIP (직접 TCP)       │       │         IBM MQ                      │   │
│  │   Port: 2001~2089       │       │   144.243.224.230:1414              │   │
│  │   (레거시, PROD1 only)   │       │   Queue: YUHAN.KOR.IAPP.FROM/TO.XX  │   │
│  └───────────┬─────────────┘       └─────────────┬─────────────────────┘   │
│              │                                   │                          │
└──────────────┼───────────────────────────────────┼──────────────────────────┘
               │                                   │
               │                                   │ PULL/PUSH
               ▼                                   ▼
┌───────────────────────────────────────────────────────────────────────────────┐
│                              xaAMR (미들웨어)                                  │
│  ┌─────────────────────────┐       ┌─────────────────────────────────────┐   │
│  │     MATIP Broker        │       │      MQ Adapter                     │   │
│  │  (MATIP ↔ LocalMQ)      │       │   (IBM MQ ↔ LocalMQ)                │   │
│  │  - MQSeriesToQueue      │       │   - MQSeriesToQueue                 │   │
│  │  - QueueToMQSeries      │       │   - QueueToMQSeries                 │   │
│  └───────────┬─────────────┘       └─────────────┬─────────────────────┘   │
│              │                                   │                          │
│              └───────────────┬───────────────────┘                          │
│                              ▼                                              │
│                    ┌───────────────────┐                                    │
│                    │     LocalMQ       │ (내부 큐)                           │
│                    └─────────┬─────────┘                                    │
│                              │                                              │
│  ┌───────────────────────────┴───────────────────────────────┐              │
│  │                     Node.js Scripts                        │              │
│  │  ┌─────────────────────┐    ┌─────────────────────────┐   │              │
│  │  │   QueueToRedis.js   │    │   RedisToQueue.js       │   │              │
│  │  │ (요청: LocalMQ→Redis)│    │ (응답: Redis→LocalMQ)   │   │              │
│  │  └─────────────────────┘    └─────────────────────────┘   │              │
│  └───────────────────────────────────────────────────────────┘              │
└──────────────────────────────────┬───────────────▲──────────────────────────┘
                                   │               │
                                   │ LPUSH         │ BRPOP
                                   ▼               │
┌───────────────────────────────────────────────────────────────────────────────┐
│                                  Redis                                        │
│  ┌────────────────────────────┐     ┌────────────────────────────┐           │
│  │ AirlineRequestIDs:Request: │     │ AirlineRequestMessages:    │           │
│  │ 1A1 (요청 큐)               │     │ 1A1 (응답 큐)               │           │
│  └──────────────┬─────────────┘     └──────────────▲─────────────┘           │
└─────────────────┼──────────────────────────────────┼─────────────────────────┘
                  │ BRPOP                            │ LPUSH
                  ▼                                  │
┌───────────────────────────────────────────────────────────────────────────────┐
│                        Ruby Handler (airlineMessageHandler.rb)                │
│  ┌─────────────────────────┐              ┌─────────────────────────┐        │
│  │ AirlineMessageDispatcher│   검증/처리   │ AirlineServerSender    │        │
│  │ (요청 수신 및 검증)       │ ──────────▶ │ (응답 전송)             │        │
│  └───────────┬─────────────┘              └──────────▲──────────────┘        │
└──────────────┼───────────────────────────────────────┼───────────────────────┘
               │ LPUSH                                 │ BRPOP
               ▼                                       │
┌───────────────────────────────────────────────────────────────────────────────┐
│                                  Redis                                        │
│                    ┌────────────────────────────┐                             │
│                    │ AirlineRequestIDs:Request  │                             │
│                    │ (법무부 전송용 큐)          │                             │
│                    └──────────────┬─────────────┘                             │
└───────────────────────────────────┼───────────────▲──────────────────────────┘
                                    │ BRPOP         │ LPUSH
                                    ▼               │
┌───────────────────────────────────────────────────────────────────────────────┐
│                              법무부 시스템                                     │
│                    (immigrationServer / immigrationClient)                    │
│                           승객 정보 검증 및 응답                               │
└───────────────────────────────────────────────────────────────────────────────┘
```

---

### PROD1 vs PROD2 차이점