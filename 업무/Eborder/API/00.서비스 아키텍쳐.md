## 1. 전체 연결 아키텍처 (Network Topology)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                            외부망 (항공사/GDS)                               │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐     │
│  │ Amadeus  │  │ Sabre    │  │ Travelsky│  │ United   │  │ 개별항공사 │     │
│  │ (1A)     │  │ (1S)     │  │ (1E)     │  │ (UA)     │  │ (DL,EK..)│     │
│  └────┬─────┘  └────┬─────┘  └────┬─────┘  └────┬─────┘  └────┬─────┘     │
│       │             │             │             │             │           │
│       └──────┬──────┴──────┬──────┴──────┬──────┴──────┬──────┘           │
│              │             │             │             │                   │
│              ↓             ↓             ↓             ↓                   │
│  ┌───────────────────────────────────────────────────────────────────┐    │
│  │                    ARINC 에어링크 망                               │    │
│  │              (항공 전용 네트워크 - SITA/ARINC)                     │    │
│  └───────────────────────────────────────────────────────────────────┘    │
│                              │                                             │
└──────────────────────────────┼─────────────────────────────────────────────┘
                               │ 전용선/VPN
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┿━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
                               │
┌──────────────────────────────┼─────────────────────────────────────────────┐
│                     E-border DMZ                                           │
│                              │                                             │
│              ┌───────────────┴───────────────┐                             │
│              │         방화벽 (IP 필터링)      │                             │
│              └───────────────┬───────────────┘                             │
│                              │                                             │
│  ┌───────────────────────────┴───────────────────────────────────────┐    │
│  │                      IBM MQ Cluster                                │    │
│  │   ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐             │    │
│  │   │ UA.REQ  │  │ 1A.REQ  │  │ DL.REQ  │  │ ...     │             │    │
│  │   │ UA.RES  │  │ 1A.RES  │  │ DL.RES  │  │         │             │    │
│  │   └─────────┘  └─────────┘  └─────────┘  └─────────┘             │    │
│  └───────────────────────────────────────────────────────────────────┘    │
│                                                                            │
└────────────────────────────────┬───────────────────────────────────────────┘
                                 │
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┿━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
                                 │
┌────────────────────────────────┼───────────────────────────────────────────┐
│                      E-border 내부망                                        │
│                                │                                           │
│    ┌───────────────────────────┴───────────────────────────────────┐      │
│    │                   iAPP 서버 클러스터                            │      │
│    │                                                                │      │
│    │   ┌─────────────────┐          ┌─────────────────┐            │      │
│    │   │ kor-iapp-prod-1 │◄────────►│ kor-iapp-prod-2 │            │      │
│    │   │  192.168.100.11 │  Redis   │  192.168.100.12 │            │      │
│    │   │                 │  복제    │                 │            │      │
│    │   │ - xaAMR         │          │ - xaAMR         │            │      │
│    │   │ - Ruby Handlers │          │ - Ruby Handlers │            │      │
│    │   │ - Redis Master  │          │ - Redis Slave   │            │      │
│    │   └─────────────────┘          └─────────────────┘            │      │
│    │                                                                │      │
│    └────────────────────────────┬───────────────────────────────────┘      │
│                                 │                                          │
└─────────────────────────────────┼──────────────────────────────────────────┘
                                  │ TCP Socket
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┿━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
                                  │
┌─────────────────────────────────┼──────────────────────────────────────────┐
│                       법무부 출입국 시스템                                   │
│                                 │                                          │
│                    ┌────────────┴────────────┐                             │
│                    │      APP 서버           │                             │
│                    │   (Immigration Server)  │                             │
│                    └─────────────────────────┘                             │
│                                                                            │
└────────────────────────────────────────────────────────────────────────────┘
```

---

## 2. 메시지 흐름 아키텍처 (Message Flow)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         PAXLST 처리 흐름 (인바운드)                          │
└─────────────────────────────────────────────────────────────────────────────┘

[항공사] PAXLST 전송 (승객 탑승 전)
    │
    ↓ ① EDIFACT/PAXLST
┌─────────────────────────────────────────────────────────────┐
│ MQ / MATIP                                                  │
│ (프로토콜 레이어)                                            │
└─────────────────────────────────────────────────────────────┘
    │
    ↓ ② MQSeriesToQueue
┌─────────────────────────────────────────────────────────────┐
│ xaAMR (ARINC Integrator)                                    │
│ - 프로토콜 변환                                              │
│ - 내부 큐 관리                                               │
└─────────────────────────────────────────────────────────────┘
    │
    ↓ ③ QueueToNodeJs (*.QueueToRedis.js)
┌─────────────────────────────────────────────────────────────┐
│ Redis                                                       │
│ - AirlineRequestIDs:Request:UA1 (항공사별 수신큐)            │
│ - AirlineRequestMessages (메시지 본문)                       │
└─────────────────────────────────────────────────────────────┘
    │
    ↓ ④ brpop (AirlineRequestIDs:Request:UA1)
┌─────────────────────────────────────────────────────────────┐
│ airlineMessageHandler (Ruby)                                │
│                                                             │
│ [검증 단계]                                                  │
│ ├─ HTH 헤더 파싱 (Layer4/5/6)                               │
│ ├─ Source Address 검증 → 실패시 Reject1 (1K)                │
│ ├─ Airline Code 검증 → 실패시 Reject1 (1J)                  │
│ ├─ Message Size 검증 → 실패시 Reject1 (1D)                  │
│ └─ Timeout 검증 → 실패시 Reject2 (1F)                       │
│                                                             │
│ [처리 단계]                                                  │
│ └─ lpush AirlineRequestIDs:Request (기관 전송 대기열)        │
└─────────────────────────────────────────────────────────────┘
    │
    ↓ ⑤ brpop (AirlineRequestIDs:Request)
┌─────────────────────────────────────────────────────────────┐
│ immigrationClient (Ruby)                                    │
│                                                             │
│ [전송 단계]                                                  │
│ ├─ TCP 헤더 생성 (Q + ZZ + AirlineCode + RequestID + Size) │
│ ├─ 법무부 서버로 전송                                        │
│ ├─ ACK 수신 대기                                            │
│ └─ Response 수신 대기                                        │
└─────────────────────────────────────────────────────────────┘
    │
    ↓ ⑥ TCP Socket
┌─────────────────────────────────────────────────────────────┐
│ 법무부 APP 서버                                              │
│ - 승객 심사 (블랙리스트, 비자 등)                             │
│ - CUSRES 응답 생성                                          │
└─────────────────────────────────────────────────────────────┘
    │
    ↓ ⑦ CUSRES (심사결과)
    
    (역방향으로 동일 경로 반환)
    
    ↓
[항공사] CUSRES 수신 → 탑승 허용/거부 결정
```

---

## 3. 데이터 저장 아키텍처 (Data Layer)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              Redis 구조                                      │
└─────────────────────────────────────────────────────────────────────────────┘

┌─ List (Queue) ─────────────────────────────────────────────────────────────┐
│                                                                             │
│  AirlineRequestIDs:Request:UA1    ← 항공사별 수신 대기열                     │
│  AirlineRequestIDs:Request:1A1                                              │
│  AirlineRequestIDs:Request        ← 기관 전송 대기열 (공통)                  │
│  AirlineRequestIDs:Response:UA1   ← 항공사별 응답 대기열                     │
│  AirlineRequestIDs:Request:UA1:Pending  ← 타임아웃 체크용                   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘

┌─ Hash ─────────────────────────────────────────────────────────────────────┐
│                                                                             │
│  AirlineRequestMessages                                                     │
│  ├─ {RequestID} → {                                                        │
│  │     ServiceID: "UA1",                                                   │
│  │     RequestID: "12345",                                                 │
│  │     RequestMessage: "UNB+UNOA...(EDIFACT)",                             │
│  │     ResponseMessage: "UNB+UNOA...(CUSRES)",                             │
│  │     MessageType: "PAXLST" | "CUSRES" | "Reject1" | "Reject2",           │
│  │     MessageFrontReceivedTime: "2025-12-17 08:03:47.919",                │
│  │     MessageBackSentTime: "2025-12-17 08:03:47.950",                     │
│  │     ...                                                                 │
│  │  }                                                                      │
│                                                                             │
│  AirlineMessageHandlerStatus                                                │
│  ├─ "APP-PROD1:UA1" → {                                                    │
│  │     Connected: true,                                                    │
│  │     PAXLSTMessageCount: 15234,                                          │
│  │     CUSRESMessageCount: 15230,                                          │
│  │     Reject1MessageCount: 4,                                             │
│  │     ...                                                                 │
│  │  }                                                                      │
│                                                                             │
│  PaxlstResponseSentCheck                                                    │
│  ├─ {RequestID} → ""   (중복 응답 방지용 플래그)                             │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘

┌─ Atomic Counter ───────────────────────────────────────────────────────────┐
│                                                                             │
│  AirlineRequestID  ← INCR로 고유 ID 생성                                    │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 4. 프로세스 아키텍처 (Process/Thread)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    kor-iapp-prod-1 프로세스 구조                             │
└─────────────────────────────────────────────────────────────────────────────┘

┌─ xaAMR (Java) ──────────────────────────────────────────────────────────────┐
│  PID: 8005                                                                  │
│                                                                             │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐             │
│  │ MATIP Broker    │  │ MQ Connector    │  │ Node.js Engine  │             │
│  │ (TCP:2017,2021.)│  │ (IBM MQ)        │  │ (스크립트 실행)  │             │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘             │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘

┌─ Ruby Handlers (Celluloid Actor Model) ─────────────────────────────────────┐
│                                                                             │
│  airlineMessageHandler_v3_UA1 (PID: 12001)                                  │
│  ├─ [Actor] HandlerStatusUpdater    - 상태 모니터링                          │
│  ├─ [Actor] AirlineServerWorker     - MATIP 패킷 수신 (해당시)               │
│  ├─ [Actor] AirlineMessageDispatcher - 메시지 검증/라우팅                    │
│  ├─ [Actor] AirlineServerSender     - 응답 전송                             │
│  └─ [Actor] AirlineMessageCleaner   - 타임아웃 처리                          │
│                                                                             │
│  airlineMessageHandler_v3_1A1 (PID: 12002)                                  │
│  airlineMessageHandler_v3_DL (PID: 12003)                                   │
│  ... (서비스별 독립 프로세스)                                                 │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘

┌─ immigrationClient (Ruby) ──────────────────────────────────────────────────┐
│  PID: 13001                                                                 │
│                                                                             │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐             │
│  │ APPClientWorker │  │ APPClientWorker │  │ APPClientWorker │             │
│  │ (Worker 1)      │  │ (Worker 2)      │  │ (Worker N)      │             │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘             │
│                                                                             │
│  WorkerCount 설정에 따라 병렬 처리                                           │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘

┌─ Redis (Single Thread) ─────────────────────────────────────────────────────┐
│  PID: 14001                                                                 │
│  Port: 7399                                                                 │
│  - 모든 큐/해시 관리                                                         │
│  - prod-1 ↔ prod-2 복제                                                     │
└─────────────────────────────────────────────────────────────────────────────┘
```

---



---

## 6. 추가로 알면 좋은 아키텍처 개념들

**이 시스템에서 적용된 패턴:**

|패턴|적용 위치|설명|
|---|---|---|
|Message Queue|Redis List, IBM MQ|비동기 처리, 버퍼링|
|Actor Model|Celluloid (Ruby)|동시성 처리, 상태 격리|
|Pipeline|Handler → Client → APP|단계별 처리|
|Circuit Breaker|Timeout + Reject|장애 전파 방지|
|Idempotency|PaxlstResponseSentCheck|중복 응답 방지|
|Dead Letter Queue|AirlineRequestMessages:Backup|실패 메시지 보관|

**공부하면 좋을 관련 개념:**

|분야|키워드|
|---|---|
|메시징|IBM MQ, RabbitMQ, Kafka, AMQP|
|프로토콜|EDIFACT, FIX, ISO 20022|
|패턴|EIP (Enterprise Integration Patterns)|
|아키텍처|ESB, SOA, EDA (Event-Driven)|
|모니터링|APM, 분산 트레이싱, 메시지 추적|

이 시스템은 전형적인 **EAI(Enterprise Application Integration)** 아키텍처예요. "Apache Camel", "MuleSoft", "Spring Integration" 같은 프레임워크들이 이런 패턴을 구현하는 도구들이고요.