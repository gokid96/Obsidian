## 방식 1: MATIP (레거시, 10%)
```
┌─────────────────────────────────────────────────────────────────┐
│                 항공사 (아시아나, 델타 등)                        │
│                                                                 │
│  DCS (Departure Control System)                                 │
│  - MATIP Client 내장                                            │
│  - Binary Protocol                                              │
└────────────────────────┬────────────────────────────────────────┘
                         │
                         │ TCP Socket (Direct Connection)
                         │ Port: 2023, 2024, 2025, ...
                         │ Protocol: MATIP (Type-B)
                         │
                         ↓
┌─────────────────────────────────────────────────────────────────┐
│    E-border 서버 (kor-iapp-prod-1: 192.168.100.11)              │
│                                                                 │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │          xaAMR (ARINC Integrator)                         │ │
│  │          PID: 8005                                        │ │
│  │                                                           │ │
│  │  ┌─────────────────────────────────────────────────────┐ │ │
│  │  │ MATIP Broker Task (WE1.MatipBroker)               │ │ │
│  │  │ Status: listening                                  │ │ │
│  │  │ Port: 2023                                         │ │ │
│  │  │                                                     │ │ │
│  │  │ [역할]                                              │ │ │
│  │  │ 1. TCP 연결 수락 (Accept)                          │ │ │
│  │  │ 2. MATIP Frame 수신                                │ │ │
│  │  │    - STX (0x02)                                    │ │ │
│  │  │    - Frame Header                                  │ │ │
│  │  │    - PAXLST Body                                   │ │ │
│  │  │    - ETX (0x03)                                    │ │ │
│  │  │ 3. Binary → ASCII 변환                             │ │ │
│  │  │ 4. EDIFACT 파싱                                    │ │ │
│  │  └─────────────────┬───────────────┬───────────────────┘ │ │
│  │                    │               │                     │ │
│  │                    ↓               ↑                     │ │
│  │  ┌─────────────────────────────────────────────────────┐ │ │
│  │  │ Local Queue (xaAMR 내부)                          │ │ │
│  │  │                                                     │ │ │
│  │  │ MATIP.WE1.FROM.AGN  ← 항공사에서 받은 메시지       │ │ │
│  │  │ MATIP.WE1.TO.AGN    → 항공사로 보낼 메시지         │ │ │
│  │  └─────────────────┬───────────────┬───────────────────┘ │ │
│  │                    │               │                     │ │
│  │                    ↓               ↑                     │ │
│  │  ┌─────────────────────────────────────────────────────┐ │ │
│  │  │ Node.js Extensions (Output/Input Tasks)           │ │ │
│  │  │                                                     │ │ │
│  │  │ [Output Task] WE1.QueueToNodejs                    │ │ │
│  │  │ - Script: WE1.QueueToRedis.js                      │ │ │
│  │  │ - Queue 감시: MATIP.WE1.FROM.AGN                  │ │ │
│  │  │ - Action: Queue → Redis                            │ │ │
│  │  │                                                     │ │ │
│  │  │ [Input Task] WE1.NodejsToQueue                     │ │ │
│  │  │ - Script: WE1.RedisToQueue.js                      │ │ │
│  │  │ - Queue 저장: MATIP.WE1.TO.AGN                    │ │ │
│  │  │ - Action: Redis → Queue                            │ │ │
│  │  └─────────────────────────────────────────────────────┘ │ │
│  └───────────────────────┬──────────────┬────────────────────┘ │
│                          │              │                      │
│                          ↓              ↑                      │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │ Redis (localhost:7399)                                    │ │
│  │                                                           │ │
│  │ AirlineRequestIDs:Request:WE1                             │ │
│  │ AirlineRequestIDs:Response:WE1                            │ │
│  └───────────────────────┬──────────────┬────────────────────┘ │
│                          │              │                      │
│                          ↓              ↑                      │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │ Ruby Worker (airlineMessageHandler_v3_WE1)                │ │
│  │ PID: 예: 3853                                             │ │
│  └───────────────────────┬───────────────────────────────────┘ │
│                          │                                     │
│                          ↓                                     │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │ immigrationClient (PID: 7215)                             │ │
│  └───────────────────────┬───────────────────────────────────┘ │
└────────────────────────────┼─────────────────────────────────────┘
                            │
                            ↓
┌─────────────────────────────────────────────────────────────────┐
│           법무부 Immigration Server                              │
│           203.242.167.20:7599                                   │
└─────────────────────────────────────────────────────────────────┘
```

### 특징

- **직접 연결**: 항공사가 xaAMR에 직접 TCP 연결
- **Port별 격리**: 각 항공사마다 고유 Port (2023, 2024, ...)
- **Binary Protocol**: MATIP Type-B 프레임 방식
- **레거시**: 1980년대부터 사용된 오래된 방식
- **현재 상태**: listening이지만 ESTABLISHED 연결 거의 없음 (레거시 유지)


### xaAMR 설정
````yaml
# MATIP Broker Task Configuration
Task Name: WE1.MatipBroker
Inbound Queue: MATIP.WE1.FROM.AGN
Outbound Queue: MATIP.WE1.TO.AGN
Port: 2023
Connection Type: Host to Host
Sub Type: IATA
Character Table: ASCII
Header: No Header
```

---

## 방식 2: MQ/NoHTH (주력, 70%)

### 아키텍처
```
┌─────────────────────────────────────────────────────────────────┐
│                 항공사 (티웨이, 브루나이 등)                      │
│                                                                 │
│  HITIT DCS (Departure Control System)                           │
│  - IBM MQ Client                                                │
│  - EDIFACT 전송                                                 │
└────────────────────────┬────────────────────────────────────────┘
                         │
                         │ IBM MQ Protocol (TCP)
                         │ Queue: REMOTE.MQ.TW1.TO.AGN
                         │ HTH 헤더 없음 ❌
                         │
                         ↓
┌─────────────────────────────────────────────────────────────────┐
│              외부 MQ Server (AGN - Agent)                        │
│              144.243.232.7:1415                                 │
│              144.243.228.19:1414                                │
│              144.243.234.19:1414                                │
│              144.243.224.19:1414                                │
│                                                                 │
│  [Queue 구조]                                                   │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │ REMOTE.MQ.TW1.TO.AGN      ← 티웨이가 PAXLST 넣는 곳       │ │
│  │ REMOTE.MQ.1T1.TO.AGN      ← 브루나이가 PAXLST 넣는 곳     │ │
│  │ REMOTE.MQ.9C.TO.AGN       ← 춘추항공이 PAXLST 넣는 곳     │ │
│  │ ...                                                        │ │
│  │                                                            │ │
│  │ REMOTE.MQ.TW1.FROM.IAPP   ← 티웨이가 CUSRES 받는 곳       │ │
│  │ REMOTE.MQ.1T1.FROM.IAPP   ← 브루나이가 CUSRES 받는 곳     │ │
│  │ REMOTE.MQ.9C.FROM.IAPP    ← 춘추항공이 CUSRES 받는 곳     │ │
│  │ ...                                                        │ │
│  └───────────────────────────────────────────────────────────┘ │
└────────────────────────┬────────────────────────────────────────┘
                         │
                         │ MQ Channel (자동 동기화)
                         │ xaAMR이 MQ Client로 연결
                         │
                         ↓
┌─────────────────────────────────────────────────────────────────┐
│    E-border 서버 (kor-iapp-prod-1: 192.168.100.11)              │
│                                                                 │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │          xaAMR (ARINC Integrator)                         │ │
│  │          PID: 8005                                        │ │
│  │                                                           │ │
│  │  ┌─────────────────────────────────────────────────────┐ │ │
│  │  │ MQ Channel Manager                                  │ │ │
│  │  │                                                     │ │ │
│  │  │ [역할]                                              │ │ │
│  │  │ 1. 외부 MQ Server에 클라이언트로 연결              │ │ │
│  │  │    - 144.243.232.7:1415                            │ │ │
│  │  │    - 144.243.228.19:1414                           │ │ │
│  │  │ 2. Channel 설정대로 Queue 동기화                   │ │ │
│  │  │ 3. Remote → Local 자동 복사                        │ │ │
│  │  │ 4. Local → Remote 자동 전송                        │ │ │
│  │  └─────────────────┬───────────────┬───────────────────┘ │ │
│  │                    │               │                     │ │
│  │                    ↓               ↑                     │ │
│  │  ┌─────────────────────────────────────────────────────┐ │ │
│  │  │ Local Queue (xaAMR 내부)                          │ │ │
│  │  │                                                     │ │ │
│  │  │ MQ.TW1.FROM.AGN  ← 외부 MQ에서 복사됨              │ │ │
│  │  │ MQ.TW1.TO.AGN    → 외부 MQ로 자동 전송             │ │ │
│  │  │                                                     │ │ │
│  │  │ MQ.1T1.FROM.AGN                                    │ │ │
│  │  │ MQ.1T1.TO.AGN                                      │ │ │
│  │  └─────────────────┬───────────────┬───────────────────┘ │ │
│  │                    │               │                     │ │
│  │                    ↓               ↑                     │ │
│  │  ┌─────────────────────────────────────────────────────┐ │ │
│  │  │ Node.js Extensions                                 │ │ │
│  │  │                                                     │ │ │
│  │  │ TW1.QueueToRedis.js (PID: 216789)                 │ │ │
│  │  │ - Queue 감시: MQ.TW1.FROM.AGN                     │ │ │
│  │  │ - ServiceName 추출: Queue 이름에서 "TW1"          │ │ │
│  │  │ - Redis lpush: Request:TW1                        │ │ │
│  │  │                                                     │ │ │
│  │  │ TW1.RedisToQueue.js                                │ │ │
│  │  │ - Redis brpop: Response:TW1                       │ │ │
│  │  │ - Queue Put: MQ.TW1.TO.AGN                        │ │ │
│  │  │                                                     │ │ │
│  │  │ 1T1.QueueToRedis.js                                │ │ │
│  │  │ 1T1.RedisToQueue.js                                │ │ │
│  │  │ 9C.QueueToRedis.js                                 │ │ │
│  │  │ 9C.RedisToQueue.js                                 │ │ │
│  │  │ ...                                                 │ │ │
│  │  └─────────────────────────────────────────────────────┘ │ │
│  └───────────────────────┬──────────────┬────────────────────┘ │
│                          │              │                      │
│                          ↓              ↑                      │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │ Redis (localhost:7399)                                    │ │
│  │                                                           │ │
│  │ AirlineRequestIDs:Request:TW1                             │ │
│  │ AirlineRequestIDs:Request:1T1                             │ │
│  │ AirlineRequestIDs:Request:9C                              │ │
│  │                                                           │ │
│  │ AirlineRequestIDs:Response:TW1                            │ │
│  │ AirlineRequestIDs:Response:1T1                            │ │
│  │ AirlineRequestIDs:Response:9C                             │ │
│  └───────────────────────┬──────────────┬────────────────────┘ │
│                          │              │                      │
│                          ↓              ↑                      │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │ Ruby Workers (각 항공사별)                                │ │
│  │                                                           │ │
│  │ airlineMessageHandler_v3_TW1 (PID: 3887)                 │ │
│  │ airlineMessageHandler_v3_1T1 (PID: 811617)               │ │
│  │ airlineMessageHandler_v3_9C  (PID: 813977)               │ │
│  └───────────────────────┬───────────────────────────────────┘ │
│                          │                ↑                    │
│                          │                │                    │
│                          ↓                │                    │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │ immigrationClient (PID: 7215)                             │ │
│  └───────────────────────┬───────────────────────────────────┘ │
└──────────────────────────┼─────────────────────────────────────┘
                           │                ↑ 
                           ↓                │
┌─────────────────────────────────────────────────────────────────┐
│           법무부 Immigration Server                              │
│           203.242.167.20:7599                                   │
└─────────────────────────────────────────────────────────────────┘
````

### 특징

- **간접 연결**: 외부 MQ Server 경유
- **HTH 헤더 없음**: Queue 이름으로 ServiceName 식별
- **가장 단순**: 복잡한 파싱 불필요
- **현재 주력**: 신규 항공사는 대부분 이 방식 채택


### netstat 확인
````bash
# xaAMR이 외부 MQ에 클라이언트로 연결
192.168.100.11:39899  144.243.232.7:1415   ESTABLISHED  (xaAMR:8005)
192.168.100.11:33843  144.243.228.19:1414  ESTABLISHED  (xaAMR:8005)
192.168.100.11:47591  144.243.228.19:1414  ESTABLISHED  (xaAMR:8005)
# ... (수십 개)
```

### 메시지 예시
```
UNB+UNOA:4+HITIT+KIS+251125:0023+367B4MY++PAXLST'
UNH+367B4MY+PAXLST:D:05B:UN:IATA'
BGM+745'
TDT+20+TW651+++TW'
LOC+125+ICN'
LOC+87+NRT'
NAD+FL+++HONG:GILDONG'
...
UNT+25+367B4MY'
UNZ+1+367B4MY'

// HTH 헤더 없음!
// Queue 이름 "MQ.TW1.FROM.AGN"으로 티웨이임을 알 수 있음
```

---

## 방식 3: MQ/HTH (일부, 20%)

### 아키텍처
```
(방식 2와 동일한 구조)
외부 MQ Server → xaAMR Channel → Local Queue → Extension → Redis
```

### 특징
- **구조는 MQ/NoHTH와 동일**
- **차이점**: HTH 헤더 포함
- **ServiceName 식별**: HTH 헤더 파싱 필요

### HTH 헤더 구조
```
V.\r
VHHG.WA/E11TIAPP/I1XAAPPKR/P003680\r
VGYA\r
UNB+UNOA:4+...

[HTH 헤더 파싱]
V.           → Version
VHHG         → Header Type
.WA          → Priority (WA = Normal)
/E11TIAPP    → Source Address (항공사 코드: 11T = 브루나이)
/I1XAAPPKR   → Destination Address (법무부 시스템)
/P003680     → Transaction ID (메시지 추적용)
VGYA         → End of Header
````


## 3가지 방식 비교표

| 항목                 | MATIP              | MQ/NoHTH                  | MQ/HTH                    |
| ------------------ | ------------------ | ------------------------- | ------------------------- |
| **연결 방식**          | 직접 TCP             | 외부 MQ 경유                  | 외부 MQ 경유                  |
| **프로토콜**           | MATIP Type-B       | IBM MQ                    | IBM MQ                    |
| **HTH 헤더**         | 없음                 | 없음                        | 있음                        |
| **ServiceName 식별** | Port 번호            | Queue 이름                  | HTH 파싱                    |
| **xaAMR 역할**       | 서버 (LISTEN)        | 클라이언트 (CONNECT)           | 클라이언트 (CONNECT)           |
| **Port**           | 2023, 2024, ...    | N/A (MQ 사용)               | N/A (MQ 사용)               |
| **Queue 형식**       | MATIP.WE1.FROM.AGN | MQ.TW1.FROM.AGN           | MQ.1T1.FROM.AGN           |
| **메시지 포맷**         | Binary → EDIFACT   | 순수 EDIFACT                | HTH + EDIFACT             |
| **사용 비율**          | 10% (레거시)          | 70% (주력)                  | 20% (일부)                  |
| **대표 항공사**         | 아시아나(과거), 델타       | 티웨이, 에어부산                 | 브루나이, 일부                  |
| **netstat 확인**     | LISTEN (2023)      | ESTABLISHED (144.243.x.x) | ESTABLISHED (144.243.x.x) |
| **현재 상태**          | 거의 사용 안 함          | 활발히 사용 중                  | 활발히 사용 중                  |